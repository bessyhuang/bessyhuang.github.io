<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello World</title>
    <url>/2024/01/27/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>Docker Storage</title>
    <url>/2025/07/15/Docker/Docker-Storage/</url>
    <content><![CDATA[<h1 id="Docker-Storage-Architectureï¼ˆå„²å­˜æ¶æ§‹ï¼‰"><a href="#Docker-Storage-Architectureï¼ˆå„²å­˜æ¶æ§‹ï¼‰" class="headerlink" title="Docker Storage Architectureï¼ˆå„²å­˜æ¶æ§‹ï¼‰"></a>Docker Storage Architectureï¼ˆå„²å­˜æ¶æ§‹ï¼‰</h1><h2 id="Layered-Architecture-åˆ†å±¤æ¶æ§‹"><a href="#Layered-Architecture-åˆ†å±¤æ¶æ§‹" class="headerlink" title="Layered Architecture (åˆ†å±¤æ¶æ§‹)"></a>Layered Architecture (åˆ†å±¤æ¶æ§‹)</h2><p>æ¯å€‹ Docker å®¹å™¨éƒ½æ˜¯ç”±å”¯è®€æ˜ åƒå±¤ï¼ˆimage layerï¼‰å’Œä¸€å€‹å¯å¯«å®¹å™¨å±¤ï¼ˆcontainer layerï¼‰çµ„æˆã€‚</p>
<ul>
<li>Image Layers<ul>
<li>Read Only</li>
</ul>
</li>
<li>Container Layers<ul>
<li>Read Write</li>
<li>Copy-on-Writeï¼ˆå¯«å…¥æ™‚è¤‡è£½ï¼‰<blockquote>
<p>ç•¶å®¹å™¨å°æª”æ¡ˆé€²è¡Œä¿®æ”¹æ™‚ï¼ŒDocker ä¸¦ä¸æœƒç›´æ¥ä¿®æ”¹æ˜ åƒå±¤(å”¯è®€å±¤)çš„æª”æ¡ˆï¼Œè€Œæ˜¯è¤‡è£½è©²æª”æ¡ˆåˆ°å®¹å™¨å±¤(å¯å¯«å±¤)å†ä¿®æ”¹ï¼Œé€™ç¨±ç‚º Copy-on-Writeã€‚<br>é€™æ¨£å¯ä¿æŒæ˜ åƒå±¤ä¸è®Šï¼Œä¿è­‰å®¹å™¨éš”é›¢æ€§èˆ‡ä¸€è‡´æ€§ã€‚</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="Storage-Drivers"><a href="#Storage-Drivers" class="headerlink" title="Storage Drivers"></a>Storage Drivers</h1><p>Docker ä½¿ç”¨ä¸åŒçš„å„²å­˜é©…å‹•ä¾†ç®¡ç†å®¹å™¨å±¤çš„æª”æ¡ˆç³»çµ±ã€‚</p>
<blockquote>
<p>Overlay2 æ˜¯ç›®å‰æœ€å»ºè­°ä½¿ç”¨çš„ä¸»æµé©…å‹•ï¼ˆé™¤éæœ‰ç‰¹åˆ¥éœ€æ±‚ï¼‰ã€‚</p>
</blockquote>
<p>ä¸åŒçš„ä½œæ¥­ç³»çµ±èˆ‡éœ€æ±‚æœƒå°æ‡‰ä¸åŒçš„é©…å‹•ï¼š</p>
<ul>
<li><strong>AUFS</strong>ï¼ˆUbuntu å¸¸è¦‹ï¼Œæ”¯æ´å¤šå±¤ï¼‰</li>
<li><strong>Overlay &#x2F; Overlay2</strong>ï¼ˆç¾ä»£ Linux ç™¼è¡Œç‰ˆçš„é è¨­ï¼‰</li>
<li><strong>ZFS</strong>ï¼ˆæ”¯æ´å£“ç¸®èˆ‡å¿«ç…§ï¼‰</li>
<li><strong>Btrfs</strong>ï¼ˆæ”¯æ´å­å·èˆ‡å¿«ç…§ï¼‰</li>
<li><strong>Device Mapper</strong>ï¼ˆæ—©æœŸ CentOS &#x2F; RHEL ä½¿ç”¨ï¼‰</li>
<li><strong>VFS</strong>ï¼ˆé–‹ç™¼&#x2F;é™¤éŒ¯ç”¨é€”ï¼Œä¸ä½¿ç”¨ Copy-on-Writeï¼‰</li>
</ul>
<p>Overlay2 å»ºè­°æ­é… xfs æˆ– ext4 æª”æ¡ˆç³»çµ±ï¼Œä¸¦æ”¯æ´ SELinuxã€‚<br>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ç¢ºèªç›®å‰ä½¿ç”¨çš„ Storage Driverï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker info | grep Storage</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Volume-Drivers"><a href="#Volume-Drivers" class="headerlink" title="Volume Drivers"></a>Volume Drivers</h1><p>Volume æ˜¯å®¹å™¨å¤–éƒ¨çš„æŒä¹…åŒ–å„²å­˜æ–¹å¼ï¼Œæ”¯æ´è¨±å¤šç¬¬ä¸‰æ–¹å„²å­˜è§£æ±ºæ–¹æ¡ˆï¼š</p>
<ul>
<li><strong>local</strong>ï¼ˆé è¨­ã€å„²å­˜åœ¨æœ¬åœ° <code>/var/lib/docker/volumes</code>ï¼‰</li>
<li><strong>Azure File Storage</strong></li>
<li><strong>DigitalOcean Block Storage</strong></li>
<li><strong>gce-docker</strong>ï¼ˆGoogle Cloudï¼‰</li>
<li><strong>GlusterFS</strong></li>
<li><strong>NetApp</strong></li>
<li><strong>Portworx</strong></li>
<li><strong>RexRay</strong>ï¼ˆæ”¯æ´ AWS EBSã€EMC ç­‰ï¼‰</li>
<li><strong>Convoy</strong></li>
<li><strong>Flocker</strong></li>
<li><strong>VMware vSphere Storage</strong></li>
</ul>
<h2 id="ä½¿ç”¨-Volume-Driver-ç¯„ä¾‹ï¼š"><a href="#ä½¿ç”¨-Volume-Driver-ç¯„ä¾‹ï¼š" class="headerlink" title="ä½¿ç”¨ Volume Driver ç¯„ä¾‹ï¼š"></a>ä½¿ç”¨ Volume Driver ç¯„ä¾‹ï¼š</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -it \</span><br><span class="line">  --name mysql \</span><br><span class="line">  --volume-driver rexray/ebs \</span><br><span class="line">  --mount src=ebs-vol,target=/var/lib/mysql \</span><br><span class="line">  mysql</span><br></pre></td></tr></table></figure>

<h2 id="Volume-Driver-å¯¦å‹™è£œå……"><a href="#Volume-Driver-å¯¦å‹™è£œå……" class="headerlink" title="Volume Driver å¯¦å‹™è£œå……"></a>Volume Driver å¯¦å‹™è£œå……</h2><p>å¦‚ä½•åˆ—å‡ºèˆ‡ç§»é™¤ volume</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line">docker volume inspect data_volume</span><br><span class="line">docker volume <span class="built_in">rm</span> data_volume</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Docker-Volumesï¼ˆè³‡æ–™å·ï¼‰"><a href="#Docker-Volumesï¼ˆè³‡æ–™å·ï¼‰" class="headerlink" title="Docker Volumesï¼ˆè³‡æ–™å·ï¼‰"></a>Docker Volumesï¼ˆè³‡æ–™å·ï¼‰</h1><h2 id="Volume-Mountingï¼ˆè³‡æ–™å·æ›è¼‰ï¼‰"><a href="#Volume-Mountingï¼ˆè³‡æ–™å·æ›è¼‰ï¼‰" class="headerlink" title="Volume Mountingï¼ˆè³‡æ–™å·æ›è¼‰ï¼‰"></a>Volume Mountingï¼ˆè³‡æ–™å·æ›è¼‰ï¼‰</h2><p>å„²å­˜æ–¼ <code>/var/lib/docker/volumes</code> å…§éƒ¨ç›®éŒ„ï¼Œç”± Docker ç®¡ç†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker volume create data_volume</span><br><span class="line">docker run -v data_volume:/var/lib/mysql mysql</span><br></pre></td></tr></table></figure>

<p>æˆ–ç”¨å¦ä¸€å€‹ volumeï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -v data_volume2:/var/lib/mysql mysql</span><br></pre></td></tr></table></figure>

<h2 id="Bind-Mountingï¼ˆç›®éŒ„ç¶å®šæ›è¼‰ï¼‰"><a href="#Bind-Mountingï¼ˆç›®éŒ„ç¶å®šæ›è¼‰ï¼‰" class="headerlink" title="Bind Mountingï¼ˆç›®éŒ„ç¶å®šæ›è¼‰ï¼‰"></a>Bind Mountingï¼ˆç›®éŒ„ç¶å®šæ›è¼‰ï¼‰</h2><p>ç¶å®šä¸»æ©Ÿæª”æ¡ˆç³»çµ±çš„ç‰¹å®šç›®éŒ„ (e.g. <code>/data</code>)ï¼Œé©åˆéœ€è¦ç›´æ¥å­˜å–ä¸»æ©Ÿæª”æ¡ˆçš„å ´æ™¯ã€‚</p>
<blockquote>
<p>âš ï¸ ä½¿ç”¨ Bind Mount æ™‚ï¼Œè¦ç‰¹åˆ¥å°å¿ƒä¸»æ©Ÿè·¯å¾‘çš„æ¬Šé™èˆ‡ SELinux&#x2F;AppArmor å®‰å…¨è¨­å®šï¼Œä»¥å…é€ æˆå®¹å™¨å­˜å–ä¸»æ©Ÿæ•æ„Ÿæª”æ¡ˆã€‚</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -v /data/mysql:/var/lib/mysql mysql</span><br></pre></td></tr></table></figure>

<p>æˆ–ä½¿ç”¨ <code>--mount</code>ï¼ˆè¼ƒæ–°ä¸”æ¨è–¦ï¼‰èªæ³•ï¼šğŸ‘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,<span class="built_in">source</span>=/data/mysql,target=/var/lib/mysql mysql</span><br></pre></td></tr></table></figure>

<h2 id="å·®ç•°æ¯”è¼ƒ"><a href="#å·®ç•°æ¯”è¼ƒ" class="headerlink" title="å·®ç•°æ¯”è¼ƒ"></a>å·®ç•°æ¯”è¼ƒ</h2><table>
<thead>
<tr>
<th>é …ç›®</th>
<th>Volume Mount</th>
<th>Bind Mount</th>
</tr>
</thead>
<tbody><tr>
<td>å®šç¾©æ–¹å¼</td>
<td>ç”± Docker ç®¡ç†</td>
<td>ç¶å®šä¸»æ©Ÿç›®éŒ„</td>
</tr>
<tr>
<td>å¯æ”œæ€§</td>
<td>é«˜</td>
<td>ä½</td>
</tr>
<tr>
<td>å®‰å…¨æ€§</td>
<td>é«˜ï¼ˆDocker æ§åˆ¶ï¼‰</td>
<td>è¼ƒä½ï¼ˆç›´æ¥æ“ä½œä¸»æ©Ÿï¼Œä¸»æ©Ÿç›®éŒ„ç›´æ¥å­˜å–ï¼‰</td>
</tr>
<tr>
<td>å‚™ä»½èˆ‡å¾©åŸ</td>
<td>å®¹æ˜“</td>
<td>éœ€è‡ªå®šç¾©è…³æœ¬&#x2F;å·¥å…·</td>
</tr>
<tr>
<td>SELinux ç›¸å®¹æ€§</td>
<td>æœ‰è‰¯å¥½æ”¯æ´</td>
<td>é ˆæ‰‹å‹•èª¿æ•´å°æ‡‰æ¨™ç±¤</td>
</tr>
</tbody></table>
<hr>
<h1 id="Container-Storage-Interface-CSI"><a href="#Container-Storage-Interface-CSI" class="headerlink" title="Container Storage Interface (CSI)"></a>Container Storage Interface (CSI)</h1><p>Container Storage Interface æ˜¯ K8s ç­‰å®¹å™¨ç·¨æ’ç³»çµ±èˆ‡å„²å­˜è§£æ±ºæ–¹æ¡ˆä¹‹é–“çš„æ¨™æº–æ¥å£å”å®šï¼Œè®“å„ç¨®å„²å­˜ä¾›æ‡‰å•†èƒ½ä»¥ä¸€è‡´æ–¹å¼æ•´åˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">      App (Pod)</span><br><span class="line">	  |</span><br><span class="line">	  v</span><br><span class="line">     [ Kubelet ]</span><br><span class="line">	  |</span><br><span class="line">	  v</span><br><span class="line">    [ CSI Plugin ]</span><br><span class="line">	  |</span><br><span class="line">	  v</span><br><span class="line">[ Storage Provider (e.g. AWS EBS, Ceph) ]</span><br></pre></td></tr></table></figure>

<h2 id="CSI-å°æ‡‰çš„å®¹å™¨æ¥å£"><a href="#CSI-å°æ‡‰çš„å®¹å™¨æ¥å£" class="headerlink" title="CSI å°æ‡‰çš„å®¹å™¨æ¥å£"></a>CSI å°æ‡‰çš„å®¹å™¨æ¥å£</h2><ul>
<li>CRI (Container Runtime Interface)ï¼šå®¹å™¨é‹è¡Œæ™‚ä»‹é¢ï¼Œå°æ¥ Dockerã€containerdã€CRI-O ç­‰ã€‚</li>
<li>CNI (Container Network Interface)ï¼šå®¹å™¨ç¶²è·¯ä»‹é¢ï¼Œå°æ¥ Flannelã€Ciliumã€Calico ç­‰ã€‚</li>
<li>CSI (Container Storage Interface)ï¼šå®¹å™¨å„²å­˜ä»‹é¢ï¼Œå°æ¥å„ç¨®å„²å­˜ä¾›æ‡‰å•†ã€‚<ul>
<li>å¸¸è¦‹æ”¯æ´ CSI çš„å„²å­˜æ–¹æ¡ˆï¼š<ul>
<li>AWS EBS</li>
<li>Azure Disk</li>
<li>Google Persistent Disk</li>
<li>Dell EMC</li>
<li>Portworx</li>
<li>GlusterFS</li>
<li>Ceph</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="CSI-åŠŸèƒ½è¦æ±‚"><a href="#CSI-åŠŸèƒ½è¦æ±‚" class="headerlink" title="CSI åŠŸèƒ½è¦æ±‚"></a>CSI åŠŸèƒ½è¦æ±‚</h2><table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>RPC åç¨±</th>
<th>èªªæ˜</th>
<th>åŸ·è¡Œç«¯</th>
</tr>
</thead>
<tbody><tr>
<td>å»ºç«‹ Volume</td>
<td><code>CreateVolume</code></td>
<td>å»ºç«‹æ–°çš„å„²å­˜è³‡æºï¼ˆPV å°æ‡‰ï¼‰</td>
<td>Controller</td>
</tr>
<tr>
<td>åˆªé™¤ Volume</td>
<td><code>DeleteVolume</code></td>
<td>åˆªé™¤å„²å­˜è³‡æº</td>
<td>Controller</td>
</tr>
<tr>
<td>é™„åŠ  Volume åˆ°ç¯€é»</td>
<td><code>ControllerPublishVolume</code></td>
<td>å°‡ volume attach è‡³ node</td>
<td>Controller</td>
</tr>
<tr>
<td>å¾ç¯€é»ç§»é™¤ Volume</td>
<td><code>ControllerUnpublishVolume</code></td>
<td>detach volume from node</td>
<td>Controller</td>
</tr>
<tr>
<td>æ›è¼‰ Volume çµ¦å®¹å™¨ä½¿ç”¨</td>
<td><code>NodePublishVolume</code></td>
<td>å°‡ volume æ›è¼‰åˆ°ç¯€é»ç›®éŒ„ä¾› Pod ä½¿ç”¨</td>
<td>Node</td>
</tr>
<tr>
<td>å¸è¼‰ Volume</td>
<td><code>NodeUnpublishVolume</code></td>
<td>å°‡ volume å¾ç¯€é»ç›®éŒ„å¸è¼‰</td>
<td>Node</td>
</tr>
</tbody></table>
<h2 id="CSI-åº•å±¤é‹ä½œå”å®š"><a href="#CSI-åº•å±¤é‹ä½œå”å®š" class="headerlink" title="CSI åº•å±¤é‹ä½œå”å®š"></a>CSI åº•å±¤é‹ä½œå”å®š</h2><ul>
<li>ä½¿ç”¨ gRPC èˆ‡å®¹å™¨å¹³å°é€šè¨Š<blockquote>
<p>CSI ä½¿ç”¨ gRPC ä½œç‚ºé€šè¨Šå”å®šï¼Œèƒ½æ”¯æ´å¤šèªè¨€ã€é›™å‘ä¸²æµèˆ‡é«˜æ•ˆèƒ½åºåˆ—åŒ–ï¼Œé©åˆè·¨å¹³å°çš„å®¹å™¨æ¶æ§‹ã€‚</p>
</blockquote>
</li>
<li>å®šç¾© RPC æ–¹æ³•ï¼šCreateVolumeã€DeleteVolumeã€ControllerPublishVolumeã€NodePublishVolume ç­‰</li>
</ul>
<h2 id="è£œå……-CLI-å·¥å…·èˆ‡-YAML-ä¾‹å­ï¼ˆé€²å…¥-Kubernetes-å¯¦ä½œï¼‰"><a href="#è£œå……-CLI-å·¥å…·èˆ‡-YAML-ä¾‹å­ï¼ˆé€²å…¥-Kubernetes-å¯¦ä½œï¼‰" class="headerlink" title="è£œå…… CLI å·¥å…·èˆ‡ YAML ä¾‹å­ï¼ˆé€²å…¥ Kubernetes å¯¦ä½œï¼‰"></a>è£œå…… CLI å·¥å…·èˆ‡ YAML ä¾‹å­ï¼ˆé€²å…¥ Kubernetes å¯¦ä½œï¼‰</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># PersistentVolumeClaim YAML ä¾‹å­ï¼ˆK8sï¼‰</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">gp2</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Gi</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># PersistentVolume (PV) YAML ä¾‹å­ï¼ˆK8sï¼‰</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/mysql</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="ç¸½çµ"><a href="#ç¸½çµ" class="headerlink" title="ç¸½çµ"></a>ç¸½çµ</h1><table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>æŠ€è¡“</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody><tr>
<td>å„²å­˜æ ¼å¼</td>
<td>Copy-on-Write</td>
<td>å®¹å™¨å±¤è®€å¯«åŸç†</td>
</tr>
<tr>
<td>å„²å­˜é©…å‹•</td>
<td>Overlay2 ç­‰</td>
<td>æ§åˆ¶å®¹å™¨æª”æ¡ˆç³»çµ±</td>
</tr>
<tr>
<td>è³‡æ–™å·</td>
<td>Volume &#x2F; Bind Mount</td>
<td>æŒä¹…åŒ–å„²å­˜</td>
</tr>
<tr>
<td>è·¨å¹³å°å„²å­˜</td>
<td>Volume Driver</td>
<td>æ•´åˆå¤–éƒ¨å„²å­˜è§£æ±ºæ–¹æ¡ˆ</td>
</tr>
<tr>
<td>æ¨™æº–å„²å­˜å”å®š</td>
<td>CSI</td>
<td>å®¹å™¨èˆ‡å„²å­˜ä¾›æ‡‰å•†ä¹‹é–“çš„æ¥å£</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Storage</tag>
      </tags>
  </entry>
  <entry>
    <title>å¾é›¶é–‹å§‹å­¸ Docker - ç‚ºä½•å®ƒé€™éº¼é‡è¦ï¼Ÿ(Part 1)</title>
    <url>/2024/01/30/Docker/%E5%BE%9E%E9%9B%B6%E9%96%8B%E5%A7%8B%E5%AD%B8-Docker-%E7%82%BA%E4%BD%95%E5%AE%83%E9%80%99%E9%BA%BC%E9%87%8D%E8%A6%81%EF%BC%9F-Part-1/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Docker çš„ä¸‰å¤§åŠŸç”¨ï¼š</span><br><span class="line">1. ç°¡åŒ–éƒ¨ç½²æµç¨‹</span><br><span class="line">2. è·¨å¹³å°éƒ¨ç½²</span><br><span class="line">3. å»ºç«‹ä¹¾æ·¨æ¸¬è©¦ç’°å¢ƒ</span><br></pre></td></tr></table></figure>

<h1 id="åŠŸç”¨ä¸€ï¼šç°¡åŒ–éƒ¨ç½²æµç¨‹"><a href="#åŠŸç”¨ä¸€ï¼šç°¡åŒ–éƒ¨ç½²æµç¨‹" class="headerlink" title="åŠŸç”¨ä¸€ï¼šç°¡åŒ–éƒ¨ç½²æµç¨‹"></a>åŠŸç”¨ä¸€ï¼šç°¡åŒ–éƒ¨ç½²æµç¨‹</h1><h2 id="è§€å¿µè§£èªª"><a href="#è§€å¿µè§£èªª" class="headerlink" title="è§€å¿µè§£èªª"></a>è§€å¿µè§£èªª</h2><p>å¦‚æœæ²’æœ‰ä½¿ç”¨ Dockerï¼Œç•¶ä½ éœ€è¦å°‡æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²åˆ°å¤šå°ä¼ºæœå™¨ä¸Šæ™‚ï¼Œå¿…é ˆé€ä¸€è¼¸å…¥æŒ‡ä»¤é€²è¡Œè¨­å®šã€‚é€™ä¸åƒ…åœ¨ç’°å¢ƒå®‰è£éšæ®µè€—è²»å¤§é‡æ™‚é–“ä¸”æ¯ç‡¥ä¹å‘³ï¼Œé‚„å®¹æ˜“å› äººç‚ºå¤±èª¤è€Œè¼¸å…¥éŒ¯èª¤æŒ‡ä»¤ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œè‹¥éœ€è¦åœ¨ä¸åŒç’°å¢ƒä¸­é€²è¡Œéƒ¨ç½²ï¼Œé‚„å¾—æ‡‰å°å„ç¨®ç’°å¢ƒè®Šæ•¸å’Œé…ç½®çš„è¤‡é›œæ€§ã€‚</p>
<p>Docker çš„æ¨å‡ºç‚ºæˆ‘å€‘æä¾›äº†ä¸€å¥—å¼·å¤§çš„å®¹å™¨åŒ–è§£æ±ºæ–¹æ¡ˆã€‚</p>
<p>é€éä½¿ç”¨ Dockerï¼Œæˆ‘å€‘èƒ½å¤ å°‡æ‡‰ç”¨ç¨‹å¼åŠå…¶ç›¸ä¾çš„ç’°å¢ƒã€å¥—ä»¶ç­‰æ‰“åŒ…æˆä¸€å€‹ç¨ç«‹ã€å¯æ”œå¸¶çš„å®¹å™¨ã€‚é€™æ¨£ä¸€ä¾†ï¼Œç„¡è«–åœ¨ä½•è™•éƒ½èƒ½ç¢ºä¿æ‡‰ç”¨ç¨‹å¼ä»¥ç›¸åŒçš„æ–¹å¼é‹è¡Œï¼Œé¿å…å—åˆ°ä¸åŒç’°å¢ƒçš„å½±éŸ¿ã€‚</p>
<p>é€™ç¨®å®¹å™¨åŒ–çš„æ–¹æ³•ä½¿å¾—æ‡‰ç”¨ç¨‹å¼çš„éƒ¨ç½²å’Œç®¡ç†è®Šå¾—æ›´åŠ éˆæ´»ã€ç°¡ä¾¿ï¼ŒåŒæ™‚æä¾›äº†æ›´é«˜åº¦çš„ä¸€è‡´æ€§å’Œå¯æ”œæ€§ã€‚</p>
<hr>
<h1 id="å¯¦ä½œç¤ºç¯„"><a href="#å¯¦ä½œç¤ºç¯„" class="headerlink" title="å¯¦ä½œç¤ºç¯„"></a>å¯¦ä½œç¤ºç¯„</h1><h2 id="å»ºç«‹ä¸€å€‹æ˜ åƒæª”ï¼ˆDocker-Imageï¼‰"><a href="#å»ºç«‹ä¸€å€‹æ˜ åƒæª”ï¼ˆDocker-Imageï¼‰" class="headerlink" title="å»ºç«‹ä¸€å€‹æ˜ åƒæª”ï¼ˆDocker Imageï¼‰"></a>å»ºç«‹ä¸€å€‹æ˜ åƒæª”ï¼ˆDocker Imageï¼‰</h2><p>Docker Image å°±åƒæ˜¯ä¸€å€‹ç¨ç«‹ã€å¯æ”œå¸¶çš„ç¨‹å¼éƒ¨ç½²åŒ…ï¼Œå…¶ä¸­åŒ…å«äº†æ‡‰ç”¨ç¨‹å¼ï¼ˆåœ¨é€™å€‹ç¯„ä¾‹ä¸­æ˜¯ Django ç¶²ç«™ï¼‰ä»¥åŠå®ƒæ‰€éœ€è¦çš„ç’°å¢ƒã€å¥—ä»¶ç­‰è³‡æºï¼Œéƒ½è¢«ä¸€ä½µæ‰“åŒ…åœ¨ä¸€èµ·ã€‚</p>
<h3 id="Start-a-Docker-Container"><a href="#Start-a-Docker-Container" class="headerlink" title="Start a Docker Container"></a>Start a Docker Container</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker pull python:3.12-alpine</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --name mysite -it -p 8000:8000 python:3.12-alpine /bin/sh</span></span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>

<h3 id="Install-packages-in-a-Docker-Container"><a href="#Install-packages-in-a-Docker-Container" class="headerlink" title="Install packages in a Docker Container"></a>Install packages in a Docker Container</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/ # apk update</span><br><span class="line">/ # apk add vim</span><br><span class="line">/ # pip install django</span><br></pre></td></tr></table></figure>

<h3 id="Create-a-Django-website-in-a-Docker-Container"><a href="#Create-a-Django-website-in-a-Docker-Container" class="headerlink" title="Create a Django website in a Docker Container"></a>Create a Django website in a Docker Container</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/     # cd /home/</span><br><span class="line">/home # django-admin startproject mysite</span><br><span class="line">/home # cd mysite/</span><br><span class="line">/home/mysite # django-admin startapp app1</span><br></pre></td></tr></table></figure>

<h3 id="Django-Settings"><a href="#Django-Settings" class="headerlink" title="Django Settings"></a>Django Settings</h3><ul>
<li><code>mysite/settings.py</code>  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">       <span class="comment">#...</span></span><br><span class="line">       <span class="string">&#x27;app1&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li><code>mysite/urls.py</code>  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#...</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path <span class="keyword">as</span> url</span><br><span class="line"><span class="keyword">from</span> app1.views <span class="keyword">import</span> hello_world</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">       <span class="comment">#...</span></span><br><span class="line">       url(<span class="string">r&#x27;^hello/$&#x27;</span>, hello_world),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li><code>app1/views.py</code>  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#...</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>(<span class="params">request</span>):</span><br><span class="line">       <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;Hello, World.&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Run-a-Django-website-in-a-Docker-Container"><a href="#Run-a-Django-website-in-a-Docker-Container" class="headerlink" title="Run a Django website in a Docker Container"></a>Run a Django website in a Docker Container</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/home/mysite # python manage.py runserver 0.0.0.0:8000</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Open your browser: <a href="http://localhost:8000/hello/">http://localhost:8000/hello/</a></p>
<img src="/2024/01/30/Docker/%E5%BE%9E%E9%9B%B6%E9%96%8B%E5%A7%8B%E5%AD%B8-Docker-%E7%82%BA%E4%BD%95%E5%AE%83%E9%80%99%E9%BA%BC%E9%87%8D%E8%A6%81%EF%BC%9F-Part-1/hello_world.jpg" class="" title="Hello, World.">
</blockquote>
<h3 id="Create-a-new-image-from-a-containerâ€™s-changes"><a href="#Create-a-new-image-from-a-containerâ€™s-changes" class="headerlink" title="Create a new image from a containerâ€™s changes"></a>Create a new image from a containerâ€™s changes</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker container <span class="built_in">ls</span> -a</span></span><br><span class="line">CONTAINER ID   IMAGE                COMMAND     CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">dbd03d68bf0d   python:3.12-alpine   &quot;/bin/sh&quot;   32 minutes ago   Exited (0) 10 seconds ago             mysite</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker commit dbd03d68bf0d  django_site:v1</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker images</span></span><br><span class="line">REPOSITORY    TAG           IMAGE ID       CREATED         SIZE</span><br><span class="line">django_site   v1            5499518614d6   2 seconds ago   136MB</span><br><span class="line">python        3.12-alpine   d2cfe5300063   5 weeks ago     56.4MB</span><br></pre></td></tr></table></figure>

<h2 id="éƒ¨ç½²ä¸€å€‹-Django-ç¶²ç«™"><a href="#éƒ¨ç½²ä¸€å€‹-Django-ç¶²ç«™" class="headerlink" title="éƒ¨ç½²ä¸€å€‹ Django ç¶²ç«™"></a>éƒ¨ç½²ä¸€å€‹ Django ç¶²ç«™</h2><h3 id="Use-a-Docker-Image-to-create-a-Docker-Container"><a href="#Use-a-Docker-Image-to-create-a-Docker-Container" class="headerlink" title="Use a Docker Image to create a Docker Container"></a>Use a Docker Image to create a Docker Container</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --name mysite_002 -it -p 8000:8000 django_site:v1 /bin/sh</span></span><br><span class="line">/ # cd home/mysite/</span><br><span class="line">/home/mysite # python manage.py runserver 0.0.0.0:8000</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å“‡ï¼åªè¦ä¸‰è¡ŒæŒ‡ä»¤ï¼Œå°±èƒ½æŠŠäº‹å…ˆæ‰“åŒ…å¥½çš„ Django ç¶²ç«™å»ºç«‹èµ·ä¾†äº†ï½<br>Open your browser: <a href="http://localhost:8000/hello/">http://localhost:8000/hello/</a><br>PS. å¾ŒçºŒé‚„æœ‰æ›´é€²éšçš„éƒ¨ç½²ä½œæ³•ï¼Œåƒæ˜¯ Dockerfileã€Docker Compose å–”ï¼</p>
</blockquote>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>è§€å¿µè§£èªª</tag>
      </tags>
  </entry>
  <entry>
    <title>å¾é›¶é–‹å§‹å­¸ Docker - ç‚ºä½•å®ƒé€™éº¼é‡è¦ï¼Ÿ(Part 2)</title>
    <url>/2024/02/04/Docker/%E5%BE%9E%E9%9B%B6%E9%96%8B%E5%A7%8B%E5%AD%B8-Docker-%E7%82%BA%E4%BD%95%E5%AE%83%E9%80%99%E9%BA%BC%E9%87%8D%E8%A6%81%EF%BC%9F-Part-2/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Docker çš„ä¸‰å¤§åŠŸç”¨ï¼š</span><br><span class="line">1. ç°¡åŒ–éƒ¨ç½²æµç¨‹</span><br><span class="line">2. è·¨å¹³å°éƒ¨ç½²</span><br><span class="line">3. å»ºç«‹ä¹¾æ·¨æ¸¬è©¦ç’°å¢ƒ</span><br></pre></td></tr></table></figure>

<h1 id="åŠŸç”¨äºŒï¼šè·¨å¹³å°éƒ¨ç½²"><a href="#åŠŸç”¨äºŒï¼šè·¨å¹³å°éƒ¨ç½²" class="headerlink" title="åŠŸç”¨äºŒï¼šè·¨å¹³å°éƒ¨ç½²"></a>åŠŸç”¨äºŒï¼šè·¨å¹³å°éƒ¨ç½²</h1><h2 id="è§€å¿µè§£èªª"><a href="#è§€å¿µè§£èªª" class="headerlink" title="è§€å¿µè§£èªª"></a>è§€å¿µè§£èªª</h2><p>Docker çš„å¼·å¤§åŠŸèƒ½ä¹‹ä¸€æ˜¯ã€Œè·¨å¹³å°éƒ¨ç½²ã€ï¼é€éæŠŠç¨‹å¼åŠå…¶ç›¸ä¾çš„ç’°å¢ƒã€å¥—ä»¶æ‰“åŒ…æˆ Docker Imageï¼ˆaka. ç¨‹å¼éƒ¨ç½²åŒ…ï¼‰ï¼Œä½ å¯ä»¥è¼•é¬†åœ°åœ¨ä¸åŒä½œæ¥­ç³»çµ±ä¸Šï¼ˆLinuxã€MacOS æˆ– Windowsï¼‰é‹è¡Œä½ çš„æ‡‰ç”¨ç¨‹å¼ã€‚</p>
<p>å®Œæˆ Docker Image çš„è£½ä½œå¾Œï¼ŒæˆåŠŸä¸Šå‚³è‡³ Docker Hubï¼ˆaka. å­˜æ”¾ Docker Image çš„é›²ç«¯ç©ºé–“ï¼‰ï¼Œä½¿å…¶ä»–ä½¿ç”¨è€…èƒ½å¤ åœ¨å…¨çƒçš„ä»»ä½•åœ°æ–¹ã€ä»»ä½•ä½œæ¥­ç³»çµ±ä¸Šè¼•é¬†é€²è¡Œä¸‹è¼‰ã€‚éš¨å¾Œï¼Œé€éåœ¨å„è‡ªä½œæ¥­ç³»çµ±ä¸Šå®‰è£ Docker Engineï¼Œå¯ä»¥å”èª¿ä½œæ¥­ç³»çµ±èˆ‡ Docker å®¹å™¨ä¹‹é–“çš„é‹è¡Œï¼Œè€Œç„¡éœ€æ“”å¿ƒç’°å¢ƒç›¸å®¹æ€§å•é¡Œã€‚</p>
<p>ç°¡è¨€ä¹‹ï¼ŒDocker è®“è·¨å¹³å°éƒ¨ç½²è®Šå¾—å¿«é€Ÿã€ä¾¿æ·ï¼Œç¢ºä¿äº†ä¸€è‡´çš„éƒ¨ç½²é«”é©—ã€‚</p>
<hr>
<h1 id="å¯¦ä½œç¤ºç¯„"><a href="#å¯¦ä½œç¤ºç¯„" class="headerlink" title="å¯¦ä½œç¤ºç¯„"></a>å¯¦ä½œç¤ºç¯„</h1><p>æœ¬ç« ç¯€ç¤ºç¯„å…§å®¹ï¼šéƒ¨ç½²ä¸€å€‹ Django Website æ–¼ä¸åŒä½œæ¥­ç³»çµ±ä¸Šã€‚<br>è—‰ç”±æ’°å¯« Dockerfile ä¾†å»ºç«‹ Docker Imageï¼Œä¸¦ä¸”å°‡è£½ä½œå¥½çš„ Docker Image ä¸Šå‚³è‡³ Docker Hubï¼Œä»¥ä¾¿é€²è¡Œè·¨å¹³å°éƒ¨ç½²ã€‚</p>
<h2 id="æº–å‚™-Django-Website"><a href="#æº–å‚™-Django-Website" class="headerlink" title="æº–å‚™ Django Website"></a>æº–å‚™ Django Website</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">django-admin startproject mysite</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> mysite</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">django-admin startapp app1</span></span><br></pre></td></tr></table></figure>

<p>ç¶²ç«™çš„éšå±¤æ¶æ§‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â””â”€â”€ mysite/</span><br><span class="line">    â”œâ”€â”€ app1/</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ admin.py</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ apps.py</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ models.py</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ tests.py</span><br><span class="line">    â”‚Â Â  â””â”€â”€ views.py</span><br><span class="line">    â”œâ”€â”€ manage.py</span><br><span class="line">    â””â”€â”€ mysite/</span><br><span class="line">        â”œâ”€â”€ __init__.py</span><br><span class="line">        â”œâ”€â”€ asgi.py</span><br><span class="line">        â”œâ”€â”€ settings.py</span><br><span class="line">        â”œâ”€â”€ urls.py</span><br><span class="line">        â””â”€â”€ wsgi.py</span><br></pre></td></tr></table></figure>

<h3 id="mysite-settings-py"><a href="#mysite-settings-py" class="headerlink" title="mysite&#x2F;settings.py"></a>mysite&#x2F;settings.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#...</span></span><br><span class="line"></span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">    <span class="string">&#x27;app1&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="mysite-urls-py"><a href="#mysite-urls-py" class="headerlink" title="mysite&#x2F;urls.py"></a>mysite&#x2F;urls.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#...</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> app1.views <span class="keyword">import</span> hello_world</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">    re_path(<span class="string">r&#x27;^hello/$&#x27;</span>, hello_world),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="app1-views-py"><a href="#app1-views-py" class="headerlink" title="app1&#x2F;views.py"></a>app1&#x2F;views.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#...</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;Hello, World!&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="æ’°å¯«-Dockerfile"><a href="#æ’°å¯«-Dockerfile" class="headerlink" title="æ’°å¯« Dockerfile"></a>æ’°å¯« Dockerfile</h2><p>Dockerfile æ˜¯ç”¨æ–¼å»ºç½® Docker Image çš„è…³æœ¬ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.10</span>-alpine</span><br><span class="line"><span class="keyword">ENV</span> myworkdir /home/django_site</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$&#123;myworkdir&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./mysite/ <span class="variable">$&#123;myworkdir&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add vim</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install django</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8000</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;manage.py&quot;</span>, <span class="string">&quot;runserver&quot;</span>, <span class="string">&quot;0.0.0.0:8000&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h2 id="å»ºç«‹-Docker-Image"><a href="#å»ºç«‹-Docker-Image" class="headerlink" title="å»ºç«‹ Docker Image"></a>å»ºç«‹ Docker Image</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â””â”€â”€ site/</span><br><span class="line">   â”œâ”€â”€ Dockerfile</span><br><span class="line">   â””â”€â”€ mysite/</span><br><span class="line">        â”œâ”€â”€ app1/</span><br><span class="line">        â”‚Â Â   â”œâ”€â”€ ...</span><br><span class="line">        â”œâ”€â”€ manage.py</span><br><span class="line">        â””â”€â”€ mysite/</span><br><span class="line">             â”œâ”€â”€ ...</span><br></pre></td></tr></table></figure>

<p>cd åˆ°æœ‰ <code>Dockerfile</code> çš„ç›®éŒ„ä¸‹ã€‚æ¥è‘—ï¼Œå»ºç«‹åç‚º <code>django_site</code> çš„ Docker Imageã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> site/</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker build -t bessyhuang/django_site . --no-cache</span></span><br></pre></td></tr></table></figure>

<h2 id="åŸ·è¡Œ"><a href="#åŸ·è¡Œ" class="headerlink" title="åŸ·è¡Œ"></a>åŸ·è¡Œ</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -d -p 8001:8000 django_site</span> </span><br></pre></td></tr></table></figure>
<p>æ‰“é–‹ç€è¦½å™¨ <a href="http://localhost:8001/hello/">http://localhost:8001/hello/</a></p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>è§€å¿µè§£èªª</tag>
      </tags>
  </entry>
  <entry>
    <title>å¾é›¶é–‹å§‹å­¸ Docker - ç‚ºä½•å®ƒé€™éº¼é‡è¦ï¼Ÿ(Part 3)</title>
    <url>/2024/04/02/Docker/%E5%BE%9E%E9%9B%B6%E9%96%8B%E5%A7%8B%E5%AD%B8-Docker-%E7%82%BA%E4%BD%95%E5%AE%83%E9%80%99%E9%BA%BC%E9%87%8D%E8%A6%81%EF%BC%9F-Part-3/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Docker çš„ä¸‰å¤§åŠŸç”¨ï¼š</span><br><span class="line">1. ç°¡åŒ–éƒ¨ç½²æµç¨‹</span><br><span class="line">2. è·¨å¹³å°éƒ¨ç½²</span><br><span class="line">3. å»ºç«‹ä¹¾æ·¨æ¸¬è©¦ç’°å¢ƒ</span><br></pre></td></tr></table></figure>

<h1 id="åŠŸç”¨ä¸‰ï¼šå»ºç«‹ä¹¾æ·¨æ¸¬è©¦ç’°å¢ƒ"><a href="#åŠŸç”¨ä¸‰ï¼šå»ºç«‹ä¹¾æ·¨æ¸¬è©¦ç’°å¢ƒ" class="headerlink" title="åŠŸç”¨ä¸‰ï¼šå»ºç«‹ä¹¾æ·¨æ¸¬è©¦ç’°å¢ƒ"></a>åŠŸç”¨ä¸‰ï¼šå»ºç«‹ä¹¾æ·¨æ¸¬è©¦ç’°å¢ƒ</h1><h2 id="è§€å¿µè§£èªª"><a href="#è§€å¿µè§£èªª" class="headerlink" title="è§€å¿µè§£èªª"></a>è§€å¿µè§£èªª</h2><hr>
<h1 id="å¯¦ä½œç¤ºç¯„"><a href="#å¯¦ä½œç¤ºç¯„" class="headerlink" title="å¯¦ä½œç¤ºç¯„"></a>å¯¦ä½œç¤ºç¯„</h1><p>æœ¬ç« ç¯€ç¤ºç¯„å…§å®¹ï¼šå»ºç«‹ä¹¾æ·¨çš„æ¸¬è©¦ç’°å¢ƒã€‚<br>åˆ©ç”¨ Dockerfile å»ºç«‹ä¸€ä»½å®¢è£½æ˜ åƒæª”ï¼ˆDocker Imageï¼‰ï¼Œä¸¦æŠŠæ¸¬è©¦ç’°å¢ƒè·‘èµ·ä¾†ã€‚</p>
<h2 id="æº–å‚™-MongoDB-Container"><a href="#æº–å‚™-MongoDB-Container" class="headerlink" title="æº–å‚™ MongoDB Container"></a>æº–å‚™ MongoDB Container</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker network create test_network</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -d --name mongodb --network test_network bessyhuang/py3.10_mongo:v1</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -it mongodb bash</span></span><br></pre></td></tr></table></figure>

<h2 id="æº–å‚™-Django-Platform-Container"><a href="#æº–å‚™-Django-Platform-Container" class="headerlink" title="æº–å‚™ Django Platform Container"></a>æº–å‚™ Django Platform Container</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -it -p 8001:8000 -v /Users/bessyhuang/Downloads/TEST_mysite/esiot-platform:/home/ --network test_network --name podman_platform python:3.11.8-slim bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt update</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt install gcc python3-dev -y</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pip install -r py3.11.8_requirements.txt</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">python manage.py runserver 0.0.0.0:8000</span></span><br></pre></td></tr></table></figure>



<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.11</span>.<span class="number">8</span>-slim</span><br><span class="line"><span class="keyword">MAINTAINER</span> Bessy</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./mysite ./home/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/mysite</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install iproute2 -y &amp;&amp; apt-get install vim -y</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8000</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;manage.py&quot;</span>, <span class="string">&quot;runserver&quot;</span>]</span></span><br></pre></td></tr></table></figure>


<p>Example</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FROM alpine:latest</span><br><span class="line">ENV myworkdir /var/www/localhost/htdocs/</span><br><span class="line">ARG whoami=Bessy</span><br><span class="line">WORKDIR $&#123;myworkdir&#125;</span><br><span class="line">RUN apk --update add apache2</span><br><span class="line">RUN rm -rf /var/cache/apk/*</span><br><span class="line">RUN echo &quot;&lt;h3&gt;I am $&#123;whoami&#125;. I am taking this great Docker Course. Round 01&lt;/h3&gt;&quot; &gt;&gt; index.html</span><br><span class="line">RUN echo &quot;&lt;h3&gt;I am $&#123;whoami&#125;. I am taking this great Docker Course. Round 02&lt;/h3&gt;&quot; &gt;&gt; index.html</span><br><span class="line">RUN echo &quot;&lt;h3&gt;I am $&#123;whoami&#125;. I am taking this great Docker Course. Round 03&lt;/h3&gt;&quot; &gt;&gt; index.html</span><br><span class="line">COPY ./content.txt ./</span><br><span class="line">RUN ls -l ./</span><br><span class="line">RUN cat ./content.txt &gt;&gt; index.html</span><br><span class="line">ENTRYPOINT [&quot;httpd&quot;, &quot;-D&quot;, &quot;FOREGROUND&quot;]</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>è§€å¿µè§£èªª</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo | Getting Started</title>
    <url>/2024/03/18/Hexo-Getting-Started/</url>
    <content><![CDATA[<h1 id="å»ºç«‹ä¸€å€‹æ–°çš„-Hexo-ç¶²ç«™"><a href="#å»ºç«‹ä¸€å€‹æ–°çš„-Hexo-ç¶²ç«™" class="headerlink" title="å»ºç«‹ä¸€å€‹æ–°çš„ Hexo ç¶²ç«™"></a>å»ºç«‹ä¸€å€‹æ–°çš„ Hexo ç¶²ç«™</h1><h2 id="å®‰è£å¥—ä»¶"><a href="#å®‰è£å¥—ä»¶" class="headerlink" title="å®‰è£å¥—ä»¶"></a>å®‰è£å¥—ä»¶</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm install hexo-cli -g</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm install -g npm@10.5.0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœè¦æŠŠ Hexo deploy åˆ° Github ä¸Šé¢ï¼Œéœ€è¦å…ˆå®‰è£ <code>hexo-deployer-git</code>ã€‚<ul>
<li>ç›¸é—œè¨­å®šï¼Œè«‹åƒè€ƒ <a href="https://ithelp.ithome.com.tw/articles/10257569">å»ºç«‹è‡ªå·±Blogç³»åˆ—(ä¸‰) Hexo next theme ä»‹ç´¹</a>ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm install hexo-deployer-git --save</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">nano _config.yml</span></span><br></pre></td></tr></table></figure>

<h2 id="ç¶²ç«™åˆå§‹åŒ–"><a href="#ç¶²ç«™åˆå§‹åŒ–" class="headerlink" title="ç¶²ç«™åˆå§‹åŒ–"></a>ç¶²ç«™åˆå§‹åŒ–</h2><p>å¦‚æœæ²’æœ‰è¨­å®š folder çš„è©±ï¼ŒHexo æœƒåœ¨ç›®å‰çš„è³‡æ–™å¤¾å»ºç«‹ç¶²ç«™ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo init myblog</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> myblog/</span></span><br></pre></td></tr></table></figure>

<h2 id="æ–°å¢ä¸€ç¯‡-Post"><a href="#æ–°å¢ä¸€ç¯‡-Post" class="headerlink" title="æ–°å¢ä¸€ç¯‡ Post"></a>æ–°å¢ä¸€ç¯‡ Post</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo new <span class="string">&quot;Hexo | Getting Started&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim <span class="built_in">source</span>/_posts/Hexo-Getting-Started.md</span></span><br></pre></td></tr></table></figure>

<h2 id="å•Ÿå‹•ä¼ºæœå™¨"><a href="#å•Ÿå‹•ä¼ºæœå™¨" class="headerlink" title="å•Ÿå‹•ä¼ºæœå™¨"></a>å•Ÿå‹•ä¼ºæœå™¨</h2><p>é è¨­æ˜¯ <a href="http://localhost:4000/">http://localhost:4000/</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo server</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo s</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="éƒ¨ç½²ä¸‰éƒ¨æ›²"><a href="#éƒ¨ç½²ä¸‰éƒ¨æ›²" class="headerlink" title="éƒ¨ç½²ä¸‰éƒ¨æ›²"></a>éƒ¨ç½²ä¸‰éƒ¨æ›²</h1><ol>
<li><p>æ¸…é™¤å¿«å–æª”æ¡ˆ (db.json) å’Œå·²ç”¢ç”Ÿçš„éœæ…‹æª”æ¡ˆ (public)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo clean</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo cl</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç”¢ç”Ÿéœæ…‹æª”æ¡ˆ (éƒ¨ç½²ç¶²ç«™å‰å…ˆç”¢ç”Ÿéœæ…‹æª”æ¡ˆ)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo generate</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo g</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>éƒ¨ç½²ç¶²ç«™</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo deploy</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo d</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Clone-Run-your-Repository"><a href="#Clone-Run-your-Repository" class="headerlink" title="Clone &amp; Run your Repository"></a>Clone &amp; Run your Repository</h1><h2 id="Repository-è·‘èµ·ä¾†"><a href="#Repository-è·‘èµ·ä¾†" class="headerlink" title="Repository è·‘èµ·ä¾†"></a>Repository è·‘èµ·ä¾†</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/bessyhuang/bessyhuang.github.io.git</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> bessyhuang.github.io/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout backup</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm install</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hexo server</span></span><br></pre></td></tr></table></figure>

<h2 id="å‚™ä»½æ–¼-GitHub-Repository-çš„-backup-åˆ†æ”¯"><a href="#å‚™ä»½æ–¼-GitHub-Repository-çš„-backup-åˆ†æ”¯" class="headerlink" title="å‚™ä»½æ–¼ GitHub Repository çš„ backup åˆ†æ”¯"></a>å‚™ä»½æ–¼ GitHub Repository çš„ <code>backup åˆ†æ”¯</code></h2><ul>
<li>git checkout<ul>
<li>åˆ‡æ›åˆ†æ”¯ã€‚Switch branches or restore working tree files</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout backup</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add --all</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">&quot;New function or something modified&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push --set-upstream origin backup</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://hexo.io/zh-tw/docs/commands.html">Hexo æŒ‡ä»¤</a></li>
<li><a href="https://ithelp.ithome.com.tw/articles/10257569">å»ºç«‹è‡ªå·±Blogç³»åˆ—(ä¸‰) Hexo next theme ä»‹ç´¹</a></li>
<li><a href="https://ithelp.ithome.com.tw/articles/10308093">CI&#x2F;CD X Jenkinsã€CircleCIã€Github Action (28)</a></li>
<li><a href="https://blog.marsen.me/2022/09/26/2022/Hexo_CICD/">[å¯¦ä½œç­†è¨˜] Hexo CI&#x2F;CD è¨­ç½®</a></li>
<li><a href="https://anemology.cc/post/hexo-backup/">Hexo å‚™ä»½è‡³ GitHub</a></li>
<li><a href="https://afun.tw/blog/20201114-hexo-init-github-page/">Hexo - åŸºæœ¬è¨­å®šèˆ‡ GitHub Page ç™¼ä½ˆæµç¨‹</a></li>
<li><a href="https://op30132.github.io/2019/12/24/hexo-tag-page/">hexo æ–°å¢ tagã€catagoriesã€aboutç­‰é é¢</a></li>
</ul>
]]></content>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Django</title>
    <url>/2023/08/16/TempNotes/Django/</url>
    <content><![CDATA[<blockquote>
<p><em>â€œDjango makes it easier to build better web apps more quickly and with less code.â€ â€” Django Official Website</em></p>
</blockquote>
<h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>Django is a high-level Python web framework that encourages rapid development and clean, pragmatic design. Itâ€™s free and open source.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1>]]></content>
      <tags>
        <tag>Django</tag>
      </tags>
  </entry>
  <entry>
    <title>Data Visualization - Advanced</title>
    <url>/2023/08/12/TempNotes/Data-Visualization-Advanced/</url>
    <content><![CDATA[<h1 id="Common-Data-Visualization-Mistakes"><a href="#Common-Data-Visualization-Mistakes" class="headerlink" title="Common Data Visualization Mistakes"></a>Common Data Visualization Mistakes</h1><h2 id="1-Misleading-color-contrast"><a href="#1-Misleading-color-contrast" class="headerlink" title="1. Misleading color contrast"></a>1. Misleading color contrast</h2><p>Although using various colors aids in interpreting data visualizations, too much color can confuse the user.<br>Itâ€™s crucial to stick to a limited number of unique colors.<br><img src="https://miro.medium.com/v2/resize:fit:1400/0*jl2BBj1gHt3qoTXU" alt="Bad Example: Misleading color contrast"></p>
<ul>
<li>Solution<ul>
<li>The simplest way to determine contrast value is to compare contrast colors on greyscale to check if the color you choose displays the difference.<br><img src="https://miro.medium.com/v2/resize:fit:1400/0*M_5cpWpvfNJzVsqQ"></li>
</ul>
</li>
</ul>
<h2 id="2-Overwhelming-charts-with-too-much-data"><a href="#2-Overwhelming-charts-with-too-much-data" class="headerlink" title="2. Overwhelming charts with too much data"></a>2. Overwhelming charts with too much data</h2><p><img src="https://miro.medium.com/v2/resize:fit:1400/0*wzDTQBW8wYIev4GC" alt="Bad Example: Overwhelming charts with too much data"></p>
<ul>
<li>Solution<ul>
<li>Do not put all of your insights into a chart. Multiple visualizations can help you communicate data more effectively.</li>
<li>It is recommended that no more than 5â€“6 colors be used in a single visualization.</li>
</ul>
</li>
</ul>
<h2 id="3-Omitting-baseline-and-truncating-scale"><a href="#3-Omitting-baseline-and-truncating-scale" class="headerlink" title="3. Omitting baseline and truncating scale"></a>3. Omitting baseline and truncating scale</h2><img src="/2023/08/12/TempNotes/Data-Visualization-Advanced/Omitting_baseline_and_truncating_scale.jpg" class="" title="Bad Example: Omitting baseline and truncating scale">

<ul>
<li>Solution<ul>
<li>Concentrate on creating data visualizations with a zero-baseline y-axis.</li>
<li>If removing the zero makes sense, add a zero-break to communicate that.<img src="/2023/08/12/TempNotes/Data-Visualization-Advanced/solution_Omitting_baseline_and_truncating_scale.jpg" class=""></li>
</ul>
</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a href="https://flourish.studio/blog/common-mistakes-in-data-visualization/">Four data visualization mistakes youâ€™re probably making and how to fix them</a></li>
<li><a href="https://www.toptal.com/designers/ux/data-visualization-mistakes">Numbers Shouldnâ€™t Lie: An Overview of Common Data Visualization Mistakes</a></li>
<li><a href="https://chartio.com/learn/charts/how-to-choose-data-visualization/">How to Choose the Right Data Visualization</a></li>
<li><a href="https://careerfoundry.com/en/tutorials/data-analytics-for-beginners/introduction-to-data-visualization/">Tutorial 4: An Introduction to Data Visualization</a></li>
</ol>
]]></content>
      <tags>
        <tag>Data Visualization</tag>
        <tag>Common Mistakes</tag>
      </tags>
  </entry>
  <entry>
    <title>Data Visualization - Basics</title>
    <url>/2023/08/03/TempNotes/Data-Visualization-Basics/</url>
    <content><![CDATA[<h1 id="What-is-data-visualization"><a href="#What-is-data-visualization" class="headerlink" title="What is data visualization?"></a>What is data visualization?</h1><h2 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h2><p>Data visualization (è³‡æ–™è¦–è¦ºåŒ–) is the graphical or visual representation of data.<br>It helps to highlight the most useful insights from a dataset, making it easier to spot trends, patterns, outliers, and correlations.</p>
<hr>
<h1 id="Two-main-types-of-data-visualization"><a href="#Two-main-types-of-data-visualization" class="headerlink" title="Two main types of data visualization"></a>Two main types of data visualization</h1><h2 id="1-Exploration"><a href="#1-Exploration" class="headerlink" title="1. Exploration"></a>1. Exploration</h2><p><em><font color=royalblue>Exploration takes place while youâ€™re still analyzing the data.</font></em></p>
<ul>
<li>When faced with a new dataset, one of the first things youâ€™ll do!</li>
<li>It helps you figure out whatâ€™s in your data.<ul>
<li>Get a sense of whatâ€™s in your dataset and to spot any noteworthy trends or anomalies. </li>
<li>Finding clues as to what the data might be trying to tell you.</li>
</ul>
</li>
</ul>
<h2 id="2-Explanation"><a href="#2-Explanation" class="headerlink" title="2. Explanation"></a>2. Explanation</h2><p><em><font color=royalblue>Explanatory visualization helps you to communicate what youâ€™ve found.</font></em></p>
<ul>
<li>Once youâ€™ve conducted your analysis and have figured out what the data is telling you, youâ€™ll want to share these insights with others.</li>
<li>Help you tell the story, and itâ€™s up to you to determine which visualizations will help you to do so most effectively.</li>
</ul>
<hr>
<h1 id="Five-types-of-data-visualization"><a href="#Five-types-of-data-visualization" class="headerlink" title="Five types of data visualization"></a>Five types of data visualization</h1><h2 id="1-Temporal-data-visualizations"><a href="#1-Temporal-data-visualizations" class="headerlink" title="1. Temporal data visualizations"></a>1. Temporal data visualizations</h2><ul>
<li>Linear and one-dimensional</li>
<li>e.g. scatterplots, timelines, line graphs</li>
</ul>
<img src="/2023/08/03/TempNotes/Data-Visualization-Basics/Temporal_data_viz.jpg" class="" title="Temporal data visualizations">

<h2 id="2-Hierarchical-visualizations"><a href="#2-Hierarchical-visualizations" class="headerlink" title="2. Hierarchical visualizations"></a>2. Hierarchical visualizations</h2><ul>
<li>Organize groups within larger groups</li>
<li>Often used to display clusters of information</li>
<li>e.g. tree diagrams, ring charts, sunburst diagrams</li>
</ul>
<img src="/2023/08/03/TempNotes/Data-Visualization-Basics/Hierarchical_viz.jpg" class="" title="Hierarchical visualizations">

<h2 id="3-Network-visualizations"><a href="#3-Network-visualizations" class="headerlink" title="3. Network visualizations"></a>3. Network visualizations</h2><ul>
<li>Show the relationships and connections between multiple datasets</li>
<li>e.g. matrix charts, word clouds, node-link diagrams</li>
</ul>
<img src="/2023/08/03/TempNotes/Data-Visualization-Basics/Network_viz.jpg" class="" title="Network visualizations">

<h2 id="4-Multidimensional-or-3D-visualizations"><a href="#4-Multidimensional-or-3D-visualizations" class="headerlink" title="4. Multidimensional or 3D visualizations"></a>4. Multidimensional or <a href="https://plotly.com/python/3d-charts/">3D visualizations</a></h2><ul>
<li>Depict two or more variables</li>
<li>e.g. pie charts, Venn diagrams, stacked bar graphs, histograms</li>
</ul>
<img src="/2023/08/03/TempNotes/Data-Visualization-Basics/Multidimensional_viz.jpg" class="" title="Multidimensional visualizations">

<h2 id="5-Geospatial-visualizations"><a href="#5-Geospatial-visualizations" class="headerlink" title="5. Geospatial visualizations"></a>5. Geospatial visualizations</h2><ul>
<li>Convey various data points in relation to physical, real-world locations</li>
<li>e.g. heat maps, cartograms, density maps</li>
</ul>
<img src="/2023/08/03/TempNotes/Data-Visualization-Basics/Geospatial_viz.jpg" class="" title="Geospatial visualizations">

<hr>
<h1 id="Popular-Python-Libraries-For-Data-Visualization"><a href="#Popular-Python-Libraries-For-Data-Visualization" class="headerlink" title="Popular Python Libraries For Data Visualization"></a>Popular Python Libraries For Data Visualization</h1><h2 id="Matplotlib"><a href="#Matplotlib" class="headerlink" title="Matplotlib"></a><a href="https://matplotlib.org/">Matplotlib</a></h2><p>Matplotlib is an easy-to-use Python library for data visualization which is built on top of NumPy arrays.<br>It is a low-level module and provides a lot of flexibility but at the cost of writing more code. </p>
<h2 id="Seaborn"><a href="#Seaborn" class="headerlink" title="Seaborn"></a><a href="https://seaborn.pydata.org/">Seaborn</a></h2><p>Seaborn is a high-level library built on the top of Matplotlib which means that it can also use Matplotlib functions and classes.<br>This library provides default styles and color palettes to make a plot more attractive.</p>
<h2 id="Plotly"><a href="#Plotly" class="headerlink" title="Plotly"></a><a href="https://plotly.com/python/">Plotly</a></h2><p>Plotly has hover tool capabilities that allow us to detect any outliers or anomalies in a large number of data points.<br>It is visually attractive that can be accepted by a wide range of audiences.<br>It allows us for the endless customization of our graphs that makes our plot more meaningful and understandable for others.</p>
<h2 id="Other-Popular-Python-Libraries"><a href="#Other-Popular-Python-Libraries" class="headerlink" title="Other Popular Python Libraries"></a>Other Popular Python Libraries</h2><ul>
<li>Altair</li>
<li>Bokeh</li>
<li>Folium</li>
<li>Diagrams</li>
<li>Wordcloud</li>
<li>â€¦</li>
</ul>
<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://careerfoundry.com/en/blog/data-analytics/what-is-data-visualization/">What Is Data Visualization and Why Is It Important? A Complete Introduction</a></li>
<li><a href="https://www.geeksforgeeks.org/python-data-visualization-tutorial/">Python â€“ Data visualization tutorial</a></li>
</ul>
]]></content>
      <tags>
        <tag>Data Visualization</tag>
        <tag>Introduction</tag>
      </tags>
  </entry>
  <entry>
    <title>MQTT vs. Redis vs. Kafka</title>
    <url>/2024/03/18/TempNotes/MQTT-vs-Redis-vs-Kafka/</url>
    <content><![CDATA[<h1 id="MQTT"><a href="#MQTT" class="headerlink" title="MQTT"></a>MQTT</h1><blockquote>
<p>Message Queueing Telemetry Transport</p>
</blockquote>
<p>It is a lightweight communication protocol for IoT devices and networks. MQTT is well-suited for use in low-bandwidth, high-latency networks, and is often used for real-time data transfer in applications such as home automation and energy management.</p>
<p>MQTT (Message Queuing Telemetry Transport) is a publish&#x2F;subscribe messaging protocol designed for resource-constrained devices and low-bandwidth networks. It provides a lightweight and efficient messaging infrastructure for microservices, making it ideal for IoT and mobile applications.</p>
<ul>
<li>ç‰©è¯ç¶²(IoT) é€šè¨Šå”è­°ï¼Œå°ˆç‚ºè³‡æºå—é™çš„è¨­å‚™è¨­è¨ˆï¼Œæä¾›äº†å¯é çš„ã€æœ‰åºçš„ã€ä½å»¶é²çš„è¨Šæ¯å‚³è¼¸</li>
<li>é©ç”¨æ–¼ç‰©è¯ç¶²è¨­å‚™é–“çš„è¨Šæ¯é€šè¨Š</li>
</ul>
<h2 id="Advantages"><a href="#Advantages" class="headerlink" title="Advantages"></a>Advantages</h2><ol>
<li>Lightweight and efficient</li>
<li>Ideal for IoT and mobile applications</li>
<li>Publish&#x2F;subscribe model for easy scalability</li>
<li>Widely supported and well-documented API</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Quality of Service (QoS)</span><br><span class="line">Retained Messages</span><br><span class="line">Last Will and Testament (LWT)</span><br><span class="line"></span><br><span class="line">Scalability and Reliability</span><br></pre></td></tr></table></figure>

<h2 id="Disadvantages"><a href="#Disadvantages" class="headerlink" title="Disadvantages"></a>Disadvantages</h2><ol>
<li>Limited security options compared to other protocols</li>
<li>May not be suitable for high-volume or complex data transfers</li>
</ol>
<h2 id="Best-Use-Case"><a href="#Best-Use-Case" class="headerlink" title="Best Use Case"></a>Best Use Case</h2><p>MQTT is best for low-volume, resource-constrained, and scalable communication between microservices, especially in IoT and mobile applications.<br>Itâ€™s well-suited for environments with limited bandwidth or unreliable networks, and devices with low computational resources.</p>
<p>Choose: You need to ensure message delivery over unreliable or bandwidth-constrained networks. You are dealing with a large number of distributed devices or sensors.</p>
<hr>
<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><blockquote>
<p>Remote Dictionary Server</p>
</blockquote>
<p>It is an in-memory data structure store that can be used as a database, cache, and message broker. Redis can be used for real-time communication between services, where messages are stored and retrieved using Redis pub&#x2F;sub.</p>
<p>Redis is an open-source, in-memory data structure store that can be used as a database, cache, and message broker. It provides fast and flexible access to data, making it well-suited for use as a cache and message broker in microservices.</p>
<ul>
<li>é©ç”¨æ–¼éœ€è¦é«˜æ•ˆèƒ½ã€åœ¨çŸ­æ™‚é–“å…§è™•ç†å¤§é‡è¨Šæ¯çš„å ´æ™¯</li>
</ul>
<h2 id="Advantages-1"><a href="#Advantages-1" class="headerlink" title="Advantages"></a>Advantages</h2><ol>
<li>Fast in-memory access to data</li>
<li>Flexible data storage options</li>
<li>Publish&#x2F;subscribe model for easy scalability</li>
<li>Widely supported and well-documented API</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">high performance and low latency (Performance: Excellent for high-performance computing scenarios where rapid access to data is required.)</span><br><span class="line"></span><br><span class="line">Pub/Sub System</span><br><span class="line">Data Persistence</span><br><span class="line">Advanced Data Structures</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Disadvantages-1"><a href="#Disadvantages-1" class="headerlink" title="Disadvantages"></a>Disadvantages</h2><ol>
<li>Limited durability compared to other protocols</li>
<li>May not be suitable for high-volume or complex data transfers</li>
<li>May require additional setup and configuration</li>
</ol>
<h2 id="Best-Use-Case-1"><a href="#Best-Use-Case-1" class="headerlink" title="Best Use Case"></a>Best Use Case</h2><p>Redis is best for fast, flexible, and scalable communication between microservices, especially as a cache or message broker.<br>It is also used for message brokering but in more data-centric applications like web applications, gaming, and real-time analytics.</p>
<p>Choose: You are developing applications that need rapid access to data with minimal latency. Your use case involves real-time analytics, gaming, or session management in web applications.</p>
<hr>
<h1 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h1><hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://blog.nonstopio.com/comparison-of-tcp-rmq-mqtt-redis-and-grpc-transport-layers-in-nest-js-microservices-2c10a2a98a6f">Comparison of TCP, (RMQ), MQTT, Redis, and gRPC transport layers in Nest.js microservices</a></li>
</ul>
]]></content>
      <categories>
        <category>Pub/Sub Messaging</category>
      </categories>
      <tags>
        <tag>MQTT</tag>
        <tag>Redis</tag>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>Amazon S3</title>
    <url>/2023/10/02/TempNotes/Amazon-S3/</url>
    <content><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><em><font color=royalblue>Infinitely Scaling Storage</font></em></p>
<h1 id="Amazon-S3-Components"><a href="#Amazon-S3-Components" class="headerlink" title="Amazon S3 - Components"></a>Amazon S3 - Components</h1><p>Amazon S3 allows people to store objects (files) in buckets (directories).</p>
<h2 id="Buckets"><a href="#Buckets" class="headerlink" title="Buckets"></a>Buckets</h2><p><em><font color=red>S3 looks like a global service but buckets are created in a region</font></em></p>
<ul>
<li>Buckets must have a globally unique name (across all regions all accounts)</li>
<li>Buckets are defined at the region level</li>
<li>Name Convention<ul>
<li>No uppercase, No underscore</li>
<li>3-63 characters long</li>
<li>Not an IP</li>
<li>Must start with lowercase letter or number</li>
<li>Must NOT start with the prefix <code>xn--</code></li>
<li>Must NOT end with the suffix <code>-s3alias</code></li>
</ul>
</li>
</ul>
<h2 id="Objects"><a href="#Objects" class="headerlink" title="Objects"></a>Objects</h2><p><em><font color=red>Objects (files) have a Key. Key with very long names that contain slashes (â€œ&#x2F;â€œ).</font></em><br><em><font color=red>There is no concept of â€œdirectoriesâ€ within buckets</font></em></p>
<ul>
<li>The key is the FULL path:<ul>
<li>s3:&#x2F;&#x2F;my-bucket&#x2F;my_folder&#x2F;another_folder&#x2F;my_file.txt</li>
</ul>
</li>
<li>The key is composed of <font color=red>prefix</font> + <font color=green>object name</font><ul>
<li>s3:&#x2F;&#x2F;my-bucket&#x2F;<font color=red>my_folder&#x2F;another_folder&#x2F;</font><font color=green>my_file.txt</font></li>
</ul>
</li>
<li>Object values are the content of the body:<ul>
<li>Max. Object Size is 5 TB (5000 GB)</li>
<li>If uploading more than 5 GB, must use â€œmulti-part uploadâ€.</li>
</ul>
</li>
<li>Metadata<ul>
<li>List of text key&#x2F;value pairs</li>
<li>System or user metadata</li>
</ul>
</li>
<li>Tags<ul>
<li>Unicode key&#x2F;value pair</li>
<li>Up to 10</li>
<li>Useful for security&#x2F;lifecycle</li>
</ul>
</li>
<li>Version ID<ul>
<li>If versioning is enabled</li>
</ul>
</li>
</ul>
<h1 id="Use-Cases"><a href="#Use-Cases" class="headerlink" title="Use Cases"></a>Use Cases</h1><ul>
<li>Backup &amp; Storage</li>
<li>Disaster Recovery</li>
<li>Archive</li>
<li>Hybrid Cloud Storage</li>
<li>Application&#x2F;Media Hosting</li>
<li>Data Lakes &amp; Big Data Analytics</li>
<li>Software Delivery</li>
<li>Static Website</li>
</ul>
<h2 id="Business-Use-Cases"><a href="#Business-Use-Cases" class="headerlink" title="Business Use Cases"></a>Business Use Cases</h2><ul>
<li>Nasdaq stores 7 years of data into Glacier</li>
<li>Sysco runs analytics on its data and gain business insights</li>
</ul>
<h1 id="Limitations"><a href="#Limitations" class="headerlink" title="Limitations"></a>Limitations</h1>]]></content>
      <tags>
        <tag>S3</tag>
        <tag>â˜…â˜†â˜…</tag>
      </tags>
  </entry>
  <entry>
    <title>Plotly - Advanced</title>
    <url>/2023/08/05/TempNotes/Plotly-Advanced/</url>
    <content><![CDATA[<h1 id="For-Example-Line-Plots"><a href="#For-Example-Line-Plots" class="headerlink" title="For Example: Line Plots"></a>For Example: Line Plots</h1><p>ğŸ“˜ Download <a href="https://www.kaggle.com/datasets/garrickhague/world-earthquake-data-from-1906-2022">World Earthquake Data From 1906-2022</a></p>
<hr>
<h2 id="Line-Plots-with-plotly-express"><a href="#Line-Plots-with-plotly-express" class="headerlink" title="Line Plots with plotly.express"></a>Line Plots with <code>plotly.express</code></h2><p><em><font color=royalblue>The plotly.express module (usually imported as px) contains functions that can create entire figures at once.<br>Plotly Express is a built-in part of the plotly library, and is the recommended starting point for creating most common figures.</font></em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pre-processing</span></span><br><span class="line">df[<span class="string">&#x27;Year&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;time&#x27;</span>]).dt.year</span><br><span class="line">df[<span class="string">&quot;Country&quot;</span>] = df[<span class="string">&quot;place&quot;</span>].<span class="built_in">str</span>.split(pat=<span class="string">&#x27;,&#x27;</span>, expand=<span class="literal">False</span>).<span class="built_in">str</span>.get(-<span class="number">1</span>)</span><br><span class="line">df[<span class="string">&quot;Max_mag&quot;</span>] = df.groupby([<span class="string">&#x27;Year&#x27;</span>])[<span class="string">&#x27;mag&#x27;</span>].transform(<span class="built_in">max</span>)</span><br><span class="line"></span><br><span class="line">df = df.query(<span class="string">&quot;2012 &lt;= Year &lt;= 2022&quot;</span>)</span><br><span class="line">fig = px.line(df, x=<span class="string">&quot;Year&quot;</span>, y=<span class="string">&quot;Max_mag&quot;</span>, title=<span class="string">&#x27;Max magnitude from 2000 to 2022&#x27;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<ul>
<li>Explanation<ul>
<li><p>Pandas <code>groupby</code> splits all the records from your data set into different categories or groups and offers you flexibility to analyze the data by these groups.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Group by &#x27;Year&#x27;, and get the maximum of &#x27;mag&#x27; column</span></span><br><span class="line">df.groupby([<span class="string">&#x27;Year&#x27;</span>])[<span class="string">&#x27;mag&#x27;</span>].<span class="built_in">max</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Group by &#x27;Year&#x27;, get the maximum of &#x27;mag&#x27; column, and fit the length of dataframe  </span></span><br><span class="line">df.groupby([<span class="string">&#x27;Year&#x27;</span>])[<span class="string">&#x27;mag&#x27;</span>].transform(<span class="built_in">max</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Query &#x27;2022 &gt;= Year &gt;= 2021&#x27; and get the value of &#x27;Max_mag&#x27; column</span></span><br><span class="line">df.query(<span class="string">&quot;2022 &gt;= Year &gt;= 2021&quot;</span>)[<span class="string">&quot;Max_mag&quot;</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<hr>
<h2 id="Line-Plots-with-Column-Encoding-Color"><a href="#Line-Plots-with-Column-Encoding-Color" class="headerlink" title="Line Plots with Column Encoding Color"></a>Line Plots with Column Encoding Color</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pre-processing</span></span><br><span class="line">df[<span class="string">&#x27;Year&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;time&#x27;</span>]).dt.year</span><br><span class="line">df[<span class="string">&quot;Country&quot;</span>] = df[<span class="string">&quot;place&quot;</span>].<span class="built_in">str</span>.split(pat=<span class="string">&#x27;,&#x27;</span>, expand=<span class="literal">False</span>).<span class="built_in">str</span>.get(-<span class="number">1</span>)</span><br><span class="line">df[<span class="string">&quot;Max_mag&quot;</span>] = df.groupby([<span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;magType&#x27;</span>])[<span class="string">&#x27;mag&#x27;</span>].transform(<span class="built_in">max</span>)</span><br><span class="line"></span><br><span class="line">df = df.query(<span class="string">&quot;2012 &lt;= Year &lt;= 2022&quot;</span>)</span><br><span class="line">fig = px.line(df, x=<span class="string">&quot;Year&quot;</span>, y=<span class="string">&quot;Max_mag&quot;</span>, </span><br><span class="line">  title=<span class="string">&#x27;Max magnitude from 2012 to 2022&#x27;</span>, color=<span class="string">&#x27;magType&#x27;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<ul>
<li>Explanation<ul>
<li><p>Pandas <code>groupby</code> splits all the records from your data set into different categories or groups and offers you flexibility to analyze the data by these groups.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Group by &#x27;Year&#x27; and &#x27;magType&#x27;, and get the maximum of &#x27;mag&#x27; column</span></span><br><span class="line">df.groupby([<span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;magType&#x27;</span>])[<span class="string">&#x27;mag&#x27;</span>].<span class="built_in">max</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Group by &#x27;Year&#x27; and &#x27;magType&#x27;, get the maximum of &#x27;mag&#x27; column, and fit the length of dataframe  </span></span><br><span class="line">df.groupby([<span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;magType&#x27;</span>])[<span class="string">&#x27;mag&#x27;</span>].transform(<span class="built_in">max</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Query &#x27;2022 &gt;= Year &gt;= 2021&#x27; and get the value of &#x27;Max_mag&#x27; column</span></span><br><span class="line">df.query(<span class="string">&quot;2022 &gt;= Year &gt;= 2021&quot;</span>)[<span class="string">&quot;Max_mag&quot;</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<hr>
<h2 id="Basic-Settings"><a href="#Basic-Settings" class="headerlink" title="Basic Settings"></a>Basic Settings</h2><h3 id="Line-charts-with-Markers"><a href="#Line-charts-with-Markers" class="headerlink" title="Line charts with Markers"></a>Line charts with Markers</h3><ul>
<li><p>Set Title</p>
<ul>
<li><code>title = &#39;Max magnitude and Min depth from 2012 to 2022&#39;</code></li>
</ul>
</li>
<li><p>Add one more field on text label</p>
<ul>
<li><p><code>text = &quot;Min_depth&quot;</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pre-processing</span></span><br><span class="line">df[<span class="string">&#x27;Year&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;time&#x27;</span>]).dt.year</span><br><span class="line">df[<span class="string">&quot;Country&quot;</span>] = df[<span class="string">&quot;place&quot;</span>].<span class="built_in">str</span>.split(pat=<span class="string">&#x27;,&#x27;</span>, expand=<span class="literal">False</span>).<span class="built_in">str</span>.get(-<span class="number">1</span>)</span><br><span class="line">df[<span class="string">&quot;Max_mag&quot;</span>] = df.groupby([<span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;magType&#x27;</span>])[<span class="string">&#x27;mag&#x27;</span>].transform(<span class="built_in">max</span>)</span><br><span class="line">df[<span class="string">&quot;Min_depth&quot;</span>] = df.groupby([<span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;magType&#x27;</span>])[<span class="string">&#x27;depth&#x27;</span>].transform(<span class="built_in">min</span>)</span><br><span class="line"></span><br><span class="line">query_df = df.query(<span class="string">&quot;2022 &gt;= Year &gt;= 2012 &amp; magType in [&#x27;mw&#x27;, &#x27;ml&#x27;, &#x27;ms&#x27;, &#x27;mb&#x27;]&quot;</span>)</span><br><span class="line">fig = px.line(query_df, x=<span class="string">&quot;Year&quot;</span>, y=<span class="string">&quot;Max_mag&quot;</span>, </span><br><span class="line">  title=<span class="string">&#x27;Max magnitude and Min depth from 2012 to 2022&#x27;</span>, </span><br><span class="line">  color=<span class="string">&#x27;magType&#x27;</span>, text=<span class="string">&quot;Min_depth&quot;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Mark data points</p>
<ul>
<li><p>Method 1: <code>markers = True</code></p>
</li>
<li><p>Method 2: <code>symbol = &quot;magType&quot;</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pre-processing</span></span><br><span class="line">df[<span class="string">&#x27;Year&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;time&#x27;</span>]).dt.year</span><br><span class="line">df[<span class="string">&quot;Country&quot;</span>] = df[<span class="string">&quot;place&quot;</span>].<span class="built_in">str</span>.split(pat=<span class="string">&#x27;,&#x27;</span>, expand=<span class="literal">False</span>).<span class="built_in">str</span>.get(-<span class="number">1</span>)</span><br><span class="line">df[<span class="string">&quot;Max_mag&quot;</span>] = df.groupby([<span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;magType&#x27;</span>])[<span class="string">&#x27;mag&#x27;</span>].transform(<span class="built_in">max</span>)</span><br><span class="line"></span><br><span class="line">query_df = df.query(<span class="string">&quot;2022 &gt;= Year &gt;= 2012&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 1: markers</span></span><br><span class="line">fig = px.line(query_df, x=<span class="string">&quot;Year&quot;</span>, y=<span class="string">&quot;Max_mag&quot;</span>, </span><br><span class="line">  title=<span class="string">&#x27;Max magnitude from 2012 to 2022&#x27;</span>, </span><br><span class="line">  color=<span class="string">&#x27;magType&#x27;</span>, markers=<span class="literal">True</span>)</span><br><span class="line">fig.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: symbol</span></span><br><span class="line">fig = px.line(query_df, x=<span class="string">&quot;Year&quot;</span>, y=<span class="string">&quot;Max_mag&quot;</span>, </span><br><span class="line">  title=<span class="string">&#x27;Max magnitude from 2012 to 2022&#x27;</span>, </span><br><span class="line">  color=<span class="string">&#x27;magType&#x27;</span>, symbol=<span class="string">&quot;magType&quot;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="Save-a-Plot"><a href="#Save-a-Plot" class="headerlink" title="Save a Plot"></a>Save a Plot</h3><figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"># Install Package</span><br><span class="line">$ pip install -U kaleido</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Save a Figure in xxx Format: PNG, JPEG, SVG, PDF</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># PNG</span></span><br><span class="line">fig.write_image(<span class="string">&quot;fig1.png&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># JPEG</span></span><br><span class="line">fig.write_image(<span class="string">&quot;fig1.jpeg&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># SVG</span></span><br><span class="line">fig.write_image(<span class="string">&quot;fig1.svg&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PDF</span></span><br><span class="line">fig.write_image(<span class="string">&quot;fig1.pdf&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Change Image dimension and Scale</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig.write_image(<span class="string">&#x27;fig2_scale2.jpeg&#x27;</span>, width=<span class="number">600</span>, height=<span class="number">350</span>, scale=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Interactive HTML export in Plotly Python</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig.write_html(<span class="string">&quot;fig1.html&quot;</span>, auto_open=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="Advanced-Interactive-Custom-Controls"><a href="#Advanced-Interactive-Custom-Controls" class="headerlink" title="Advanced: Interactive Custom Controls"></a>Advanced: Interactive Custom Controls</h2><h3 id="Basic-Range-Slider-and-Range-Selectors"><a href="#Basic-Range-Slider-and-Range-Selectors" class="headerlink" title="Basic Range Slider and Range Selectors"></a>Basic Range Slider and Range Selectors</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> plotly.graph_objects <span class="keyword">as</span> go</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load data</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pre-processing</span></span><br><span class="line">df[<span class="string">&#x27;Year&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;time&#x27;</span>]).dt.year</span><br><span class="line">df[<span class="string">&quot;Max_mag&quot;</span>] = df.groupby([<span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;magType&#x27;</span>])[<span class="string">&#x27;mag&#x27;</span>].transform(<span class="built_in">max</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Query</span></span><br><span class="line">query_df = df.query(<span class="string">&quot;magType == &#x27;mww&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create figure</span></span><br><span class="line">fig = go.Figure()</span><br><span class="line"></span><br><span class="line">fig.add_trace(</span><br><span class="line">    go.Scatter(x=<span class="built_in">list</span>(query_df.time), y=<span class="built_in">list</span>(query_df.Max_mag)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set title</span></span><br><span class="line">fig.update_layout(</span><br><span class="line">    title_text=<span class="string">&quot;Time series with range slider and selectors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add range slider</span></span><br><span class="line">fig.update_layout(</span><br><span class="line">    xaxis=<span class="built_in">dict</span>(</span><br><span class="line">        rangeselector=<span class="built_in">dict</span>(</span><br><span class="line">            buttons=<span class="built_in">list</span>([</span><br><span class="line">                <span class="built_in">dict</span>(count=<span class="number">1</span>, label=<span class="string">&quot;1m&quot;</span>, step=<span class="string">&quot;month&quot;</span>, stepmode=<span class="string">&quot;backward&quot;</span>),</span><br><span class="line">                <span class="built_in">dict</span>(count=<span class="number">6</span>, label=<span class="string">&quot;6m&quot;</span>, step=<span class="string">&quot;month&quot;</span>, stepmode=<span class="string">&quot;backward&quot;</span>),</span><br><span class="line">                <span class="built_in">dict</span>(count=<span class="number">1</span>, label=<span class="string">&quot;YTD&quot;</span>, step=<span class="string">&quot;year&quot;</span>, stepmode=<span class="string">&quot;todate&quot;</span>),</span><br><span class="line">                <span class="built_in">dict</span>(count=<span class="number">1</span>, label=<span class="string">&quot;1y&quot;</span>, step=<span class="string">&quot;year&quot;</span>, stepmode=<span class="string">&quot;backward&quot;</span>),</span><br><span class="line">                <span class="built_in">dict</span>(step=<span class="string">&quot;all&quot;</span>)</span><br><span class="line">            ])</span><br><span class="line">        ),</span><br><span class="line">        rangeslider=<span class="built_in">dict</span>( visible=<span class="literal">True</span> ),</span><br><span class="line">        <span class="built_in">type</span>=<span class="string">&quot;date&quot;</span></span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://www.usgs.gov/programs/earthquake-hazards/magnitude-types">USGS - Magnitude Types</a></li>
<li><a href="https://academic-accelerator.com/encyclopedia/zh/moment-magnitude-scale">çŸ©é‡ç´š Moment Magnitude Scale</a></li>
<li><a href="https://www.facebook.com/momlovestaiwan/photos/a.1076309132504673/1076350115833908/?type=3&locale=zh_TW">Magnitude Type: Mw vs. ML vs. MS vs. mb</a></li>
<li><a href="https://plotly.com/python/">Plotly Open Source Graphing Library for Python</a></li>
</ul>
]]></content>
      <tags>
        <tag>Data Visualization</tag>
        <tag>Python</tag>
        <tag>Plotly</tag>
      </tags>
  </entry>
  <entry>
    <title>Plotly - Basics</title>
    <url>/2023/08/03/TempNotes/Plotly-Basics/</url>
    <content><![CDATA[<blockquote>
<h3><i><font color=saddlebrown>If you work with massive datasets, <br>you can use a library like Plotly, designed to handle massive datasets well.</font></i></h3>
</blockquote>
<hr>
<h1 id="Before-Doing-Data-Visualization"><a href="#Before-Doing-Data-Visualization" class="headerlink" title="Before Doing Data Visualization"></a>Before Doing Data Visualization</h1><h2 id="Find-Datasets"><a href="#Find-Datasets" class="headerlink" title="Find Datasets"></a>Find Datasets</h2><ul>
<li><a href="https://www.kaggle.com/datasets">Kaggle Datasets</a></li>
<li><a href="https://datasetsearch.research.google.com/">Google Dataset Search</a></li>
<li><a href="https://data.gov.tw/">Taiwan Governmentâ€™s Open Data</a></li>
<li><a href="https://data.gov/">The U.S. Governmentâ€™s Open Data</a></li>
<li>â€¦</li>
</ul>
<h2 id="Prepared-Environment"><a href="#Prepared-Environment" class="headerlink" title="Prepared Environment"></a>Prepared Environment</h2><ul>
<li>Install packages<ul>
<li>Plotly</li>
<li>Pandas</li>
<li><a href="https://jupyter.org/install">JupyterLab</a></li>
</ul>
</li>
</ul>
<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line">$ pip install plotly==<span class="number">5.15</span>.<span class="number">0</span></span><br><span class="line">$ pip install pandas</span><br><span class="line">$ pip install jupyterlab</span><br><span class="line">$ jupyter lab</span><br></pre></td></tr></table></figure>

<h2 id="Load-Dataset"><a href="#Load-Dataset" class="headerlink" title="Load Dataset"></a>Load Dataset</h2><p>ğŸ“˜ Download <a href="https://www.kaggle.com/datasets/garrickhague/world-earthquake-data-from-1906-2022">World Earthquake Data From 1906-2022</a></p>
<ul>
<li><code>head()</code><ul>
<li>Shows the first n (the default is 5) rows</li>
</ul>
</li>
<li><code>tail()</code><ul>
<li>The â€œoppositeâ€ method of head() is tail()</li>
<li>Shows the last n (5 by default) rows of the dataframe object</li>
</ul>
</li>
<li><code>info()</code> <ul>
<li>Prints out a concise summary of the dataframe, including information about the index, data types, columns, non-null values, and memory usage</li>
</ul>
</li>
<li><code>describe()</code><ul>
<li>Generates descriptive statistics, including those that summarize the central tendency, dispersion, and shape of the datasetâ€™s distribution</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Shows the first 5 rows</span></span><br><span class="line"><span class="built_in">print</span>(df.head())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Shows the last 5 rows</span></span><br><span class="line"><span class="built_in">print</span>(df.tail())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Concise summary of the dataframe</span></span><br><span class="line"><span class="built_in">print</span>(df.info())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Descriptive statistics</span></span><br><span class="line"><span class="built_in">print</span>(df.describe())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save as `Year` field</span></span><br><span class="line">df[<span class="string">&#x27;Year&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;time&#x27;</span>]).dt.year</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save as `Country` field</span></span><br><span class="line">df[<span class="string">&quot;Country&quot;</span>] = df[<span class="string">&quot;place&quot;</span>].<span class="built_in">str</span>.split(pat=<span class="string">&#x27;,&#x27;</span>, expand=<span class="literal">False</span>).<span class="built_in">str</span>.get(-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><em><font color=royalblue>After collection, most data requires some degree of cleaning or reformatting before it can be analyzed or used to create visualizations.</font></em></p>
<hr>
<h1 id="Getting-Started-Plotly"><a href="#Getting-Started-Plotly" class="headerlink" title="Getting Started - Plotly"></a>Getting Started - <a href="https://plotly.com/python/">Plotly</a></h1><h2 id="Line-Charts"><a href="#Line-Charts" class="headerlink" title="Line Charts"></a>Line Charts</h2><p>Line charts are used to convey changes over time.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = px.data.gapminder().query(<span class="string">&quot;country==&#x27;Canada&#x27;&quot;</span>)</span><br><span class="line">fig = px.line(df, x=<span class="string">&quot;year&quot;</span>, y=<span class="string">&quot;lifeExp&quot;</span>, title=<span class="string">&#x27;Life expectancy in Canada&#x27;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = px.data.gapminder().query(<span class="string">&quot;continent==&#x27;Oceania&#x27;&quot;</span>)</span><br><span class="line">fig = px.line(df, x=<span class="string">&quot;year&quot;</span>, y=<span class="string">&quot;lifeExp&quot;</span>, color=<span class="string">&#x27;country&#x27;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<h2 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h2><p>Use a histogram to visualize the frequency distribution of a single event over a certain time period.<br><em><font color=royalblue>A histogram is the graphical representation of quantitative data.</font></em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = px.data.tips()</span><br><span class="line">fig = px.histogram(df, x=<span class="string">&quot;total_bill&quot;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<h2 id="Bar-Charts"><a href="#Bar-Charts" class="headerlink" title="Bar Charts"></a>Bar Charts</h2><p><em><font color=royalblue>The bar chart is the graphical representation of categorical data.</font></em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">long_df = px.data.medals_long()</span><br><span class="line">fig = px.bar(long_df, x=<span class="string">&quot;nation&quot;</span>, y=<span class="string">&quot;count&quot;</span>, color=<span class="string">&quot;medal&quot;</span>, title=<span class="string">&quot;Long-Form Input&quot;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<h2 id="Scatter-Plots"><a href="#Scatter-Plots" class="headerlink" title="Scatter Plots"></a>Scatter Plots</h2><p>If you wanted to <strong>highlight the relationship or correlations between two variables</strong> (e.g. marketing spend and revenue, or hours of weekly exercise vs. cardiovascular fitness), you could use a scatter plot to see, at a glance, if one increases as the other decreases (or vice versa).</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line">df[<span class="string">&#x27;Year&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;time&#x27;</span>]).dt.year</span><br><span class="line">fig = px.scatter(df, x=<span class="string">&quot;Year&quot;</span>, y=<span class="string">&quot;mag&quot;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<h2 id="Pie-chart"><a href="#Pie-chart" class="headerlink" title="Pie chart"></a>Pie chart</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = px.data.tips()</span><br><span class="line">fig = px.pie(df, values=<span class="string">&#x27;tip&#x27;</span>, names=<span class="string">&#x27;day&#x27;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<h2 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Draw a map after doing `mag &gt;= 7` query</span></span><br><span class="line">fig = px.density_mapbox(df.query(<span class="string">&quot;mag &gt;= 7&quot;</span>), lat=<span class="string">&#x27;latitude&#x27;</span>, lon=<span class="string">&#x27;longitude&#x27;</span>, z=<span class="string">&#x27;mag&#x27;</span>, radius=<span class="number">10</span>,</span><br><span class="line">                        center=<span class="built_in">dict</span>(lat=<span class="number">0</span>, lon=<span class="number">180</span>), zoom=<span class="number">0</span>, mapbox_style=<span class="string">&quot;stamen-terrain&quot;</span>)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Do pre-processing on `place` field </span></span><br><span class="line">df[<span class="string">&quot;Country&quot;</span>] = df[<span class="string">&quot;place&quot;</span>].<span class="built_in">str</span>.split(pat=<span class="string">&#x27;,&#x27;</span>, expand=<span class="literal">False</span>).<span class="built_in">str</span>.get(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">fig = px.scatter_mapbox(df.query(<span class="string">&quot;mag &gt;= 7&quot;</span>), lat=<span class="string">&quot;latitude&quot;</span>, lon=<span class="string">&quot;longitude&quot;</span>, </span><br><span class="line">                        hover_name=<span class="string">&quot;Country&quot;</span>, hover_data=[<span class="string">&quot;mag&quot;</span>, <span class="string">&quot;depth&quot;</span>],</span><br><span class="line">                        color_discrete_sequence=[<span class="string">&quot;red&quot;</span>], zoom=<span class="number">3</span>, height=<span class="number">300</span>)</span><br><span class="line">fig.update_layout(mapbox_style=<span class="string">&quot;open-street-map&quot;</span>)</span><br><span class="line">fig.update_layout(margin=&#123;<span class="string">&quot;r&quot;</span>:<span class="number">0</span>,<span class="string">&quot;t&quot;</span>:<span class="number">0</span>,<span class="string">&quot;l&quot;</span>:<span class="number">0</span>,<span class="string">&quot;b&quot;</span>:<span class="number">0</span>&#125;)</span><br><span class="line">fig.show()</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://plotly.com/python/plotly-fundamentals/">Plotly Python Open Source Graphing Library Fundamentals</a></li>
<li><a href="https://www.datacamp.com/tutorial/python-plotly-express-tutorial">Python Plotly Express Tutorial: Unlock Beautiful Visualizations</a></li>
</ul>
]]></content>
      <tags>
        <tag>Data Visualization</tag>
        <tag>Python</tag>
        <tag>Plotly</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s Security | Authorization</title>
    <url>/2025/07/09/K8s-Advanced/K8s-Security-Authorization/</url>
    <content><![CDATA[<h1 id="Why-Authorization"><a href="#Why-Authorization" class="headerlink" title="Why Authorization?"></a>Why Authorization?</h1><p>åœ¨ K8s ä¸­ï¼Œä¸åŒé¡å‹çš„å¯¦é«”ï¼ˆä¾‹å¦‚ Adminsã€Developersã€Botsï¼‰åŸ·è¡Œçš„æ“ä½œæ¬Šé™æ‡‰æœ‰æ‰€å€éš”ï¼Œä»¥ç¶­è­·å¢é›†çš„å®‰å…¨æ€§èˆ‡è³‡æºéš”é›¢ã€‚å› æ­¤ï¼Œæˆ‘å€‘éœ€è¦ä½¿ç”¨ <code>æˆæ¬Šæ©Ÿåˆ¶ï¼ˆAuthorization Mechanismsï¼‰</code> ä¾†ç²¾ç´°æ§ç®¡èª°å¯ä»¥åšä»€éº¼ã€‚</p>
<h2 id="Authorization-Mechanisms"><a href="#Authorization-Mechanisms" class="headerlink" title="Authorization Mechanisms"></a>Authorization Mechanisms</h2><h3 id="Node-Authorizer"><a href="#Node-Authorizer" class="headerlink" title="Node Authorizer"></a>Node Authorizer</h3><p>Node Authorizer æ˜¯ä¸€ç¨®å°ˆé–€æˆæ¬Šçµ¦ Kubernetes <strong>kubeletï¼ˆç¯€é»ä»£ç†ç¨‹å¼ï¼‰</strong> çš„æ©Ÿåˆ¶ï¼Œå…è¨±å®ƒåªèƒ½å­˜å–èˆ‡å…¶è‡ªèº«ç›¸é—œçš„è³‡æºã€‚</p>
<blockquote>
<p>é€™æ˜¯ä¸€ç¨®ç‰¹æ®Šçš„æˆæ¬Šæ–¹å¼ï¼Œåƒ…é©ç”¨æ–¼ç¯€é»è‡ªèº«ï¼Œèˆ‡ä¸€èˆ¬ä½¿ç”¨è€…æˆæ¬Šä¸åŒã€‚</p>
</blockquote>
<p>ğŸ“Œ è£œå……ï¼škubelet é‚„èƒ½è®€å–å…¶æ‰€åœ¨ç¯€é»çš„ ConfigMap å’Œ Secretsï¼ˆå¦‚æœ pod æœ‰ mountï¼‰ã€‚</p>
<ul>
<li>èªè­‰æ–¹å¼ï¼š<ul>
<li><code>Kube API Server</code> é€šé <strong>user identity</strong> èˆ‡ <strong>TLS certificate</strong> åˆ¤æ–·è«‹æ±‚ä¾†æºæ˜¯å¦ç‚ºç¯€é»ã€‚</li>
</ul>
</li>
<li>é©ç”¨å°è±¡ï¼š<ul>
<li><code>kubelet</code>ï¼ˆç¯€é»ï¼‰</li>
</ul>
</li>
<li>ç¯€é»å…è¨±æ“ä½œçš„è³‡æºç¯„åœå¦‚ä¸‹ï¼š<ul>
<li>Read: Servicesã€Endpointsã€Nodesï¼ˆåƒ…é™è‡ªèº«è³‡è¨Šï¼‰ã€Podsï¼ˆåƒ…é™æŒ‡æ´¾çµ¦è©² Node çš„ Podsï¼‰</li>
<li>Write: Node statusã€Pod statusã€events</li>
</ul>
</li>
</ul>
<h3 id="ABAC"><a href="#ABAC" class="headerlink" title="ABAC"></a>ABAC</h3><p>ABAC æ˜¯æ—©æœŸ Kubernetes æ‰€æ”¯æ´çš„æˆæ¬Šæ©Ÿåˆ¶ä¹‹ä¸€ï¼Œé€ééœæ…‹ JSON policy æª”æ¡ˆæ§åˆ¶æ¯å€‹ä½¿ç”¨è€…å°è³‡æºçš„æ“ä½œæ¬Šé™ã€‚</p>
<ul>
<li>ç¼ºé»ï¼š<ul>
<li>ç„¡æ³•ç´°ç·»ç®¡ç†</li>
<li>æ¬Šé™å®šç¾©æ¡éœæ…‹è¨­å®šï¼Œä¸æ˜“ç¶­è­·</li>
<li>ç„¡æ³•å‹•æ…‹èª¿æ•´ï¼šç„¡æ³•æ ¹æ“šå‹•æ…‹æ¢ä»¶åšå‡ºæˆæ¬Šæ±ºç­–</li>
<li>ç„¡æ³•åšåˆ°è§’è‰²æŠ½è±¡ï¼ˆRole-based groupingï¼‰</li>
<li>è¨­å®šè®Šæ›´éœ€é‡æ–°å•Ÿå‹• API Server</li>
</ul>
</li>
<li>å¯¦å‹™ç¾æ³ï¼š<ul>
<li><mark>å·²è¢« RBAC å–ä»£ï¼ŒKubernetes 1.8+ é è¨­å•Ÿç”¨ RBACã€‚</mark></li>
</ul>
</li>
</ul>
<h4 id="ABAC-å¯¦ä¾‹èªªæ˜"><a href="#ABAC-å¯¦ä¾‹èªªæ˜" class="headerlink" title="ABAC å¯¦ä¾‹èªªæ˜"></a>ABAC å¯¦ä¾‹èªªæ˜</h4><table>
<thead>
<tr>
<th>ä½¿ç”¨è€… &#x2F; ç¾¤çµ„</th>
<th>æ¬Šé™å…§å®¹</th>
</tr>
</thead>
<tbody><tr>
<td><code>dev-user</code></td>
<td>å¯æª¢è¦–ã€å»ºç«‹ã€åˆªé™¤ Pods</td>
</tr>
<tr>
<td><code>dev-user-2</code></td>
<td>å¯æª¢è¦–ã€å»ºç«‹ã€åˆªé™¤ Pods</td>
</tr>
<tr>
<td><code>dev-users</code></td>
<td>ï¼ˆç¾¤çµ„ï¼‰å¯æª¢è¦–ã€å»ºç«‹ã€åˆªé™¤ Pods</td>
</tr>
<tr>
<td><code>security-1</code></td>
<td>å¯æª¢è¦–èˆ‡æ ¸å‡† CSRï¼ˆæ†‘è­‰ç°½ç½²è«‹æ±‚ï¼‰</td>
</tr>
</tbody></table>
<p>å®Œæ•´ ABAC Policyï¼ˆå–®ä¸€ä½¿ç”¨è€…ç¯„ä¾‹ï¼‰(e.g. dev-user)</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;abac.authorization.kubernetes.io/v1beta1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev-user&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pods&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;apiGroup&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;verb&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¤šç­†ç°¡åŒ– ABAC Policyï¼ˆé™£åˆ—æ ¼å¼ï¼‰</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Policy&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev-user&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pods&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;apiGroup&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Policy&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev-user-2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pods&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;apiGroup&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Policy&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev-users&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pods&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;apiGroup&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Policy&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;security-1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;csr&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;apiGroup&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="RBACï¼ˆRole-Based-Access-Controlï¼‰"><a href="#RBACï¼ˆRole-Based-Access-Controlï¼‰" class="headerlink" title="RBACï¼ˆRole-Based Access Controlï¼‰"></a>RBACï¼ˆRole-Based Access Controlï¼‰</h3><p>RBAC æ˜¯ç›®å‰ Kubernetes é è¨­ä¸”æ¨è–¦ä½¿ç”¨çš„æˆæ¬Šæ©Ÿåˆ¶ï¼Œé€éè§’è‰²èˆ‡ç¶å®šä¾†æ§åˆ¶ä½¿ç”¨è€…èˆ‡è³‡æºé–“çš„æ¬Šé™é—œä¿‚ã€‚</p>
<ul>
<li>è¨­è¨ˆç†å¿µ<ul>
<li>Role&#x2F;ClusterRoleï¼šå®šç¾©ä¸€çµ„æ¬Šé™ï¼ˆverbs + resourcesï¼‰</li>
<li>RoleBinding&#x2F;ClusterRoleBindingï¼šå°‡è§’è‰²è³¦äºˆçµ¦ç‰¹å®šçš„ä½¿ç”¨è€…ã€ç¾¤çµ„æˆ– ServiceAccount</li>
</ul>
</li>
</ul>
<h4 id="æ¬Šé™ç¯„ä¾‹è§’è‰²è¨­è¨ˆ"><a href="#æ¬Šé™ç¯„ä¾‹è§’è‰²è¨­è¨ˆ" class="headerlink" title="æ¬Šé™ç¯„ä¾‹è§’è‰²è¨­è¨ˆ"></a>æ¬Šé™ç¯„ä¾‹è§’è‰²è¨­è¨ˆ</h4><ul>
<li>Developer è§’è‰²<ul>
<li>âœ“ Can view PODs</li>
<li>âœ“ Can create PODs</li>
<li>âœ“ Can Delete PODs</li>
<li>âœ“ Can Create ConfigMaps</li>
<li>å°æ‡‰ä½¿ç”¨è€…ï¼ç¾¤çµ„ï¼šdev-user, dev-user-2, dev-users</li>
</ul>
</li>
<li>Security è§’è‰²<ul>
<li>âœ“ Can view CSRï¼ˆCertificateSigningRequest, æ†‘è­‰ç°½ç½²æµç¨‹è³‡æºï¼‰</li>
<li>âœ“ Can approve CSR</li>
<li>å°æ‡‰ä½¿ç”¨è€…ï¼š security-1</li>
</ul>
</li>
</ul>
<h3 id="Webhook-OPA"><a href="#Webhook-OPA" class="headerlink" title="Webhook (OPA)"></a>Webhook (OPA)</h3><p>Webhook æ¨¡å¼å…è¨± K8s æŠŠæˆæ¬Šåˆ¤æ–·äº¤ç”±å¤–éƒ¨ç³»çµ±æ±ºç­–ï¼Œæœ€å¸¸è¦‹çš„å¯¦ä½œæ˜¯ <a href="https://www.openpolicyagent.org/">OPA - Open Policy Agent</a>ã€‚</p>
<blockquote>
<p><code>Gatekeeper</code> æ˜¯å¯¦ä½œ OPA çš„å¸¸ç”¨å·¥å…·ã€‚</p>
</blockquote>
<h4 id="æˆæ¬Šæµç¨‹"><a href="#æˆæ¬Šæµç¨‹" class="headerlink" title="æˆæ¬Šæµç¨‹"></a>æˆæ¬Šæµç¨‹</h4><ol>
<li>ä½¿ç”¨è€…ï¼ˆä¾‹å¦‚ <code>dev-user</code>ï¼‰ç™¼é€æ“ä½œè«‹æ±‚ï¼Œä¾‹å¦‚å»ºç«‹ Podã€‚</li>
<li>API Server å‚³é€è«‹æ±‚è‡³ OPA webhookï¼šAPI Server æ ¹æ“š â€“authorization-mode&#x3D;Webhook è¨­å®šï¼Œå‘¼å«å¤–éƒ¨ Webhook ä¼ºæœå™¨ã€‚</li>
<li>Webhookï¼ˆå¦‚ OPAï¼‰æ ¹æ“š Rego Policy æª¢æŸ¥æ˜¯å¦å…è¨±ï¼ˆallowï¼‰è©²æ“ä½œã€‚</li>
<li>Webhook å›å‚³ JSON çµæœï¼š<ul>
<li>HTTP 200 OK</li>
<li><code>allowed: true</code>ï¼ˆæˆ– falseï¼‰ <figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authorization.k8s.io/v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SubjectAccessReview&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;allowed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h2 id="Authorization-Modeï¼ˆæˆæ¬Šæ¨¡å¼ï¼‰"><a href="#Authorization-Modeï¼ˆæˆæ¬Šæ¨¡å¼ï¼‰" class="headerlink" title="Authorization Modeï¼ˆæˆæ¬Šæ¨¡å¼ï¼‰"></a>Authorization Modeï¼ˆæˆæ¬Šæ¨¡å¼ï¼‰</h2><p>Kubernetes æ”¯æ´å¤šç¨®æˆæ¬Šæ¨¡å¼ï¼Œå¯åŒæ™‚å•Ÿç”¨ã€ä¸¦ä¾ç…§é †åºåˆ¤æ–·ï¼š</p>
<table>
<thead>
<tr>
<th>æ¨¡å¼é¡å‹</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>Node</code></td>
<td>åƒ…æˆæ¬Š kubelet å°è‡ªå·±ç›¸é—œè³‡æºé€²è¡Œæ“ä½œ</td>
</tr>
<tr>
<td><code>ABAC</code></td>
<td>éœæ…‹ JSON-based æˆæ¬Šï¼ˆå·²ä¸å»ºè­°ï¼‰</td>
</tr>
<tr>
<td><code>RBAC</code></td>
<td>æ¨è–¦ä½¿ç”¨çš„è§’è‰²å‹æˆæ¬Šï¼Œæ”¯æ´ç¾¤çµ„ã€è§’è‰²ç¶å®šç­‰</td>
</tr>
<tr>
<td><code>Webhook</code></td>
<td>å‘¼å«å¤–éƒ¨ç³»çµ±ï¼ˆå¦‚ OPAï¼‰é€²è¡Œæ±ºç­–</td>
</tr>
<tr>
<td><code>AlwaysAllow</code></td>
<td>æ‰€æœ‰è«‹æ±‚éƒ½å…è¨±ï¼ˆä¸å®‰å…¨ï¼Œåƒ…ç”¨æ–¼æ¸¬è©¦ï¼‰</td>
</tr>
<tr>
<td><code>AlwaysDeny</code></td>
<td>æ‰€æœ‰è«‹æ±‚éƒ½æ‹’çµ•ï¼ˆä¸å¯¦ç”¨ï¼‰</td>
</tr>
</tbody></table>


<h3 id="API-Server-å•Ÿå‹•åƒæ•¸ç¯„ä¾‹"><a href="#API-Server-å•Ÿå‹•åƒæ•¸ç¯„ä¾‹" class="headerlink" title="API Server å•Ÿå‹•åƒæ•¸ç¯„ä¾‹"></a>API Server å•Ÿå‹•åƒæ•¸ç¯„ä¾‹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">  --advertise-address=<span class="variable">$&#123;INTERNAL_IP&#125;</span> \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --apiserver-count=3 \</span><br><span class="line">  --authorization-mode=Node,RBAC,Webhook \</span><br><span class="line">  <span class="comment"># å…¶ä»–åƒæ•¸ç•¥ ...</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯åŒæ™‚å•Ÿç”¨å¤šç¨®æˆæ¬Šæ©Ÿåˆ¶ï¼Œ<strong>ç³»çµ±æœƒä¾åºé€²è¡Œæˆæ¬Šæª¢æŸ¥</strong>ã€‚</p>
</blockquote>


<div class="note info"><p><code>--authorization-mode=Node,RBAC,Webhook</code> çš„æˆæ¬Šé †åºå¦‚ä¸‹ï¼š<br><code>**Node â†’ RBAC â†’ Webhook**</code><br>ä¸€æ—¦ä»»ä¸€æˆæ¬Šæ¨¡å¼å…è¨±è©²è«‹æ±‚ï¼ŒAPI Server å³å…è¨±æ­¤æ“ä½œã€‚</p>
<p>âš  ABAC èˆ‡ RBAC ç„¡æ³•åŒæ™‚æ··ç”¨ï¼Œéœ€åœ¨å•Ÿå‹•åƒæ•¸ä¸­é¸æ“‡è¦ç”¨å“ªä¸€å€‹ï¼Œä¸” ABAC ä¿®æ”¹ policy å¾Œéœ€é‡å•Ÿ API Serverã€‚</p>
</div>

<hr>
<h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><h2 id="API-Group-èˆ‡-RBAC-å°æ‡‰é—œä¿‚"><a href="#API-Group-èˆ‡-RBAC-å°æ‡‰é—œä¿‚" class="headerlink" title="API Group èˆ‡ RBAC å°æ‡‰é—œä¿‚"></a>API Group èˆ‡ RBAC å°æ‡‰é—œä¿‚</h2><table>
<thead>
<tr>
<th>è³‡æº</th>
<th>API Group</th>
<th>RBAC è¨­å®š</th>
</tr>
</thead>
<tbody><tr>
<td>pods</td>
<td><code>&quot;&quot;</code> (core group)</td>
<td><code>apiGroups: [&quot;&quot;]</code></td>
</tr>
<tr>
<td>deployments</td>
<td><code>apps</code> (apps group)</td>
<td><code>apiGroups: [&quot;apps&quot;]</code></td>
</tr>
<tr>
<td>RBAC ç›¸é—œè³‡æºï¼ˆroles, rolebindingsï¼‰</td>
<td><code>rbac.authorization.k8s.io</code></td>
<td><code>apiGroups: [&quot;rbac.authorization.k8s.io&quot;]</code></td>
</tr>
</tbody></table>
<h2 id="Role-å®šç¾©ç¯„ä¾‹"><a href="#Role-å®šç¾©ç¯„ä¾‹" class="headerlink" title="Role å®šç¾©ç¯„ä¾‹"></a>Role å®šç¾©ç¯„ä¾‹</h2><ul>
<li>Role æ˜¯ namespace ç´šåˆ¥çš„æ¬Šé™è¨­å®šã€‚</li>
<li>developer role å…è¨±å° pods åšå¸¸ç”¨æ“ä½œï¼Œä¸¦å¯å»ºç«‹ configmapsã€‚</li>
<li>å¯é™åˆ¶ç‰¹å®šè³‡æºåç¨±ï¼ˆresourceNamesï¼‰ä¾†ç´°åŒ–æ¬Šé™ã€‚</li>
</ul>
<h2 id="RoleBinding-ç¶å®šä½¿ç”¨è€…"><a href="#RoleBinding-ç¶å®šä½¿ç”¨è€…" class="headerlink" title="RoleBinding ç¶å®šä½¿ç”¨è€…"></a>RoleBinding ç¶å®šä½¿ç”¨è€…</h2><ul>
<li>RoleBinding å°‡ Role è§’è‰²æˆæ¬Šçµ¦ç‰¹å®š user æˆ– groupã€‚</li>
<li>å¯ç¶å®š Userã€Group å…©ç¨® kindï¼Œæ–¹ä¾¿é…åˆ AD&#x2F;LDAP ä½¿ç”¨ã€‚</li>
</ul>
<div class="note info"><p><strong>è£œå……ï¼šRole&#x2F;RoleBinding vs ClusterRole&#x2F;ClusterRoleBinding</strong></p>
<table>
<thead>
<tr>
<th>è§’è‰²é¡å‹</th>
<th>ä½¿ç”¨ç¯„åœ</th>
<th>é©ç”¨å ´æ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>Role&#x2F;RoleBinding</td>
<td>å–®ä¸€ namespace</td>
<td>éœ€é™åˆ¶åœ¨æŸ namespace</td>
</tr>
<tr>
<td>ClusterRole&#x2F;ClusterRoleBinding</td>
<td>å…¨ cluster æˆ–è·¨ namespace</td>
<td>è·¨ namespace æˆ–éœ€å­˜å– cluster-wide è³‡æºå¦‚ nodesã€secrets</td>
</tr>
</tbody></table>
<p>âš  è£œå……ï¼šã€Œè‹¥ä½ éœ€è®“ä¸€å€‹ ServiceAccount å­˜å–ä¸åŒ namespace çš„è³‡æºï¼Œæ‡‰ä½¿ç”¨ <code>ClusterRole</code> + <code>RoleBinding</code> åœ¨å„å‘½åç©ºé–“åˆ†åˆ¥ç¶å®šã€ã€‚</p>
<br>

<p><strong>è£œå……ï¼šClusterRoleBinding</strong></p>
<ul>
<li>å°‡ ClusterRole æˆæ¬Šçµ¦ç‰¹å®šä½¿ç”¨è€…ï¼Œä½œç”¨ç¯„åœç‚ºæ•´å€‹ cluster æˆ–è·¨ namespaceã€‚</li>
</ul>
<br>

<p><strong>å¯¦å‹™å ´æ™¯æ‡‰ç”¨å»ºè­°</strong></p>
<table>
<thead>
<tr>
<th>ç”¨é€”</th>
<th>å»ºè­°æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td>å–® Namespace æ¬Šé™æ§åˆ¶</td>
<td>ä½¿ç”¨ <code>Role + RoleBinding</code></td>
</tr>
<tr>
<td>è·¨ Namespace æˆ–å¢é›†è³‡æº</td>
<td>ä½¿ç”¨ <code>ClusterRole + ClusterRoleBinding</code></td>
</tr>
<tr>
<td>å¤–éƒ¨æ”¿ç­–æ§åˆ¶</td>
<td>æ•´åˆ OPA + Gatekeeper</td>
</tr>
<tr>
<td>å‹•æ…‹ç”¨æˆ¶ç¾¤ç®¡ç†</td>
<td>æ­é… AD&#x2F;LDAP group</td>
</tr>
</tbody></table>
</div>

<h2 id="æŒ‡ä»¤æ“ä½œ"><a href="#æŒ‡ä»¤æ“ä½œ" class="headerlink" title="æŒ‡ä»¤æ“ä½œ"></a>æŒ‡ä»¤æ“ä½œ</h2><h3 id="Create-Role"><a href="#Create-Role" class="headerlink" title="Create Role"></a>Create Role</h3><img src="/2025/07/09/K8s-Advanced/K8s-Security-Authorization/RBAC_1.jpg" class="">

<h4 id="developer-role-yaml"><a href="#developer-role-yaml" class="headerlink" title="developer-role.yaml"></a>developer-role.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">developer</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>]</span><br></pre></td></tr></table></figure>

<details class="note default"><summary><p><code>developer-role.yaml</code> è£œå……ï¼šResource Names</p>
</summary>
<p>é™åˆ¶åªèƒ½ä½¿ç”¨å“ªäº› resourceNames (â€œblueâ€, â€œorangeâ€)</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># developer-role.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">developer</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&quot;blue&quot;</span>, <span class="string">&quot;orange&quot;</span>]</span><br></pre></td></tr></table></figure>
</details>

<h4 id="Kubectl-Command"><a href="#Kubectl-Command" class="headerlink" title="Kubectl Command"></a>Kubectl Command</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create -f developer-role.yaml</span><br></pre></td></tr></table></figure>

<h3 id="Binding-role-and-users"><a href="#Binding-role-and-users" class="headerlink" title="Binding role and users"></a>Binding role and users</h3><img src="/2025/07/09/K8s-Advanced/K8s-Security-Authorization/RBAC_2.jpg" class="">

<h4 id="developer-role-yaml-1"><a href="#developer-role-yaml-1" class="headerlink" title="developer-role.yaml"></a>developer-role.yaml</h4><p>åŒä¸Š</p>
<h4 id="devuser-developer-binding-yaml"><a href="#devuser-developer-binding-yaml" class="headerlink" title="devuser-developer-binding.yaml"></a>devuser-developer-binding.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">devuser-developer-binding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev-ns</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-user</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">developer</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<details class="note default"><summary><p>RBAC çš„ subjects æ”¯æ´ 3 ç¨® kind</p>
</summary>
<p>RBAC çš„ subjects æ”¯æ´ 3 ç¨® kindï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-user</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-team</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">app-ns</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ğŸ“Œ ç•¶ä½ çš„ cluster ä½¿ç”¨ AD&#x2F;LDAP æ•´åˆï¼Œgroup ç¶å®šæœƒéå¸¸å¸¸è¦‹ã€‚</p>
</blockquote>

</details>

<h4 id="Kubectl-Command-1"><a href="#Kubectl-Command-1" class="headerlink" title="Kubectl Command"></a>Kubectl Command</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create -f devuser-developer-binding.yaml</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="å¸¸ç”¨æŒ‡ä»¤"><a href="#å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="å¸¸ç”¨æŒ‡ä»¤"></a>å¸¸ç”¨æŒ‡ä»¤</h1><h2 id="View-RBAC"><a href="#View-RBAC" class="headerlink" title="View RBAC"></a>View RBAC</h2><p>æŸ¥çœ‹è§’è‰²èˆ‡ç¶å®š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get roles</span><br><span class="line"></span><br><span class="line">kubectl get rolebindings</span><br></pre></td></tr></table></figure>

<p>é‡å°è§’è‰²è©³ç´°è³‡è¨Š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe role [role_name]</span><br><span class="line">kubectl describe role developer</span><br><span class="line"></span><br><span class="line">kubectl describe rolebinding [rolebinding_name]</span><br><span class="line">kubectl describe rolebinding devuser-developer-binding</span><br></pre></td></tr></table></figure>

<h2 id="Check-Access"><a href="#Check-Access" class="headerlink" title="Check Access"></a>Check Access</h2><p>æ¬Šé™æª¢æŸ¥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl auth can-i [verb] [resource] --as [user] --namespace [ns]</span><br><span class="line"></span><br><span class="line">kubectl auth can-i create deployments</span><br><span class="line">kubectl auth can-i create deployments --as dev-user</span><br><span class="line">kubectl auth can-i create pods        --as dev-user</span><br><span class="line">kubectl auth can-i create pods        --as dev-user --namespace <span class="built_in">test</span></span><br><span class="line">kubectl auth can-i create pods        --as system:serviceaccount:app-ns:backend</span><br><span class="line"></span><br><span class="line">kubectl auth can-i delete nodes</span><br><span class="line"></span><br><span class="line">kubectl auth can-i get secrets --as dev-user</span><br><span class="line"><span class="comment"># â†’ no</span></span><br></pre></td></tr></table></figure>

<p>è‹¥æ˜¯ ClusterRoleï¼Œè¨˜å¾—è£œä¸Š <code>--all-namespaces</code> æˆ– <code>--namespace</code> ä»¥é©—è­‰ç”Ÿæ•ˆç¯„åœã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl auth can-i get pods --as dev-user --namespace default</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="å°çµ"><a href="#å°çµ" class="headerlink" title="å°çµ"></a>å°çµ</h1><ul>
<li>Kubernetes æä¾›å¤šç¨®æˆæ¬Šæ¨¡å¼ï¼š<ul>
<li><strong>Node Authorizer</strong>ï¼šæˆæ¬Š kubelet ç­‰ node å…ƒä»¶å­˜å–å¿…è¦è³‡æº</li>
<li><strong>ABAC</strong>ï¼šé€ééœæ…‹ JSON Policy æˆæ¬Šï¼ˆå·²è¼ƒå°‘ä½¿ç”¨ï¼‰</li>
<li><strong>RBAC</strong>ï¼šæœ€å¸¸è¦‹ï¼Œé€é Role&#x2F;ClusterRole èˆ‡ RoleBinding æ§ç®¡æ¬Šé™</li>
<li><strong>Webhook</strong>ï¼šäº¤ç”±å¤–éƒ¨ç³»çµ±å¦‚ OPA æ±ºç­–æˆæ¬Š</li>
</ul>
</li>
<li><code>--authorization-mode</code> å¯åŒæ™‚å•Ÿç”¨å¤šç¨®æˆæ¬Šæ©Ÿåˆ¶ï¼ˆNode, RBAC, Webhookï¼‰</li>
<li>RBAC åŸºæœ¬çµæ§‹ï¼š<ul>
<li><code>Role/ClusterRole</code> å®šç¾©æ¬Šé™</li>
<li><code>RoleBinding/ClusterRoleBinding</code> æŒ‡æ´¾æ¬Šé™çµ¦ User&#x2F;Group&#x2F;ServiceAccount</li>
</ul>
</li>
<li>é–‹ç™¼å¸¸ç”¨å·¥å…·ï¼š<ul>
<li><code>kubectl auth can-i</code></li>
<li><code>kubectl get roles</code>ã€<code>rolebindings</code></li>
<li><code>kubectl describe role</code> å¿«é€Ÿ debug æ¬Šé™</li>
</ul>
</li>
</ul>
<p>ğŸ“Œ ä¸‹ä¸€æ­¥å»ºè­°ï¼š<br>äº†è§£ <strong>ServiceAccount èˆ‡ RoleBinding æ­é… Pod é‹è¡Œèº«ä»½</strong>ï¼Œé€²å…¥å¯¦å‹™æ‡‰ç”¨å ´æ™¯ã€‚</p>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>Authorization</tag>
        <tag>ABAC</tag>
        <tag>RBAC</tag>
        <tag>Webhook</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s Security | Image Security &amp; SecurityContext</title>
    <url>/2025/07/10/K8s-Advanced/K8s-Security-Image-SecurityContext/</url>
    <content><![CDATA[<h1 id="âœ…-èƒŒæ™¯çŸ¥è­˜èˆ‡è§€å¿µ"><a href="#âœ…-èƒŒæ™¯çŸ¥è­˜èˆ‡è§€å¿µ" class="headerlink" title="âœ… èƒŒæ™¯çŸ¥è­˜èˆ‡è§€å¿µ"></a>âœ… èƒŒæ™¯çŸ¥è­˜èˆ‡è§€å¿µ</h1><h2 id="Image-Security-è§€å¿µ"><a href="#Image-Security-è§€å¿µ" class="headerlink" title="Image Security è§€å¿µ"></a>Image Security è§€å¿µ</h2><ul>
<li>é¿å…ä½¿ç”¨ <code>latest</code> tag â†’ <strong>ä¸å¯é æ¸¬ã€é¢¨éšªé«˜</strong></li>
<li>æŒ‡å®šæ˜ç¢ºç‰ˆæœ¬è™Ÿï¼ˆå¦‚ <code>nginx:1.24.2</code>ï¼‰</li>
<li>å„˜é‡é¸æ“‡ï¼š<ul>
<li>å¯ä¿¡ä¾†æºï¼ˆå®˜æ–¹ã€ä¼æ¥­å…§éƒ¨ registryï¼‰</li>
<li>å·²ç°½ç½² &#x2F; æƒæéçš„æ˜ åƒæª”ï¼ˆæ­é… Notaryã€Cosignï¼‰</li>
</ul>
</li>
<li>é…åˆ <code>imagePullPolicy</code> æ§åˆ¶ image æ›´æ–°ç­–ç•¥</li>
<li>å¯æ­é… Admission Controller å¯¦ä½œæ”¿ç­–é™åˆ¶<ul>
<li>å¦‚ï¼šGatekeeper + OPAã€ImagePolicyWebhook</li>
</ul>
</li>
</ul>
<h2 id="Linux-Container-å®‰å…¨æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µ"><a href="#Linux-Container-å®‰å…¨æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="Linux Container å®‰å…¨æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µ"></a>Linux Container å®‰å…¨æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µ</h2><ul>
<li><strong>Namespaces</strong>ï¼šéš”é›¢è³‡æºï¼ˆPIDã€ç¶²è·¯ã€Mount ç­‰ï¼‰</li>
<li><strong>cgroups</strong>ï¼šé™åˆ¶è³‡æºï¼ˆCPUã€Memoryï¼‰</li>
<li><strong>Capabilities</strong>ï¼šé™åˆ¶å®¹å™¨èƒ½ä½¿ç”¨å“ªäº›æ¬Šé™</li>
<li><strong>seccomp</strong>ï¼šé™åˆ¶èƒ½å‘¼å«å“ªäº› system calls</li>
</ul>
<blockquote>
<p>Kubernetes ç‚ºäº†å®‰å…¨æ€§ï¼Œ<strong>ä¸å»ºè­°å®¹å™¨ä»¥ root èº«ä»½åŸ·è¡Œ</strong>ï¼Œæ‡‰ä½¿ç”¨ non-root userã€‚</p>
</blockquote>
<hr>
<h1 id="Image-Security"><a href="#Image-Security" class="headerlink" title="Image Security"></a>Image Security</h1><h2 id="âœ…-ä½¿ç”¨ç§æœ‰æ˜ åƒæª”ï¼ˆPrivate-Imageï¼‰"><a href="#âœ…-ä½¿ç”¨ç§æœ‰æ˜ åƒæª”ï¼ˆPrivate-Imageï¼‰" class="headerlink" title="âœ… ä½¿ç”¨ç§æœ‰æ˜ åƒæª”ï¼ˆPrivate Imageï¼‰"></a>âœ… ä½¿ç”¨ç§æœ‰æ˜ åƒæª”ï¼ˆPrivate Imageï¼‰</h2><p>ç™»å…¥ç§æœ‰ Registry ä¸¦ä½¿ç”¨ image</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker login private-registry.io</span><br><span class="line">docker run private-registry.io/apps/internal-app</span><br></pre></td></tr></table></figure>

<p>å»ºç«‹å¯ä¾› K8s ä½¿ç”¨çš„ image pull secret</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create secret docker-registry regcred \</span><br><span class="line">  --docker-server=private-registry.io \</span><br><span class="line">  --docker-username=registry-user \</span><br><span class="line">  --docker-password=registry-password \</span><br><span class="line">  --docker-email=registry-user@org.com</span><br></pre></td></tr></table></figure>

<p>Pod ä½¿ç”¨ imagePullSecrets æŒ‡å®š Secret</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># nginx-pod.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">private-registry.io/apps/internal-app:v1.2.3</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">regcred</span></span><br></pre></td></tr></table></figure>

<h2 id="imagePullPolicy-è¡Œç‚ºæ¯”è¼ƒ"><a href="#imagePullPolicy-è¡Œç‚ºæ¯”è¼ƒ" class="headerlink" title="imagePullPolicy è¡Œç‚ºæ¯”è¼ƒ"></a>imagePullPolicy è¡Œç‚ºæ¯”è¼ƒ</h2><p><code>imagePullPolicy</code> æ˜¯ Kubernetes Pod ä¸­ container çš„ä¸€å€‹æ¬„ä½ï¼Œç”¨ä¾†æ§åˆ¶ Kubelet ä»€éº¼æ™‚å€™å»æ‹‰ï¼ˆpullï¼‰imageã€‚å®ƒåœ¨éƒ¨ç½²èˆ‡èª¿è©¦éšæ®µéå¸¸é‡è¦ï¼Œå°¤å…¶ç•¶ä½ ä½¿ç”¨è‡ªå»º image æˆ–é–‹ç™¼ä¸­é »ç¹æ›´æ–°çš„ imageã€‚</p>
<table>
<thead>
<tr>
<th>å€¼</th>
<th>è¡Œç‚ºèªªæ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>Always</code></td>
<td><strong>æ¯æ¬¡ Pod å•Ÿå‹•éƒ½æœƒé‡æ–°æ‹‰ image</strong>ï¼ˆä¸ç®¡æœ¬åœ°æœ‰æ²’æœ‰ï¼‰<br>é€šå¸¸ç”¨æ–¼ <code>:latest</code> image æˆ–ç¢ºä¿æ›´æ–°æ‹‰åˆ°æœ€æ–°</td>
</tr>
<tr>
<td><code>IfNotPresent</code></td>
<td><strong>åªæœ‰ç•¶æœ¬åœ°æ²’æœ‰å°æ‡‰ image æ‰æœƒå»æ‹‰</strong>ï¼ˆç¯€çœé »å¯¬èˆ‡å•Ÿå‹•æ™‚é–“ï¼‰</td>
</tr>
<tr>
<td><code>Never</code></td>
<td><strong>æ°¸é ä¸æœƒå»æ‹‰ image</strong>ï¼Œåªä½¿ç”¨æœ¬åœ°å·²æœ‰çš„ imageï¼Œæ‹‰ä¸åˆ°å°±æœƒå¤±æ•—ï¼ˆCI&#x2F;CDã€æ¸¬è©¦ç’°å¢ƒæœ‰æ™‚æœƒç”¨ï¼‰</td>
</tr>
</tbody></table>
<blockquote>
<p>é è¨­å€¼æœƒä¾æ“š image æ˜¯å¦ä½¿ç”¨ <code>latest</code> è€Œè®ŠåŒ–ï¼š  </p>
<ul>
<li>ä½¿ç”¨ <code>:latest</code> â†’ é è¨­ç‚º <code>Always</code>  </li>
<li>æŒ‡å®šå…¶ä»– tag â†’ é è¨­ç‚º <code>IfNotPresent</code><br>âœ… ç‚ºäº†å¯é æ¸¬æ€§ï¼Œå¼·çƒˆå»ºè­°æ°¸é æ˜ç¢ºè¨­å®š <code>imagePullPolicy</code>ã€‚</li>
</ul>
</blockquote>
<p>æŸ¥çœ‹ Pod ä½¿ç”¨çš„ Image</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe pod mypod | grep Image</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Docker-Security-å¯¦å‹™"><a href="#Docker-Security-å¯¦å‹™" class="headerlink" title="Docker Security å¯¦å‹™"></a>Docker Security å¯¦å‹™</h1><h2 id="âœ…-ä½¿ç”¨é-root-user"><a href="#âœ…-ä½¿ç”¨é-root-user" class="headerlink" title="âœ… ä½¿ç”¨é root user"></a>âœ… ä½¿ç”¨é root user</h2><p>Dockerfile ä¸­åŠ å…¥</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">USER</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure>

<p>æ‰‹å‹•æ¸¬è©¦æ™‚ä¹Ÿå¯ä»¥ç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --user=1001 ubuntu <span class="built_in">sleep</span> 3600</span><br></pre></td></tr></table></figure>

<h2 id="âœ…-ä½¿ç”¨-capabilities-é™åˆ¶æ¬Šé™"><a href="#âœ…-ä½¿ç”¨-capabilities-é™åˆ¶æ¬Šé™" class="headerlink" title="âœ… ä½¿ç”¨ capabilities &#x2F; é™åˆ¶æ¬Šé™"></a>âœ… ä½¿ç”¨ capabilities &#x2F; é™åˆ¶æ¬Šé™</h2><p>æ·»åŠ ç‰¹æ¬Šèƒ½åŠ›ï¼ˆå¦‚ MAC_ADMINï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --cap-add=MAC_ADMIN ubuntu</span><br></pre></td></tr></table></figure>

<p>ç§»é™¤æŸäº›èƒ½åŠ›ï¼ˆå¦‚ KILLï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --cap-drop=KILL ubuntu</span><br></pre></td></tr></table></figure>

<p>é–‹å•Ÿå®Œå…¨ç‰¹æ¬Šæ¨¡å¼ï¼ˆâš ï¸ æ¥µé«˜é¢¨éšªï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --privileged ubuntu</span><br></pre></td></tr></table></figure>
<blockquote>
<p>âœ… å¯¦å‹™ä¸­ï¼Œåƒ…ç•¶æ‡‰ç”¨éœ€ç‰¹æ®Šæ¬Šé™ï¼ˆå¦‚æ“ä½œç¶²è·¯ interface æˆ–ç³»çµ±å±¤è¨­å®šï¼‰æ™‚æ‰æœƒåŠ  capabilityï¼Œå¦å‰‡å»ºè­°ç›¡é‡ç²¾ç°¡</p>
</blockquote>
<hr>
<h1 id="Security-Context"><a href="#Security-Context" class="headerlink" title="Security Context"></a>Security Context</h1><h2 id="âœ…-Pod-Level-è¨­å®š"><a href="#âœ…-Pod-Level-è¨­å®š" class="headerlink" title="âœ… Pod Level è¨­å®š"></a>âœ… Pod Level è¨­å®š</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ubuntu</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">ubuntu</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;3600&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="âœ…-Container-Level-è¨­å®š"><a href="#âœ…-Container-Level-è¨­å®š" class="headerlink" title="âœ… Container Level è¨­å®š"></a>âœ… Container Level è¨­å®š</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ubuntu</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">ubuntu</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;3600&quot;</span>]</span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">capabilities:</span></span><br><span class="line">          <span class="attr">add:</span> [<span class="string">&quot;MAC_ADMIN&quot;</span>]</span><br></pre></td></tr></table></figure>
<blockquote>
<p><mark>è‹¥åœ¨ Pod èˆ‡ Container éƒ½æœ‰è¨­å®š <code>runAsUser</code>ï¼Œä»¥ Container å±¤ç´šç‚ºä¸»</mark></p>
</blockquote>
<div class="note info"><p>âš ï¸ å¸¸è¦‹éŒ¯èª¤èˆ‡å¯¦å‹™æ³¨æ„äº‹é …</p>
<ul>
<li>è‹¥å®¹å™¨ä½¿ç”¨é root ä½¿ç”¨è€…ï¼Œæ›è¼‰ volume æ™‚éœ€ç¢ºèªç›®éŒ„æ¬Šé™æ˜¯å¦èƒ½å¯«å…¥<ul>
<li>ä¾‹ï¼š<code>/data</code> ç›®éŒ„æ‡‰è¨­ç‚º UID:1000 å¯å¯«</li>
</ul>
</li>
<li>å»ºè­° base image æœ¬èº«å·²å»ºç«‹é root ä½¿ç”¨è€…<ul>
<li>ä¾‹ï¼š<code>node:slim</code>, <code>nginx:alpine</code> å¸¸å·²å…§å»º user</li>
</ul>
</li>
</ul>
<br>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">securityContext:</span></span><br><span class="line">  <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">runAsGroup:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">fsGroup:</span> <span class="number">2000</span>  <span class="comment"># âœ… æ›è¼‰ volume çš„ç¾¤çµ„æ¬Šé™è‡ªå‹•å°æ‡‰</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>fsGroup</code> å¯å”åŠ©è§£æ±º volume æ¬Šé™å•é¡Œï¼Œå°¤å…¶ç•¶å®¹å™¨é root ä¸”éœ€å¯«å…¥æ›è¼‰ç›®éŒ„æ™‚</p>
</blockquote>
</div>

<hr>
<h1 id="CKA-è€ƒé¡Œå¯èƒ½æ€éº¼å‡ºï¼Ÿ"><a href="#CKA-è€ƒé¡Œå¯èƒ½æ€éº¼å‡ºï¼Ÿ" class="headerlink" title="CKA è€ƒé¡Œå¯èƒ½æ€éº¼å‡ºï¼Ÿ"></a>CKA è€ƒé¡Œå¯èƒ½æ€éº¼å‡ºï¼Ÿ</h1><p>â˜‘ï¸ æŒ‡å®šæ˜ç¢ºçš„ image tagï¼ˆé¿å… latestï¼‰<br>â˜‘ï¸ è¨­å®šæ­£ç¢ºçš„ <code>imagePullPolicy</code><br>â˜‘ï¸ è™•ç† CrashLoopBackOffï¼ˆimage æ‹‰ä¸åˆ°ï¼‰<br>â˜‘ï¸ Pod é‹è¡Œå¤±æ•— â†’ åˆ¤æ–·æ˜¯å¦æ¬Šé™éŒ¯èª¤ï¼ˆnon-root user ç„¡æ³•å¯«å…¥ï¼‰<br>â˜‘ï¸ ä¿®æ”¹ YAMLï¼Œè¨­å®š <code>securityContext</code>ã€æŒ‡å®š userã€capabilities</p>
<blockquote>
<p>â—Dockerfile æœ¬èº«ä¸æœƒè€ƒï¼Œä½†æœƒç”¨éŒ¯èª¤çš„ YAML æ¨¡æ“¬å‡ºå•é¡Œè®“ä½  debug<br>ğŸ’¡ è‹¥ Pod CrashLoopBackOffï¼Œå¯ä½¿ç”¨ <code>kubectl logs</code> èˆ‡ <code>kubectl describe pod</code> æ­é…æ’æŸ¥</p>
</blockquote>
<hr>
<h1 id="å°çµ"><a href="#å°çµ" class="headerlink" title="å°çµ"></a>å°çµ</h1><ul>
<li>ä½¿ç”¨é root å®¹å™¨ + æ˜ç¢º image tag æ˜¯å®‰å…¨åŸºæœ¬åŸå‰‡</li>
<li>æ­é… RBAC èˆ‡ Admission Controller å¼·åŒ–æ”¿ç­–è½å¯¦</li>
<li>ç†Ÿæ‚‰ <code>securityContext</code> åœ¨ Pod&#x2F;Container ä¸åŒå±¤ç´šçš„æ•ˆæœ</li>
<li>CKA è€ƒè©¦æ›´é‡è¦–<strong>å¯¦ä½œéŒ¯èª¤æ’æŸ¥èˆ‡å®‰å…¨é…ç½®èƒ½åŠ›</strong></li>
</ul>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>CKA</tag>
        <tag>ImageSecurity</tag>
        <tag>SecurityContext</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s Security | Authorization - ClusterRoles</title>
    <url>/2025/07/09/K8s-Advanced/K8s-Security-Authorization-ClusterRoles/</url>
    <content><![CDATA[<h1 id="ClusterRoles"><a href="#ClusterRoles" class="headerlink" title="ClusterRoles"></a>ClusterRoles</h1><p><code>ClusterRole</code> å’Œ <code>ClusterRoleBinding</code> æ˜¯ <strong>Cluster Scoped è³‡æº</strong>ï¼Œä¸å±¬æ–¼ä»»ä½•å–®ä¸€ namespaceï¼Œå¯æˆæ¬Šè·¨å‘½åç©ºé–“æˆ–æ•´å€‹å¢é›†çš„è³‡æºï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><code>nodes</code>ã€<code>namespaces</code>ã€<code>clusterroles</code>ã€<code>persistentvolumes</code> ç­‰å…¨åŸŸè³‡æº</li>
<li>å¯æ­é… <code>RoleBinding</code> ä½¿ç”¨æ–¼å¤šå€‹ namespaceï¼Œé”åˆ°é‡è¤‡æˆæ¬Š</li>
</ul>
<h1 id="Namespaced-vs-Cluster-Scoped"><a href="#Namespaced-vs-Cluster-Scoped" class="headerlink" title="Namespaced vs Cluster Scoped"></a>Namespaced vs Cluster Scoped</h1><p>åœ¨ K8s ä¸­ï¼Œè³‡æºçš„ä½œç”¨ç¯„åœå¯åˆ†ç‚ºå…©å¤§é¡ï¼š<strong>Namespacedï¼ˆå‘½åç©ºé–“è³‡æºï¼‰</strong> èˆ‡ <strong>Cluster-scopedï¼ˆå¢é›†è³‡æºï¼‰</strong>ã€‚é€™å€‹å€åˆ†åœ¨è¨­å®šæ¬Šé™ï¼ˆRBACï¼‰ã€éƒ¨ç½²æ‡‰ç”¨ã€ç®¡ç†è³‡æºæ™‚éå¸¸é‡è¦ã€‚</p>
<img src="/2025/07/09/K8s-Advanced/K8s-Security-Authorization-ClusterRoles/Namespaced_ClusterScoped.jpg" class="">

<table>
<thead>
<tr>
<th>æˆæ¬Šé¡å‹</th>
<th>è³‡æºä½œç”¨ç¯„åœ</th>
<th>é©ç”¨æƒ…å¢ƒèˆ‡å¯¦ä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td><code>Role</code> &#x2F; <code>RoleBinding</code></td>
<td>å–®ä¸€ namespace</td>
<td>ä¸€èˆ¬æ‡‰ç”¨ç¨‹å¼æ¬Šé™ï¼ˆå¦‚ CRUD Podï¼‰</td>
</tr>
<tr>
<td><code>ClusterRole</code> &#x2F; <code>RoleBinding</code></td>
<td>å¤šå€‹ namespace</td>
<td>ServiceAccount è·¨å‘½åç©ºé–“æ¬Šé™</td>
</tr>
<tr>
<td><code>ClusterRole</code> &#x2F; <code>ClusterRoleBinding</code></td>
<td>å…¨å¢é›†ï¼ˆå«å…¨åŸŸè³‡æºï¼‰</td>
<td>ç®¡ç† cluster-wide è³‡æºï¼Œå¦‚ <code>nodes</code>ã€CRDs ç­‰</td>
</tr>
</tbody></table>
<blockquote>
<p>ğŸ“Œ <code>ClusterRole</code> å¯ä»¥é€é <code>RoleBinding</code> æˆæ¬Šçµ¦ç‰¹å®š namespace ä¸­çš„ä½¿ç”¨è€…æˆ– ServiceAccountã€‚<br>âœ… é€™è®“ä½ å¯ä»¥é‡è¤‡ä½¿ç”¨åŒä¸€å€‹ <code>ClusterRole</code>ï¼Œä¸¦ä»¥å¤šå€‹ <code>RoleBinding</code> æˆæ¬Šçµ¦ä¸åŒå‘½åç©ºé–“ï¼Œé¿å…é‡è¤‡å®šç¾©æ¬Šé™ã€‚</p>
</blockquote>
<h2 id="Namespaced-èˆ‡-Cluster-scoped-è³‡æºç¯„ä¾‹"><a href="#Namespaced-èˆ‡-Cluster-scoped-è³‡æºç¯„ä¾‹" class="headerlink" title="Namespaced èˆ‡ Cluster-scoped è³‡æºç¯„ä¾‹"></a>Namespaced èˆ‡ Cluster-scoped è³‡æºç¯„ä¾‹</h2><table>
<thead>
<tr>
<th>åˆ†é¡</th>
<th>èªªæ˜</th>
<th>å¸¸è¦‹è³‡æº</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Namespaced</strong></td>
<td>åƒ…å­˜åœ¨æ–¼æŸå€‹ namespaceï¼Œé©ç”¨æ–¼å¤šç§Ÿæˆ¶æˆ–è³‡æºéš”é›¢éœ€æ±‚</td>
<td><code>pods</code>ã€<code>services</code>ã€<code>configmaps</code>ã€<code>secrets</code>ã€<code>role</code>ã€<code>rolebinding</code></td>
</tr>
<tr>
<td><strong>Cluster-scoped</strong></td>
<td>ä½œç”¨æ–¼æ•´å€‹å¢é›†ï¼Œ<strong>ä¸å±¬æ–¼ä»»ä½• namespace</strong>ï¼Œå¤šç”¨æ–¼æ ¸å¿ƒç®¡ç†è³‡æº</td>
<td><code>nodes</code>ã€<code>namespaces</code>ã€<code>persistentvolumes</code>ã€<code>clusterrole</code>ã€<code>clusterrolebinding</code>ã€<code>customresourcedefinition</code></td>
</tr>
</tbody></table>
<h2 id="RBAC-èˆ‡è³‡æºç¯„åœå°æ‡‰"><a href="#RBAC-èˆ‡è³‡æºç¯„åœå°æ‡‰" class="headerlink" title="RBAC èˆ‡è³‡æºç¯„åœå°æ‡‰"></a>RBAC èˆ‡è³‡æºç¯„åœå°æ‡‰</h2><table>
<thead>
<tr>
<th>æ¬Šé™çµ„åˆ</th>
<th>é©ç”¨è³‡æºé¡å‹</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>Role</code> + <code>RoleBinding</code></td>
<td>Namespaced è³‡æº</td>
<td>ç²¾ç´°æ§åˆ¶å–®ä¸€ namespace æ¬Šé™</td>
</tr>
<tr>
<td><code>ClusterRole</code> + <code>RoleBinding</code></td>
<td>Cluster &#x2F; Namespaced</td>
<td>è·¨ namespace é‡ç”¨ ClusterRole æ¬Šé™</td>
</tr>
<tr>
<td><code>ClusterRole</code> + <code>ClusterRoleBinding</code></td>
<td>Cluster-scoped è³‡æº</td>
<td>é©ç”¨æ–¼ cluster-wide è³‡æºæˆæ¬Š</td>
</tr>
</tbody></table>
<h2 id="ç¯„ä¾‹æ¯”å°è¡¨"><a href="#ç¯„ä¾‹æ¯”å°è¡¨" class="headerlink" title="ç¯„ä¾‹æ¯”å°è¡¨"></a>ç¯„ä¾‹æ¯”å°è¡¨</h2><table>
<thead>
<tr>
<th>è³‡æº</th>
<th>ä½œç”¨ç¯„åœ</th>
<th>éœ€ä½¿ç”¨å“ªç¨®è§’è‰²æ§åˆ¶</th>
</tr>
</thead>
<tbody><tr>
<td><code>pods</code></td>
<td>Namespaced</td>
<td>Role &#x2F; RoleBinding</td>
</tr>
<tr>
<td><code>nodes</code></td>
<td>Cluster-scoped</td>
<td>ClusterRole &#x2F; ClusterRoleBinding</td>
</tr>
<tr>
<td><code>configmaps</code></td>
<td>Namespaced</td>
<td>Role</td>
</tr>
<tr>
<td><code>namespaces</code></td>
<td>Cluster-scoped</td>
<td>ClusterRole</td>
</tr>
<tr>
<td><code>secrets</code></td>
<td>Namespaced</td>
<td>Role</td>
</tr>
<tr>
<td><code>customresourcedefinitions</code></td>
<td>Cluster-scoped</td>
<td>ClusterRole</td>
</tr>
</tbody></table>
<hr>
<h1 id="å»ºç«‹èˆ‡æ“ä½œæŒ‡ä»¤"><a href="#å»ºç«‹èˆ‡æ“ä½œæŒ‡ä»¤" class="headerlink" title="å»ºç«‹èˆ‡æ“ä½œæŒ‡ä»¤"></a>å»ºç«‹èˆ‡æ“ä½œæŒ‡ä»¤</h1><h2 id="å»ºç«‹-ClusterRole"><a href="#å»ºç«‹-ClusterRole" class="headerlink" title="å»ºç«‹ ClusterRole"></a>å»ºç«‹ ClusterRole</h2><h3 id="cluster-admin-role-yaml"><a href="#cluster-admin-role-yaml" class="headerlink" title="cluster-admin-role.yaml"></a>cluster-admin-role.yaml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-administrator</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>watch</code>ï¼šç”¨æ–¼ç›£æ§è³‡æºè®ŠåŒ–ï¼Œå¸¸è¦‹æ–¼ Controller &#x2F; Operator</p>
</blockquote>
<h3 id="Kubectl-å»ºç«‹æŒ‡ä»¤"><a href="#Kubectl-å»ºç«‹æŒ‡ä»¤" class="headerlink" title="Kubectl å»ºç«‹æŒ‡ä»¤"></a>Kubectl å»ºç«‹æŒ‡ä»¤</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create -f cluster-admin-role.yaml</span><br></pre></td></tr></table></figure>

<h2 id="å»ºç«‹-ClusterRoleBinding"><a href="#å»ºç«‹-ClusterRoleBinding" class="headerlink" title="å»ºç«‹ ClusterRoleBinding"></a>å»ºç«‹ ClusterRoleBinding</h2><blockquote>
<p>âš ï¸ ä½¿ç”¨ <code>ClusterRoleBinding</code> æ™‚æœƒå½±éŸ¿æ•´å€‹å¢é›†è³‡æºï¼Œ<strong>ä¸€æ—¦æˆæ¬Šéå¯¬ï¼Œå¯èƒ½å°è‡´é‡å¤§å®‰å…¨é¢¨éšª</strong>ï¼Œè«‹å‹™å¿…å¯©æ…è©•ä¼°ã€‚<br>âœ… å¯æ­é… OPA&#x2F;Gatekeeper å¯¦æ–½ã€Œé™åˆ¶æ€§æˆæ¬Šæ”¿ç­–ã€ï¼ˆå¦‚ç¦æ­¢ * verbs æˆ– * resourcesï¼‰ã€‚<br>ğŸ’¡ <mark>è‹¥åªéœ€æˆæ¬Šç‰¹å®š namespace çš„æ¬Šé™ï¼Œè«‹å„ªå…ˆä½¿ç”¨ <code>RoleBinding + ClusterRole</code> å³å¯ã€‚</mark></p>
</blockquote>
<h3 id="cluster-admin-role-yaml-1"><a href="#cluster-admin-role-yaml-1" class="headerlink" title="cluster-admin-role.yaml"></a>cluster-admin-role.yaml</h3><p>åŒä¸Š</p>
<h3 id="cluster-admin-role-binding-yaml"><a href="#cluster-admin-role-binding-yaml" class="headerlink" title="cluster-admin-role-binding.yaml"></a>cluster-admin-role-binding.yaml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin-role-binding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-administrator</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubectl-å»ºç«‹æŒ‡ä»¤-1"><a href="#Kubectl-å»ºç«‹æŒ‡ä»¤-1" class="headerlink" title="Kubectl å»ºç«‹æŒ‡ä»¤"></a>Kubectl å»ºç«‹æŒ‡ä»¤</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create -f cluster-admin-role-binding.yaml</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="è£œå……ï¼šServiceAccount-ç¶å®šç¯„ä¾‹"><a href="#è£œå……ï¼šServiceAccount-ç¶å®šç¯„ä¾‹" class="headerlink" title="è£œå……ï¼šServiceAccount ç¶å®šç¯„ä¾‹"></a>è£œå……ï¼šServiceAccount ç¶å®šç¯„ä¾‹</h1><p>è‹¥ä½ å¸Œæœ›æŸå€‹ Pod æ‰€ä½¿ç”¨çš„ ServiceAccount æ“æœ‰è·¨ namespace çš„æ¬Šé™ï¼Œå¯ä»¥é€™æ¨£å»ºç«‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cluster-role-binding-serviceaccount.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backend-access-nodes</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">app-ns</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-administrator</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="æ¬Šé™é©—è­‰èˆ‡åµéŒ¯"><a href="#æ¬Šé™é©—è­‰èˆ‡åµéŒ¯" class="headerlink" title="æ¬Šé™é©—è­‰èˆ‡åµéŒ¯"></a>æ¬Šé™é©—è­‰èˆ‡åµéŒ¯</h1><h2 id="æŸ¥è©¢ç¾æœ‰-ClusterRole-ClusterRoleBinding"><a href="#æŸ¥è©¢ç¾æœ‰-ClusterRole-ClusterRoleBinding" class="headerlink" title="æŸ¥è©¢ç¾æœ‰ ClusterRole &#x2F; ClusterRoleBinding"></a>æŸ¥è©¢ç¾æœ‰ ClusterRole &#x2F; ClusterRoleBinding</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterroles</span><br><span class="line">kubectl get clusterrolebindings</span><br></pre></td></tr></table></figure>

<h2 id="é©—è­‰ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™"><a href="#é©—è­‰ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™" class="headerlink" title="é©—è­‰ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™"></a>é©—è­‰ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl auth can-i [verb] [resource] --as [user] --namespace [ns]</span><br><span class="line"></span><br><span class="line">kubectl auth can-i create nodes --as cluster-admin</span><br><span class="line">kubectl auth can-i get    nodes --as system:serviceaccount:app-ns:backend</span><br><span class="line"><span class="comment"># å›å‚³ &quot;yes&quot; è¡¨ç¤ºæœ‰æ¬Šé™ï¼Œ&quot;no&quot; è¡¨ç¤ºè¢«æ‹’çµ•</span></span><br></pre></td></tr></table></figure>

<h2 id="æŸ¥è©¢è³‡æºç¯„åœå±¬æ€§-ğŸ‘"><a href="#æŸ¥è©¢è³‡æºç¯„åœå±¬æ€§-ğŸ‘" class="headerlink" title="æŸ¥è©¢è³‡æºç¯„åœå±¬æ€§ ğŸ‘"></a>æŸ¥è©¢è³‡æºç¯„åœå±¬æ€§ ğŸ‘</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl api-resources --namespaced=<span class="literal">true</span>   <span class="comment"># é¡¯ç¤ºæ‰€æœ‰ namespaced è³‡æº</span></span><br><span class="line">kubectl api-resources --namespaced=<span class="literal">false</span>  <span class="comment"># é¡¯ç¤ºæ‰€æœ‰ cluster-scoped è³‡æº</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="å°çµ"><a href="#å°çµ" class="headerlink" title="å°çµ"></a>å°çµ</h1><ul>
<li><code>ClusterRole</code> é©ç”¨æ–¼æˆæ¬Šè·¨ namespace æˆ– cluster-wide è³‡æºå­˜å–ã€‚</li>
<li><code>ClusterRoleBinding</code> æ˜¯å…¨å¢é›†ç”Ÿæ•ˆï¼Œéœ€è¬¹æ…æˆæ¬Šã€‚</li>
<li>è‹¥ä½¿ç”¨è€…åªéœ€åœ¨ namespace æ“ä½œï¼Œå»ºè­°ä½¿ç”¨ <code>RoleBinding + ClusterRole</code>ã€‚</li>
<li>è‹¥æœ‰è·¨ namespace éœ€æ±‚ï¼š<ul>
<li><code>ClusterRole + RoleBinding</code>ï¼šé©ç”¨æ–¼ <code>è·¨ namespace</code> é‡è¤‡æˆæ¬Šç›¸åŒæ¬Šé™</li>
<li><code>ClusterRole + ClusterRoleBinding</code>ï¼ˆçµ±ä¸€æˆæ¬Šå…¨åŸŸè³‡æºï¼‰ï¼šé©ç”¨æ–¼éœ€è¦ <code>å…¨å¢é›†è³‡æºæ§åˆ¶çš„ç®¡ç†è€…</code></li>
</ul>
</li>
<li>å¸¸æ­é… <code>kubectl auth can-i</code> æŒ‡ä»¤é©—è­‰æ¬Šé™ï¼Œé¿å…æˆæ¬ŠéŒ¯èª¤ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>ClusterRoles</tag>
        <tag>ClusterRoleBinding</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s | Cluster Maintenance</title>
    <url>/2025/06/13/K8s-Advanced/K8s-Cluster-Maintenance/</url>
    <content><![CDATA[<h1 id="OS-Upgrades"><a href="#OS-Upgrades" class="headerlink" title="OS Upgrades"></a>OS Upgrades</h1><h2 id="é‡è¦æŒ‡ä»¤"><a href="#é‡è¦æŒ‡ä»¤" class="headerlink" title="é‡è¦æŒ‡ä»¤"></a>é‡è¦æŒ‡ä»¤</h2><h3 id="kubectl-drain"><a href="#kubectl-drain" class="headerlink" title="kubectl drain &lt;NODE_NAME&gt;"></a>kubectl drain &lt;NODE_NAME&gt;</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl drain node01 --ignore-daemonsets</span><br></pre></td></tr></table></figure>
<p>å°‡ K8s Cluster ä¸­çš„ node01 ç¯€é»é€²è¡Œã€Œæ’ç©ºã€æ“ä½œï¼Œä¹Ÿå°±æ˜¯æŠŠ node01 ä¸Šçš„ Pod (æ‰€æœ‰é DaemonSet çš„ Pod) ç§»é–‹æˆ–åˆªé™¤ï¼Œä»¥ä¾¿é€²è¡Œç¶­è­·æˆ–æ›´æ–°ã€‚</p>
<details class="note default"><summary><p>è£œå……èªªæ˜ï¼škubectl drain</p>
</summary>
<p><mark>é è¨­æœƒåšä»€éº¼ï¼Ÿ</mark></p>
<ol>
<li>å°‡ç¯€é»æ¨™è¨˜ç‚º unschedulableï¼š<ul>
<li>ç›¸ç•¶æ–¼åŸ·è¡Œ <code>kubectl cordon node01</code></li>
<li>è¡¨ç¤ºæ–°çš„ Pod ä¸æœƒå†è¢«æ’ç¨‹åˆ°é€™å€‹ node ä¸Š</li>
</ul>
</li>
<li>é©…é€(åˆªé™¤) old node ä¸Šçš„é DaemonSet Podï¼š<ul>
<li>å°‡é€™äº› Pod æ¨™è¨˜ç‚º Evictedï¼Œä¸¦ç”±å…¶ Controllerï¼ˆå¦‚ Deploymentã€StatefulSetï¼‰è‡ªå‹•åœ¨å…¶ä»–ç¯€é»é‡æ–°éƒ¨ç½²</li>
</ul>
</li>
<li>ä¸è™•ç†ä»¥ä¸‹ Pod é¡å‹ (é™¤éåŠ å…¥é¡å¤–åƒæ•¸)ï¼š<ul>
<li>DaemonSet Pod (é™¤éåŠ å…¥ â€“delete-emptydir-data)</li>
<li>Mirror Pod (éœæ…‹ Pod)</li>
<li>Unmanaged Podï¼ˆæ²’æœ‰ controllerï¼Œä¾‹å¦‚æœªç”± ReplicaSet ç®¡ç†çš„ Podï¼‰</li>
</ul>
</li>
</ol>
<p><mark>ç›¸é—œè£œå……ï¼š</mark></p>
<ol>
<li><code>--grace-period=SECONDS</code>ï¼ˆPod å„ªé›…çµ‚æ­¢æ™‚é–“ï¼‰<ul>
<li>å½±éŸ¿å–®ä¸€ Pod è¢«åˆªé™¤å‰ç­‰å¾…å¤šä¹…è®“å…¶å„ªé›…çµ‚æ­¢ï¼ˆåŸ·è¡Œæ¸…ç†é‚è¼¯ï¼‰ã€‚</li>
<li>é è¨­å€¼ï¼šä¾†è‡ª Pod çš„ terminationGracePeriodSecondsï¼ˆé€šå¸¸ç‚º 30 ç§’ï¼‰ã€‚</li>
<li>âœ… å¯é€é <code>kubectl drain node01 --grace-period=10</code> æŒ‡å®šã€‚</li>
</ul>
</li>
<li><code>--pod-eviction-timeout=TIME</code>ï¼ˆç¯€é»å¤±æ•ˆæ™‚çš„é©…é€ç­‰å¾…æ™‚é–“ï¼‰<ul>
<li>æ˜¯ kube-controller-manager çš„åƒæ•¸ï¼Œæ§åˆ¶ç•¶ç¯€é» NotReady æˆ– Unreachable æ™‚ï¼ŒK8s ç­‰å¤šä¹…æ‰æœƒé©…é€è©² node ä¸Šçš„ Podã€‚</li>
<li>é è¨­å€¼ï¼š5 åˆ†é˜ã€‚</li>
<li>âœ… åƒ…åœ¨ç¯€é»ç•°å¸¸ï¼ˆè‡ªå‹•é©…é€ï¼‰æ™‚ç”Ÿæ•ˆï¼Œèˆ‡ kubectl drain ç„¡é—œã€‚</li>
</ul>
</li>
</ol>
<p><mark>å¸¸è¦‹ç”¨é€”ï¼š</mark></p>
<ol>
<li>ç¯€é»ç¶­ä¿®ï¼ˆç¡¬é«”æ›´æ›ã€OS å‡ç´šï¼‰</li>
<li>å®‰å…¨æ€§ä¿®è£œï¼ˆPatchingï¼‰</li>
<li>ç¯€é»é—œæ©Ÿæˆ–é‡å•Ÿ</li>
<li>æ»¾å‹•æ›´æ–° OS æˆ– kubelet</li>
</ol>

</details>

<h3 id="kubectl-cordon"><a href="#kubectl-cordon" class="headerlink" title="kubectl cordon &lt;NODE_NAME&gt;"></a>kubectl cordon &lt;NODE_NAME&gt;</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl cordon node02</span><br></pre></td></tr></table></figure>
<p>å°‡ node02 æ¨™è¨˜ç‚º unschedulable (åªå°é–æ’ç¨‹)ï¼Œä¸ç§»é™¤ä»»ä½• Podã€‚</p>
<details class="note default"><summary><p>è£œå……èªªæ˜ï¼škubectl cordon</p>
</summary>
<p><mark>ä½¿ç”¨æƒ…å¢ƒï¼š</mark></p>
<ul>
<li>ç•¶ä½ åªæƒ³åœæ­¢æ–°çš„ Pod è¢«å®‰æ’åˆ°æ­¤ nodeï¼Œä½†ä¸æƒ³é©…é€ç›®å‰ node ä¸Šçš„ Pod æ™‚ã€‚</li>
</ul>

</details>

<h3 id="kubectl-uncordon"><a href="#kubectl-uncordon" class="headerlink" title="kubectl uncordon &lt;NODE_NAME&gt;"></a>kubectl uncordon &lt;NODE_NAME&gt;</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl uncordon node01</span><br></pre></td></tr></table></figure>
<p>è§£é™¤ node å°é– (æ¢å¾©å¯èª¿åº¦ç‹€æ…‹)ï¼Œå…è¨±æ’ç¨‹ (æ–°çš„ Pod è¢« schedule åˆ° node ä¸Š)ã€‚</p>
<details class="note default"><summary><p>è£œå……èªªæ˜ï¼škubectl uncordon</p>
</summary>
<p><mark>ä½¿ç”¨æƒ…å¢ƒï¼š</mark></p>
<ul>
<li>ä½ å·²ç¶“å®Œæˆ node01 çš„ç¶­è­·ä½œæ¥­ (ä¾‹å¦‚ç³»çµ±æ›´æ–°ã€é‡å•Ÿã€ç¡¬é«”ä¿®å¾©)ã€‚ä½ æƒ³è¦è®“ node01 æ¢å¾©æ­£å¸¸èª¿åº¦æ™‚ã€‚</li>
</ul>

</details>

<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><div class="note info"><p><strong>èƒŒæ™¯çŸ¥è­˜ï¼š</strong></p>
<ol>
<li><em>ç•¶ä½ ä½¿ç”¨ <code>kubectl drain node01</code> æ’ç©º node æ™‚ï¼Œå®ƒæœƒåŒæ™‚æŠŠ node æ¨™è¨˜ç‚ºä¸å¯èª¿åº¦ï¼ˆunschedulableï¼‰ï¼Œä»¥é¿å…æœ‰æ–° Pod è¢«åˆ†æ´¾è‡³è©²æ©Ÿå™¨ã€‚</em></li>
<li><em>ä½¿ç”¨ uncordon å‰‡æ˜¯ã€Œæ¢å¾©èª¿åº¦ã€åŠŸèƒ½ï¼Œè®“ node å¯ä»¥å†æ¬¡æ‰¿æ“”æ–°çš„ Pod æ’ç¨‹ä»»å‹™ã€‚</em></li>
</ol>
<p><strong>ç¸½çµï¼š</strong></p>
<ul>
<li><code>kubectl drain</code> &#x3D; å°é–æ’ç¨‹ + é©…é€é DaemonSet Pod</li>
<li><code>kubectl cordon</code> &#x3D; åƒ…å°é–æ’ç¨‹ï¼Œä¸ç§»å‹• Pod</li>
<li><code>kubectl uncordon</code> &#x3D; æ¢å¾©æ’ç¨‹åŠŸèƒ½</li>
</ul>
<p><strong>å»ºè­°æ­é…ä¸‹é¢æŒ‡ä»¤è§€å¯Ÿç¯€é»ç‹€æ…‹ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get nodes -o wide</span><br><span class="line">kubectl describe node node01</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ Kubernetes ä¸­é€²è¡Œ OS å‡ç´šï¼ˆä¾‹å¦‚ Ubuntuã€CentOSã€RHELã€Amazon Linux ç­‰ï¼‰æ™‚ï¼Œç‚ºäº†æœ€å°åŒ–æœå‹™ä¸­æ–·ï¼Œå»ºè­°æ¡å– <strong>æ»¾å‹•å‡ç´šï¼ˆRolling Upgradeï¼‰</strong> ç­–ç•¥ï¼Œç¢ºä¿é›†ç¾¤æŒçºŒå¯ç”¨ã€‚</p>
<ol>
<li>å‡ç´šå‰æº–å‚™<ul>
<li>æª¢æŸ¥ç¯€é»ç‹€æ…‹<br><code>kubectl get nodes -o wide</code></li>
<li>æ¨™è¨˜ç¯€é»ç‚ºä¸å¯èª¿åº¦ï¼ˆé˜²æ­¢æ–° Pod è¢«æ’åˆ°é€™å°æ©Ÿå™¨ï¼‰<br><code>kubectl cordon &lt;NODE_NAME&gt;</code></li>
<li>æ’ç©ºç¯€é»ï¼ˆç§»é™¤ç¾æœ‰ Podï¼‰<br><code>kubectl drain &lt;NODE_NAME&gt; --ignore-daemonsets --delete-emptydir-data</code><blockquote>
<p>â€“ignore-daemonsetsï¼šä¿ç•™ DaemonSet pod<br>â€“delete-emptydir-dataï¼šå…è¨±åˆªé™¤ä½¿ç”¨ emptyDir çš„ Pod</p>
</blockquote>
</li>
</ul>
</li>
<li>å‡ç´šä½œæ¥­ç³»çµ±<ul>
<li>Ubuntu ç¯„ä¾‹<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>é‡å•Ÿå¾Œé©—è­‰èˆ‡é‡æ–°åŠ å…¥ç¯€é»<ul>
<li>é©—è­‰ç¯€é»ç‹€æ…‹ï¼šç¯€é»æ‡‰è©²æœƒå¾ NotReady å›åˆ° Ready ç‹€æ…‹ã€‚<br><code>kubectl get nodes</code></li>
<li>å…è¨±æ’ç¨‹å›è©²ç¯€é»<br><code>kubectl uncordon &lt;NODE_NAME&gt;</code></li>
</ul>
</li>
<li>é‡å°å…¶ä»–ç¯€é»é‡è¤‡æ­¤æµç¨‹<ul>
<li>å»ºè­°ä¾åºé€²è¡Œæ¯å€‹ç¯€é»ï¼Œç¢ºä¿ç³»çµ±èˆ‡æœå‹™ä¸ä¸­æ–·ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h1 id="K8s-Releases"><a href="#K8s-Releases" class="headerlink" title="K8s Releases"></a>K8s Releases</h1><h2 id="é‡è¦æŒ‡ä»¤-1"><a href="#é‡è¦æŒ‡ä»¤-1" class="headerlink" title="é‡è¦æŒ‡ä»¤"></a>é‡è¦æŒ‡ä»¤</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<h2 id="ç‰ˆæœ¬è§£æ"><a href="#ç‰ˆæœ¬è§£æ" class="headerlink" title="ç‰ˆæœ¬è§£æ"></a>ç‰ˆæœ¬è§£æ</h2><blockquote>
<p><a href="https://github.com/kubernetes/kubernetes/releases">Kubernetes&#x2F;releases</a></p>
</blockquote>
<p>v1.11.3</p>
<ul>
<li>v1: Major (é‡å¤§æ¶æ§‹è®Šå‹•ï¼Œæ¥µå°‘è®Šå‹•)</li>
<li>11: Minor (Features, Functionalities)</li>
<li>3:  Patch (Bug Fixes)</li>
</ul>
<h2 id="K8s-component-å‡ç´šç­–ç•¥-â€“-ç‰ˆæœ¬é¸æ“‡"><a href="#K8s-component-å‡ç´šç­–ç•¥-â€“-ç‰ˆæœ¬é¸æ“‡" class="headerlink" title="K8s component å‡ç´šç­–ç•¥ â€“ ç‰ˆæœ¬é¸æ“‡"></a>K8s component å‡ç´šç­–ç•¥ â€“ ç‰ˆæœ¬é¸æ“‡</h2><p><mark>kubeadm çš„ç‰ˆæœ¬å¿…é ˆã€Œç­‰æ–¼æˆ–é«˜æ–¼ã€ä½ è¦å‡ç´šçš„ Kubernetes cluster ç‰ˆæœ¬</mark><br><mark>Kubernetes å®˜æ–¹åƒ…æ”¯æ´ <code>æœ€è¿‘ä¸‰å€‹ã€ŒMinorã€ç‰ˆæœ¬</code>ï¼ˆNã€N-1ã€N-2ï¼‰</mark></p>
<table>
<thead>
<tr>
<th>æœ€æ–°ç‰ˆæœ¬ï¼ˆNï¼‰</th>
<th>åŒæ™‚æ”¯æ´çš„ç‰ˆæœ¬</th>
</tr>
</thead>
<tbody><tr>
<td>v1.30</td>
<td>v1.30, v1.29, v1.28</td>
</tr>
<tr>
<td>v1.29</td>
<td>v1.29, v1.28, v1.27</td>
</tr>
</tbody></table>
<p>ä¹Ÿå°±æ˜¯èªªï¼š</p>
<ul>
<li><mark>åªæœ‰æœ€è¿‘ä¸‰å€‹ minor ç‰ˆæœ¬æœƒç²å¾—å®˜æ–¹çš„ patch æ›´æ–°èˆ‡å®‰å…¨ä¿®å¾©ã€‚</mark></li>
<li>æ¯å€‹ç‰ˆæœ¬çš„æ”¯æ´é€±æœŸç´„ç‚º 1 å¹´ï¼ˆæ¯å€‹ç‰ˆæœ¬ç´„æ¯ 3~4 å€‹æœˆç™¼ä½ˆä¸€æ¬¡ï¼‰ã€‚</li>
</ul>
<div class="note info"><p>ETCD CLUSTER</p>
<ul>
<li>é€šå¸¸ç”± kubeadm upgrade ç®¡ç†ï¼Œæ”¯æ´å‡ç´šå‰å‚™ä»½</li>
<li>ç‰ˆæœ¬ä¸èƒ½è·³å¤ªå¤šï¼Œæ‡‰æŸ¥é–±å®˜æ–¹ <a href="https://etcd.io/docs/v3.6/upgrades/">etcd å‡ç´šæŒ‡å—</a></li>
</ul>
<p>CoreDNS</p>
<ul>
<li>å‡ç´šéç¨‹ä¸­ kubeadm æœƒæç¤ºæ˜¯å¦å‡ç´š</li>
<li>ä½¿ç”¨è€…éœ€æ‰‹å‹•ç¢ºèªæ˜¯å¦å‡ç´š</li>
</ul>
<p>Kubernetes å…ƒä»¶ç‰ˆæœ¬ç›¸å®¹æ€§ (ä»¥ kube-apiserver ç‰ˆæœ¬ç‚ºæº–ï¼ŒX &#x3D; v1.10)</p>
<table>
<thead>
<tr>
<th>å…ƒä»¶</th>
<th>å»ºè­°ç‰ˆæœ¬ç¯„åœ</th>
</tr>
</thead>
<tbody><tr>
<td>Controller-managerã€kube-scheduler</td>
<td>X æˆ– X-1ï¼ˆä¾‹ï¼šv1.9 æˆ– v1.10ï¼‰</td>
</tr>
<tr>
<td>kubeletã€kube-proxy</td>
<td>Xã€X-1ã€X-2ï¼ˆä¾‹ï¼šv1.8 æˆ– v1.9 æˆ– v1.10ï¼‰</td>
</tr>
<tr>
<td>kubectl</td>
<td>X-1ã€Xã€X+1ï¼ˆä¾‹ï¼šv1.9 æˆ– v1.10 æˆ– v1.11ï¼‰</td>
</tr>
</tbody></table>
</div>

<hr>
<h1 id="Cluster-Upgrade-Process"><a href="#Cluster-Upgrade-Process" class="headerlink" title="Cluster Upgrade Process"></a>Cluster Upgrade Process</h1><p>åœ¨ Kubernetes çš„å‡ç´šæµç¨‹ä¸­ï¼Œæ‡‰è©²å…ˆå¾ Control Planeï¼ˆmaster ç¯€é»ï¼‰é–‹å§‹å‡ç´šï¼Œå†å‡ç´š worker ç¯€é»ã€‚</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">Docs: Upgrading control plane nodes</a></li>
<li><a href="https://v1-32.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/upgrading-linux-nodes/">Docs: Upgrading worker nodes</a></li>
</ul>
<p><mark>åœ¨ Kubernetes ä¸­ï¼Œå‡ç´šï¼ˆUpgradeï¼‰æ˜¯å–®å‘çš„æµç¨‹ï¼Œä¸€æ—¦å‡ç´šå®Œæˆå°± âš ï¸ ç„¡æ³•ç›´æ¥é™ç‰ˆï¼ˆDowngradeï¼‰ã€‚</mark></p>
<h2 id="é‡è¦æŒ‡ä»¤-2"><a href="#é‡è¦æŒ‡ä»¤-2" class="headerlink" title="é‡è¦æŒ‡ä»¤"></a>é‡è¦æŒ‡ä»¤</h2><h3 id="kubectl-get-nodes"><a href="#kubectl-get-nodes" class="headerlink" title="kubectl get nodes"></a>kubectl get nodes</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>
<p>Get current version of the cluster.</p>
<h3 id="kubeadm-upgrade-plan"><a href="#kubeadm-upgrade-plan" class="headerlink" title="kubeadm upgrade plan"></a>kubeadm upgrade plan</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubeadm upgrade plan</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ç›®å‰å‡ç´šè¨ˆç•«<br>å¯çŸ¥ Cluster versionã€kubeadm versionã€Latest stable version â€¦</p>
<h3 id="kubeadm-upgrade-apply"><a href="#kubeadm-upgrade-apply" class="headerlink" title="kubeadm upgrade apply"></a>kubeadm upgrade apply</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubeadm upgrade apply</span><br></pre></td></tr></table></figure>
<p>åŸ·è¡Œå‡ç´šï¼Œå‡ç´š Control Plane ç¯€é»ï¼ˆåªåš masterï¼‰</p>
<h2 id="âœ…-å‡ç´šé †åº"><a href="#âœ…-å‡ç´šé †åº" class="headerlink" title="âœ… å‡ç´šé †åº"></a>âœ… å‡ç´šé †åº</h2><ol>
<li><a href="https://v1-32.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">å‡ç´š Control Planeï¼ˆMasterï¼‰ç¯€é»</a><ul>
<li>åŒ…æ‹¬ kube-apiserverã€controller-managerã€schedulerã€etcd<br> Step 0ï¼šå‰ç½®æª¢æŸ¥ <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl version</span><br><span class="line">kubeadm version</span><br><span class="line">vim /etc/apt/sources.list.d/kubernetes.list</span><br></pre></td></tr></table></figure>
 Step 1ï¼šå‡ç´š kubeadm å·¥å…·ï¼ˆæœ¬æ©Ÿï¼‰ <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–° apt ç´¢å¼•</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># åˆ—å‡ºä½ ç›®å‰ç³»çµ±å¾ apt å¥—ä»¶ä¾†æºå¯ä»¥æŠ“åˆ°çš„æ‰€æœ‰ kubeadm ç‰ˆæœ¬</span></span><br><span class="line">sudo apt-cache madison kubeadm</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£æŒ‡å®šç‰ˆæœ¬ kubeadm</span></span><br><span class="line">sudo apt-get install -y kubeadm=<span class="string">&#x27;1.32.0-1.1&#x27;</span></span><br></pre></td></tr></table></figure>
 Step 2ï¼šæ¨¡æ“¬å‡ç´šè¨ˆç•« (é è¦½) + å¥—ç”¨å‡ç´š  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubeadm upgrade plan</span><br><span class="line">kubeadm upgrade apply v1.32.0</span><br></pre></td></tr></table></figure>
 Step 3ï¼šå‡ç´š kubelet èˆ‡ kubectl <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y kubelet=<span class="string">&#x27;1.32.0-1.1&#x27;</span> kubectl=<span class="string">&#x27;1.32.0-1.1&#x27;</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure>
 Step 4ï¼šVerify the status of the cluster <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><a href="https://v1-32.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/upgrading-linux-nodes/">å‡ç´š Worker ç¯€é»</a><ul>
<li>åŒ…æ‹¬ kubeletã€kube-proxyã€OS<br> Step 0ï¼šæ’ç©ºç¯€é» (Drain) <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl drain &lt;worker-node&gt; --ignore-daemonsets</span><br></pre></td></tr></table></figure>
 Step 1ï¼šé€²å…¥è©² Worker ç¯€é»ï¼Œå‡ç´š kubeadm å·¥å…· <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh node01</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¢ºä¿ä¾†æºæ­£ç¢ºï¼ˆåªéœ€è¨­å®šä¸€æ¬¡ï¼‰</span></span><br><span class="line">vim /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°å¥—ä»¶è³‡è¨Šä¸¦å®‰è£ kubeadm v1.32.0</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y kubeadm=<span class="string">&#x27;1.32.0-1.1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥å¯¦éš›ç‰ˆæœ¬</span></span><br><span class="line">apt-cache madison kubeadm</span><br></pre></td></tr></table></figure>
 Step 2ï¼šå‡ç´š kubeadm<br> å°æ–¼ Worker ç¯€é»ï¼Œåªéœ€è¦é€™å€‹å‘½ä»¤å³å¯ï¼ˆä¸éœ€ applyï¼Œé‚£æ˜¯ Control Plane ç”¨çš„ï¼‰ <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo kubeadm upgrade node</span><br></pre></td></tr></table></figure>
 Step 3ï¼šå‡ç´š kubelet èˆ‡ kubectl ä¸¦é‡å•Ÿæœå‹™ <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y kubelet=<span class="string">&#x27;1.32.0-1.1&#x27;</span> kubectl=<span class="string">&#x27;1.32.0-1.1&#x27;</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart kubelet</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
 Step 4ï¼šVerify the status of the cluster (on Control Plane node) <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>
 Step 5ï¼šå–æ¶ˆæ’ç©º (Uncordon) <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl uncordon &lt;worker-node&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<div class="note info"><p><strong>ç‚ºä»€éº¼è¦å…ˆå‡ç´š Control Planeï¼Ÿ</strong></p>
<ul>
<li>Control Plane æ±ºå®š Cluster API è¡Œç‚ºèˆ‡ç‰ˆæœ¬é‚è¼¯ï¼Œæ‰€æœ‰ worker ç¯€é»éƒ½å¿…é ˆèˆ‡ apiserver ç›¸å®¹ã€‚</li>
<li>worker ç¯€é»å…è¨±è½å¾Œæœ€å¤š 2 å€‹ç‰ˆæœ¬ï¼ˆX-2ï¼‰ï¼Œä½† Control Plane é€šå¸¸ä¸èƒ½è½å¾Œ workerã€‚</li>
<li>å…ˆå‡ç´š worker å¯èƒ½å°è‡´ä¸ç›¸å®¹çš„ kubelet ç‰ˆæœ¬ â†’ apiserver æ‹’çµ•é€šä¿¡ã€‚</li>
</ul>
<p><strong>å¯¦å‹™æ³¨æ„äº‹é …</strong></p>
<ul>
<li>å¤šå€‹ master ç¯€é»æ™‚ï¼Œ<code>ä¸€å°ä¸€å°å‡ç´š</code>ï¼Œå¯ä¿æŒ HAï¼ˆé«˜å¯ç”¨ï¼‰ä¸ä¸­æ–·ã€‚</li>
<li>å¯é€é kubectl get nodes æª¢æŸ¥ç‰ˆæœ¬ï¼Œæ­é… kubeadm upgrade plan ä¾†è¦åŠƒå‡ç´šè·¯ç·šã€‚</li>
<li>å‡ç´šå‰ <code>å‚™ä»½ etcd</code> æ˜¯å¾ˆå¥½çš„ä¿éšªæªæ–½ã€‚</li>
</ul>
</div>

<h2 id="Upgrade-Strategy-3-ç¨®æ–¹å¼"><a href="#Upgrade-Strategy-3-ç¨®æ–¹å¼" class="headerlink" title="Upgrade Strategy (3 ç¨®æ–¹å¼)"></a>Upgrade Strategy (3 ç¨®æ–¹å¼)</h2><ol>
<li>ä¸€æ¬¡å‡ç´šæ‰€æœ‰ç¯€é»ï¼ˆæœƒåœæ©Ÿï¼‰<ul>
<li>é©åˆæƒ…å¢ƒï¼šæ¸¬è©¦ç’°å¢ƒã€éé«˜å¯ç”¨æ¶æ§‹</li>
<li>å„ªé»ï¼šå¿«é€Ÿç°¡å–®</li>
<li>ç¼ºé»ï¼šæœå‹™åœæ©Ÿ</li>
</ul>
</li>
<li>è¼ªæµå‡ç´šç¾æœ‰ç¯€é» (ä¸ä¸­æ–·æœå‹™)<blockquote>
<p>ä¸€å€‹ Upgrade å®Œï¼Œå†æ›ä¸‹ä¸€å€‹ Upgrade (æ²’æœ‰æ–°å¢ nodeï¼Œç›´æ¥ç”¨ç¾æœ‰çš„ node é€²è¡Œ)</p>
</blockquote>
<ul>
<li>é©åˆæƒ…å¢ƒï¼šå°è¦æ¨¡ã€å¯æ¥å—ç¨å¾®æ³¢å‹•</li>
<li>å„ªé»ï¼šä¸éœ€æ“´å®¹</li>
<li>ç¼ºé»ï¼šå‡ç´šæœŸé–“æœ‰å£“åŠ›</li>
</ul>
</li>
<li>æ–°ç¯€é»æ¥æ‰‹ã€ç§»é™¤èˆŠç¯€é» (å…ˆåŠ æ–°ç¯€é»å‡ç´š â†’ ç§»å‹•æ‡‰ç”¨ â†’ ç§»é™¤èˆŠç¯€é»)<blockquote>
<p>å…ˆæ–°å¢ä¸€å€‹ Upgrade å¾Œçš„ nodeï¼ŒæŠŠ application æ”¾åˆ°è©² Upgrade å¾Œçš„ node ä¸Šé‹è¡Œï¼Œå†æŠŠèˆŠ node ç æ‰ (æœ‰æ–°å¢ node)</p>
</blockquote>
<ul>
<li>é©åˆæƒ…å¢ƒï¼šå¤§å‹ä¼æ¥­ã€é«˜å¯ç”¨è¦æ±‚</li>
<li>å„ªé»ï¼šç„¡ä¸­æ–·ã€å¯æ¸¬è©¦æ–°ç¯€é»</li>
<li>ç¼ºé»ï¼šæˆæœ¬è¼ƒé«˜ã€éœ€å‚™æ´è³‡æº</li>
</ul>
</li>
</ol>
<hr>
<h1 id="Backup-and-Restore"><a href="#Backup-and-Restore" class="headerlink" title="Backup and Restore"></a>Backup and Restore</h1><ul>
<li>Backup ç¯„åœ<ul>
<li>Resource Configurationï¼šæ‰€æœ‰ K8s è³‡æºè¨­å®šæª”ï¼ˆDeploymentã€Serviceã€Secretsï¼‰</li>
<li>ETCD Clusterï¼šå„²å­˜æ•´å€‹ Cluster ç‹€æ…‹ï¼ˆcontrol plane source of truthï¼‰</li>
<li>Persistent Volumesï¼šPV&#x2F;PVCï¼ˆå–æ±ºæ–¼æ˜¯å¦ä½¿ç”¨æ”¯æ´ snapshot çš„ StorageClassï¼‰</li>
</ul>
</li>
</ul>
<h2 id="é‡è¦æŒ‡ä»¤-3"><a href="#é‡è¦æŒ‡ä»¤-3" class="headerlink" title="é‡è¦æŒ‡ä»¤"></a>é‡è¦æŒ‡ä»¤</h2><h3 id="Backup-Resource-Configuration"><a href="#Backup-Resource-Configuration" class="headerlink" title="Backup - Resource Configuration"></a>Backup - Resource Configuration</h3><h4 id="âœ…-Imperative-å»ºç«‹è³‡æº"><a href="#âœ…-Imperative-å»ºç«‹è³‡æº" class="headerlink" title="âœ… Imperative å»ºç«‹è³‡æº"></a>âœ… Imperative å»ºç«‹è³‡æº</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl create namespace &lt;name&gt;</span><br><span class="line"></span><br><span class="line">kubectl create secret generic &lt;name&gt; --from-literal=password=mypassword</span><br><span class="line"></span><br><span class="line">kubectl create configmap &lt;name&gt; --from-literal=key=value</span><br></pre></td></tr></table></figure>

<h4 id="âœ…-Declarative-å»ºç«‹è³‡æº"><a href="#âœ…-Declarative-å»ºç«‹è³‡æº" class="headerlink" title="âœ… Declarative å»ºç«‹è³‡æº"></a>âœ… Declarative å»ºç«‹è³‡æº</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pod-definition.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply â€“f pod-definition.yml</span><br></pre></td></tr></table></figure>

<h4 id="âœ…-å°‡æ‰€æœ‰è³‡æºåŒ¯å‡ºæˆ-YAML-ğŸŒŸ"><a href="#âœ…-å°‡æ‰€æœ‰è³‡æºåŒ¯å‡ºæˆ-YAML-ğŸŒŸ" class="headerlink" title="âœ… å°‡æ‰€æœ‰è³‡æºåŒ¯å‡ºæˆ YAML ğŸŒŸ"></a>âœ… å°‡æ‰€æœ‰è³‡æºåŒ¯å‡ºæˆ YAML ğŸŒŸ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get all --all-namespaces -o yaml &gt; all-resources.yaml</span><br><span class="line">kubectl get configmap,secret --all-namespaces -o yaml &gt; config-secret.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è£œå……ï¼šä¹Ÿå¯ä»¥é€ä¸€å‚™ä»½å„è³‡æºç¨®é¡</span></span><br><span class="line">kubectl get deployments.apps --all-namespaces -o yaml &gt; deployments.yaml</span><br><span class="line">kubectl get svc --all-namespaces -o yaml &gt; services.yaml</span><br></pre></td></tr></table></figure>

<h3 id="Backup-ETCD-ETCD-Cluster-Snapshot"><a href="#Backup-ETCD-ETCD-Cluster-Snapshot" class="headerlink" title="Backup - ETCD (ETCD Cluster) Snapshot"></a>Backup - ETCD (ETCD Cluster) Snapshot</h3><h4 id="âœ…-æ–¹å¼ä¸€ï¼šä½¿ç”¨-etcdctlï¼ˆSnapshot-based-Backupï¼Œæ¨è–¦ï¼‰ğŸŒŸ"><a href="#âœ…-æ–¹å¼ä¸€ï¼šä½¿ç”¨-etcdctlï¼ˆSnapshot-based-Backupï¼Œæ¨è–¦ï¼‰ğŸŒŸ" class="headerlink" title="âœ… æ–¹å¼ä¸€ï¼šä½¿ç”¨ etcdctlï¼ˆSnapshot-based Backupï¼Œæ¨è–¦ï¼‰ğŸŒŸ"></a>âœ… æ–¹å¼ä¸€ï¼šä½¿ç”¨ etcdctlï¼ˆSnapshot-based Backupï¼Œæ¨è–¦ï¼‰ğŸŒŸ</h4><blockquote>
<p>To take a snapshot from a running etcd server</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl \</span><br><span class="line">  --endpoints=https://127.0.0.1:2379 \</span><br><span class="line">  --cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">  --cert=/etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">  --key=/etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">  snapshot save /backup/etcd-snapshot.db</span><br></pre></td></tr></table></figure>

<p>ç¯„ä¾‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe pod etcd-controlplane -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Command:</span></span><br><span class="line"><span class="comment">#       etcd</span></span><br><span class="line"><span class="comment">#       --advertise-client-urls=https://192.168.42.128:2379</span></span><br><span class="line"><span class="comment"># V     --cert-file=/etc/kubernetes/pki/etcd/server.crt</span></span><br><span class="line"><span class="comment">#       --client-cert-auth=true</span></span><br><span class="line"><span class="comment">#       --data-dir=/var/lib/etcd</span></span><br><span class="line"><span class="comment">#       --experimental-initial-corrupt-check=true</span></span><br><span class="line"><span class="comment">#       --experimental-watch-progress-notify-interval=5s</span></span><br><span class="line"><span class="comment">#       --initial-advertise-peer-urls=https://192.168.42.128:2380</span></span><br><span class="line"><span class="comment">#       --initial-cluster=controlplane=https://192.168.42.128:2380</span></span><br><span class="line"><span class="comment"># V     --key-file=/etc/kubernetes/pki/etcd/server.key</span></span><br><span class="line"><span class="comment">#       --listen-client-urls=https://127.0.0.1:2379,https://192.168.42.128:2379</span></span><br><span class="line"><span class="comment">#       --listen-metrics-urls=http://127.0.0.1:2381</span></span><br><span class="line"><span class="comment">#       --listen-peer-urls=https://192.168.42.128:2380</span></span><br><span class="line"><span class="comment">#       --name=controlplane</span></span><br><span class="line"><span class="comment">#       --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt</span></span><br><span class="line"><span class="comment">#       --peer-client-cert-auth=true</span></span><br><span class="line"><span class="comment">#       --peer-key-file=/etc/kubernetes/pki/etcd/peer.key</span></span><br><span class="line"><span class="comment">#       --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line"><span class="comment">#       --snapshot-count=10000</span></span><br><span class="line"><span class="comment"># V     --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line"></span><br><span class="line">ETCDCTL_API=3 etcdctl \</span><br><span class="line">  snapshot save /opt/snapshot-pre-boot.db \</span><br><span class="line">  --cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">  --cert /etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">  --key /etc/kubernetes/pki/etcd/server.key</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--endpoints</code>: Optional Flag, points to the address where ETCD is running (127.0.0.1:2379)</li>
<li><code>--cacert</code> Mandatory Flag (Absolute Path to the CA certificate file)</li>
<li><code>--cert</code> pMandatory Flag (Absolute Path to the Server certificate file)</li>
<li><code>--key</code> Mandatory Flag (Absolute Path to the Key file)</li>
</ul>
<p>ç¢ºèªå¿«ç…§ç‹€æ…‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl snapshot status /backup/etcd-snapshot.db \</span><br><span class="line">  --write-out=table</span><br></pre></td></tr></table></figure>

<h4 id="âœ…-æ–¹å¼äºŒï¼šä½¿ç”¨-etcdutlï¼ˆFile-based-Backupï¼Œéœ€åœæ©Ÿï¼‰"><a href="#âœ…-æ–¹å¼äºŒï¼šä½¿ç”¨-etcdutlï¼ˆFile-based-Backupï¼Œéœ€åœæ©Ÿï¼‰" class="headerlink" title="âœ… æ–¹å¼äºŒï¼šä½¿ç”¨ etcdutlï¼ˆFile-based Backupï¼Œéœ€åœæ©Ÿï¼‰"></a>âœ… æ–¹å¼äºŒï¼šä½¿ç”¨ etcdutlï¼ˆFile-based Backupï¼Œéœ€åœæ©Ÿï¼‰</h4><blockquote>
<p>For offline file-level backup of the data directory</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">etcdutl backup \</span><br><span class="line">  --data-dir /var/lib/etcd \</span><br><span class="line">  --backup-dir /backup/etcd-backup</span><br></pre></td></tr></table></figure>

<h3 id="Restore-ETCD-ETCD-Cluster-Snapshot"><a href="#Restore-ETCD-ETCD-Cluster-Snapshot" class="headerlink" title="Restore - ETCD (ETCD Cluster) Snapshot"></a>Restore - ETCD (ETCD Cluster) Snapshot</h3><p>âš ï¸ é‚„åŸå‹•ä½œæœƒè¦†è“‹åŸæœ‰è³‡æ–™ï¼Œè«‹å¯©æ…åŸ·è¡Œï¼</p>
<h4 id="âœ…-é‚„åŸ-snapshotï¼ˆå»ºç«‹æ–°-etcd-data-dirï¼‰"><a href="#âœ…-é‚„åŸ-snapshotï¼ˆå»ºç«‹æ–°-etcd-data-dirï¼‰" class="headerlink" title="âœ… é‚„åŸ snapshotï¼ˆå»ºç«‹æ–° etcd data-dirï¼‰"></a>âœ… é‚„åŸ snapshotï¼ˆå»ºç«‹æ–° etcd data-dirï¼‰</h4><blockquote>
<p>To restore a snapshot to a new data directory</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœæ­¢ kube-apiserverï¼Œé¿å…ç«¶çˆ­ etcd socket</span></span><br><span class="line">systemctl stop kube-apiserver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ etcdctl é‚„åŸ snapshot åˆ°æ–°ç›®éŒ„ï¼ˆä¸è¦†è“‹åŸç›®éŒ„ï¼‰</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot.db \</span><br><span class="line">  --data-dir /var/lib/etcd-from-backup \</span><br><span class="line">  --initial-cluster master-1=https://192.168.5.11:2380,master-2=https://192.168.5.12:2380 \ â†’ å¤šç¯€é»ï¼ˆHA etcd clusterï¼‰</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-advertise-peer-urls https://192.168.5.11:2380</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ etcd.yaml (Static Pod) ä½¿ç”¨æ–°çš„ data-dirï¼ˆ/var/lib/etcd-from-backupï¼‰</span></span><br><span class="line">vim /etc/kubernetes/manifests/etcd.yaml</span><br><span class="line"><span class="comment"># æ‰¾åˆ° --data-dir æ”¹ç‚º /var/lib/etcd-from-backup</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="comment"># volumes:</span></span><br><span class="line">  <span class="comment"># - hostPath:</span></span><br><span class="line">  <span class="comment">#     path: /var/lib/etcd-from-backup # New restored backup directory</span></span><br><span class="line">  <span class="comment">#     type: DirectoryOrCreate</span></span><br><span class="line">  <span class="comment">#   name: etcd-data</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡è¼‰ä¸¦è§€å¯Ÿ etcd / kube-apiserver é‡å•Ÿç‹€æ³</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart etcd</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›£çœ‹å®¹å™¨å•Ÿå‹•</span></span><br><span class="line">watch crictl ps</span><br><span class="line">kubectl get deployments,services --all-namespaces</span><br></pre></td></tr></table></figure>

<div class="note info"><p>Check the image used by the ETCD pod</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Method 1</span></span><br><span class="line">kubectl describe pod etcd-controlplane -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2</span></span><br><span class="line">kubeadm upgrade plan</span><br></pre></td></tr></table></figure></div>

<hr>
<h1 id="K8s-Architecture"><a href="#K8s-Architecture" class="headerlink" title="K8s Architecture"></a>K8s Architecture</h1><ul>
<li>Master<ul>
<li>ç”¨é€”ï¼šManage, Plan, Schedule, Monitor Nodes</li>
<li>å…ƒä»¶ï¼šETCD CLUSTER, kube-apiserver, kube-scheduler, Kube Controller Manager</li>
</ul>
</li>
<li>Worker Nodes<ul>
<li>ç”¨é€”ï¼šHost Application as Containers</li>
<li>å…ƒä»¶ï¼škubelet, Kube-proxy, Container Runtime Engine (å¦‚ containerd)</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>OS Upgrades</tag>
        <tag>Backup</tag>
        <tag>Restore</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s Security | CA</title>
    <url>/2025/07/07/K8s-Advanced/K8s-Security-CA/</url>
    <content><![CDATA[<h1 id="K8s-CA-èˆ‡-CSR-æ†‘è­‰ç°½ç½²æµç¨‹"><a href="#K8s-CA-èˆ‡-CSR-æ†‘è­‰ç°½ç½²æµç¨‹" class="headerlink" title="K8s CA èˆ‡ CSR æ†‘è­‰ç°½ç½²æµç¨‹"></a>K8s CA èˆ‡ CSR æ†‘è­‰ç°½ç½²æµç¨‹</h1><h2 id="ä»€éº¼æ˜¯-CA-Certificate-Authority-ï¼Ÿ"><a href="#ä»€éº¼æ˜¯-CA-Certificate-Authority-ï¼Ÿ" class="headerlink" title="ä»€éº¼æ˜¯ CA (Certificate Authority)ï¼Ÿ"></a>ä»€éº¼æ˜¯ CA (Certificate Authority)ï¼Ÿ</h2><p>K8s ä½¿ç”¨å…§å»ºçš„ Certificate Authorityï¼ˆCAï¼‰ç°½ç™¼æ†‘è­‰çµ¦ç”¨æˆ¶ã€å…ƒä»¶æˆ–æœå‹™ï¼Œé€éè‡ªå‹•åŒ–æ§åˆ¶æµç¨‹ä¾†çµ±ä¸€ç®¡ç†ï¼š</p>
<ol>
<li>ç°½ç½²å…ƒä»¶æ†‘è­‰ï¼ˆå¦‚ API Serverã€kubeletï¼‰</li>
<li>é©—è­‰ Client æ†‘è­‰ï¼ˆRBACã€API è«‹æ±‚ï¼‰</li>
<li>ä½¿ç”¨ Certificates API è‡ªå‹•åŒ– CSR (CertificateSigningRequest) æµç¨‹</li>
</ol>
<h2 id="CSR-CertificateSigningRequest-æ“ä½œæµç¨‹"><a href="#CSR-CertificateSigningRequest-æ“ä½œæµç¨‹" class="headerlink" title="CSR (CertificateSigningRequest) æ“ä½œæµç¨‹"></a>CSR (CertificateSigningRequest) æ“ä½œæµç¨‹</h2><p>CSR çš„ç°½ç½²èˆ‡æ ¸å‡†æµç¨‹ï¼Œæ˜¯ç”± kube-controller-manager å…§éƒ¨çš„ controller è‡ªå‹•å®Œæˆã€‚ä½ å¯ä»¥é€é webhook æˆ– RBAC æ§åˆ¶èª°å¯ä»¥è‡ªå‹•æ‰¹å‡†ã€‚</p>
<div class="note info"><p>è‡ªå‹•åŒ–ç®¡ç†è­‰æ›¸ç°½åï¼š</p>
<ol>
<li>Create CertificateSigningRequest Object</li>
<li>Reviewing Requests</li>
<li>Approve Requests</li>
<li>Share Certs to Users</li>
</ol>
</div>

<h3 id="1-å»ºç«‹ç§é‘°èˆ‡-CSR-æª”æ¡ˆ"><a href="#1-å»ºç«‹ç§é‘°èˆ‡-CSR-æª”æ¡ˆ" class="headerlink" title="1. å»ºç«‹ç§é‘°èˆ‡ CSR æª”æ¡ˆ"></a>1. å»ºç«‹ç§é‘°èˆ‡ CSR æª”æ¡ˆ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç”¢ç”Ÿç§é‘°</span></span><br><span class="line">openssl genrsa -out jane.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¢ç”Ÿ CSR æ†‘è­‰è«‹æ±‚ï¼Œé€™è£¡æŒ‡å®š CN åç¨±ç‚º jane</span></span><br><span class="line">openssl req -new -key jane.key -subj <span class="string">&quot;/CN=jane&quot;</span> -out jane.csr</span><br></pre></td></tr></table></figure>

<h3 id="2-å°‡-CSR-ç·¨ç¢¼å¾Œå»ºç«‹-K8s-CSR-è³‡æº"><a href="#2-å°‡-CSR-ç·¨ç¢¼å¾Œå»ºç«‹-K8s-CSR-è³‡æº" class="headerlink" title="2. å°‡ CSR ç·¨ç¢¼å¾Œå»ºç«‹ K8s CSR è³‡æº"></a>2. å°‡ CSR ç·¨ç¢¼å¾Œå»ºç«‹ K8s CSR è³‡æº</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Encode: base64 ç·¨ç¢¼ jane.csr</span></span><br><span class="line"><span class="built_in">cat</span> jane.csr | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å»ºç«‹ CSR è³‡æºæ™‚ï¼Œéœ€å°‡ä¸Šé¢ Encode å¾Œçš„ base64 çµæœè²¼å…¥ spec.request æ¬„ä½ã€‚(jane-csr.yaml)<br><code>tr -d &#39;\n&#39;</code> æ˜¯ç§»é™¤æ›è¡Œç¬¦è™Ÿï¼Œç¢ºä¿è²¼é€² YAML çš„ spec.request æ¬„ä½æ˜¯ä¸€è¡Œæ–‡å­—ã€‚</p>
</blockquote>
<p>ç¯„ä¾‹ YAMLï¼šjane-csr.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">certificates.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CertificateSigningRequest</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">request:</span> [<span class="string">è²¼ä¸Š</span> <span class="string">base64</span> <span class="string">ç·¨ç¢¼å¾Œçš„</span> <span class="string">CSR</span>]</span><br><span class="line">  <span class="attr">signerName:</span> <span class="string">kubernetes.io/kube-apiserver-client</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">client</span> <span class="string">auth</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f jane-csr.yaml</span><br></pre></td></tr></table></figure>

<h3 id="3-å¯©æ ¸èˆ‡æ‰¹å‡†-CSR-è«‹æ±‚"><a href="#3-å¯©æ ¸èˆ‡æ‰¹å‡†-CSR-è«‹æ±‚" class="headerlink" title="3. å¯©æ ¸èˆ‡æ‰¹å‡† CSR è«‹æ±‚"></a>3. å¯©æ ¸èˆ‡æ‰¹å‡† CSR è«‹æ±‚</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰ CSR</span></span><br><span class="line">kubectl get csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ jane çš„è©³ç´°å…§å®¹</span></span><br><span class="line">kubectl get csr jane -o yaml</span><br></pre></td></tr></table></figure>

<p>è‹¥ç¢ºèªç„¡èª¤å¾Œï¼ŒåŸ·è¡Œæ‰¹å‡†æŒ‡ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl certificate approve jane</span><br></pre></td></tr></table></figure>
<p>è‹¥éœ€è¦æ‹’çµ•è«‹æ±‚ï¼Œå¯ç”¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl certificate deny jane</span><br></pre></td></tr></table></figure>

<h3 id="4-å–å¾—ç°½ç½²å¾Œçš„æ†‘è­‰"><a href="#4-å–å¾—ç°½ç½²å¾Œçš„æ†‘è­‰" class="headerlink" title="4. å–å¾—ç°½ç½²å¾Œçš„æ†‘è­‰"></a>4. å–å¾—ç°½ç½²å¾Œçš„æ†‘è­‰</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°‡æ†‘è­‰å­˜å‡ºä¾†</span></span><br><span class="line">kubectl get csr jane -o jsonpath=<span class="string">&#x27;&#123;.status.certificate&#125;&#x27;</span> | <span class="built_in">base64</span> --decode &gt; jane.crt</span><br><span class="line"><span class="comment"># jane.crt æ˜¯ç”± Kubernetes CA ç°½ç™¼çš„ PEM æ ¼å¼ç”¨æˆ¶æ†‘è­‰</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>åŒ¯å‡ºçš„ jane.crt ç‚º PEM ç·¨ç¢¼ï¼ˆbase64 æ ¼å¼ï¼‰ä¹‹ X.509 æ†‘è­‰ï¼Œå¯ç›´æ¥ç”¨æ–¼ kubeconfig æˆ– openssl é©—è­‰ã€‚</p>
</blockquote>
<p>ç¾åœ¨ä½ å°±æ“æœ‰ï¼š</p>
<ul>
<li>jane.keyï¼ˆç§é‘°ï¼‰</li>
<li>jane.crtï¼ˆç”± K8s ç°½ç½²çš„ç”¨æˆ¶ç«¯æ†‘è­‰ï¼‰</li>
</ul>
<hr>
<h1 id="Certificates-API-èˆ‡æ§åˆ¶å™¨èªªæ˜"><a href="#Certificates-API-èˆ‡æ§åˆ¶å™¨èªªæ˜" class="headerlink" title="Certificates API èˆ‡æ§åˆ¶å™¨èªªæ˜"></a>Certificates API èˆ‡æ§åˆ¶å™¨èªªæ˜</h1><p>åœ¨ Kubernetes controlplane ä¸­ï¼Œ<code>kube-controller-manager</code> æ˜¯è² è²¬åŸ·è¡Œå¤šç¨®æ§åˆ¶å™¨ï¼ˆcontrollerï¼‰çš„æ ¸å¿ƒå…ƒä»¶ï¼Œå…¶ä¸­ä¹ŸåŒ…å«èˆ‡æ†‘è­‰ç›¸é—œçš„æ“ä½œæµç¨‹ã€‚</p>
<p>ç•¶ç°½ç½² CSRï¼ˆCertificateSigningRequestï¼‰æ™‚ï¼ŒKube Controller Manager æœƒä½¿ç”¨è¨­å®šå¥½çš„ CA æ†‘è­‰ï¼ˆroot certificateï¼‰èˆ‡ç§é‘°ï¼ˆprivate keyï¼‰å° CSR é€²è¡Œç°½ç« ã€‚</p>
<p>é€™äº›æ†‘è­‰ç°½ç™¼æµç¨‹ï¼Œå¯¦éš›ä¸Šæ˜¯ç”± Controller Manager å…§éƒ¨çš„å…©å€‹æ§åˆ¶å™¨è² è²¬è™•ç†ï¼š</p>
<table>
<thead>
<tr>
<th>Controller Name</th>
<th>åŠŸèƒ½èªªæ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>csr-approving</code> controller</td>
<td>æ±ºå®šæ˜¯å¦æ ¸å‡† CSR</td>
</tr>
<tr>
<td><code>csr-signing</code> controller</td>
<td>ä½¿ç”¨ CA æ†‘è­‰èˆ‡ç§é‘°ç°½ç½² CSR</td>
</tr>
</tbody></table>
<h2 id="æª¢æŸ¥-Controller-Manager-æ†‘è­‰ç°½ç½²åƒæ•¸"><a href="#æª¢æŸ¥-Controller-Manager-æ†‘è­‰ç°½ç½²åƒæ•¸" class="headerlink" title="æª¢æŸ¥ Controller Manager æ†‘è­‰ç°½ç½²åƒæ•¸"></a>æª¢æŸ¥ Controller Manager æ†‘è­‰ç°½ç½²åƒæ•¸</h2><p>é€™äº›æ§åˆ¶å™¨æœƒä½¿ç”¨ Controller Manager è¨­å®šæª”ä¸­æŒ‡å®šçš„ CA æ†‘è­‰èˆ‡ç§é‘°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br></pre></td></tr></table></figure>

<p>è«‹ç¢ºèªä»¥ä¸‹åƒæ•¸å­˜åœ¨ï¼ˆK8s ä½¿ç”¨æ­¤ CA é€²è¡Œç°½åï¼‰ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">--cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">--cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="CSR-ç·¨ç¢¼èˆ‡è§£ç¢¼å°æŠ€å·§"><a href="#CSR-ç·¨ç¢¼èˆ‡è§£ç¢¼å°æŠ€å·§" class="headerlink" title="CSR ç·¨ç¢¼èˆ‡è§£ç¢¼å°æŠ€å·§"></a>CSR ç·¨ç¢¼èˆ‡è§£ç¢¼å°æŠ€å·§</h1><h2 id="Encode"><a href="#Encode" class="headerlink" title="Encode"></a>Encode</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> jane.csr | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="Decode"><a href="#Decode" class="headerlink" title="Decode"></a>Decode</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[Encodeå¾Œçš„çµæœ_base64ç·¨ç¢¼]&quot;</span> | <span class="built_in">base64</span> --decode</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="å°çµï¼šK8s-CSR-æµç¨‹é‡é»"><a href="#å°çµï¼šK8s-CSR-æµç¨‹é‡é»" class="headerlink" title="å°çµï¼šK8s CSR æµç¨‹é‡é»"></a>å°çµï¼šK8s CSR æµç¨‹é‡é»</h1><ol>
<li>å»ºç«‹ç§é‘°èˆ‡ CSRï¼ˆå« CN èº«ä»½ï¼‰</li>
<li>å°‡ CSR base64 ç·¨ç¢¼å¾Œå»ºç«‹ Kubernetes è³‡æº</li>
<li>ç®¡ç†å“¡å¯©æ ¸ä¸¦æ‰¹å‡†ï¼ˆå¯è‡ªå‹•æˆ–æ‰‹å‹•ï¼‰</li>
<li>åŒ¯å‡ºç°½ç½²æ†‘è­‰ï¼Œä¾›ç”¨æˆ¶ç«¯é€£ç·šä½¿ç”¨</li>
</ol>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>CA</tag>
        <tag>Certificate</tag>
        <tag>CSR</tag>
        <tag>kube-controller-manager</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s | Security - 1</title>
    <url>/2025/06/21/K8s-Advanced/K8s-Security-1/</url>
    <content><![CDATA[<h1 id="K8s-Security-Primitives"><a href="#K8s-Security-Primitives" class="headerlink" title="K8s Security Primitives"></a>K8s Security Primitives</h1><h2 id="Secure-K8s"><a href="#Secure-K8s" class="headerlink" title="Secure K8s"></a>Secure K8s</h2><h3 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h3><div class="note info"><p><mark>What is kube-apiserver?</mark><br>kube-apiserver æ˜¯ Kubernetes æ§åˆ¶å¹³é¢çš„æ ¸å¿ƒçµ„ä»¶ä¹‹ä¸€ï¼Œæ‰®æ¼”æ•´å€‹å¢é›†çš„å¤§è…¦èˆ‡å‡ºå…¥å£ã€‚<br>å®ƒæä¾›ä¸€å€‹ HTTP REST APIï¼Œæ‰€æœ‰çš„å…§éƒ¨å…ƒä»¶ï¼ˆå¦‚ kubeletã€controller-managerï¼‰èˆ‡å¤–éƒ¨å·¥å…·ï¼ˆå¦‚ kubectlã€CI&#x2F;CD pipelineï¼‰éƒ½é€éå®ƒä¾†èˆ‡ Kubernetes äº’å‹•ã€‚</p>
<p><mark>ğŸ” å¸¸è¦‹å®‰å…¨è¨­å®š</mark></p>
<table>
<thead>
<tr>
<th>é¡å‹</th>
<th>ç¯„ä¾‹è¨­å®šæ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td>èªè­‰</td>
<td>Tokenã€æ†‘è­‰ã€HTTP Basicã€OIDCã€Webhook</td>
</tr>
<tr>
<td>æˆæ¬Š</td>
<td>RBACã€ABACã€Webhook</td>
</tr>
<tr>
<td>å‚³è¼¸åŠ å¯†</td>
<td>HTTPSã€TLS æ†‘è­‰</td>
</tr>
<tr>
<td>è«‹æ±‚é™åˆ¶</td>
<td>Audit Policyã€Rate Limitingã€Webhook é©—è­‰å™¨</td>
</tr>
</tbody></table>
<br>

<p><mark>âœ… å°æé†’</mark></p>
<ul>
<li>kube-apiserver æ˜¯ç„¡ç‹€æ…‹çš„ï¼ˆstatelessï¼‰ï¼Œå¯æ©«å‘æ“´å±•ä»¥æé«˜é«˜å¯ç”¨æ€§ã€‚</li>
<li>ç‹€æ…‹éƒ½å­˜æ”¾åœ¨ etcdã€‚</li>
<li>è‹¥ apiserver æ›æ‰ï¼Œåªè¦ etcd é‚„åœ¨ï¼Œå¢é›†ç‹€æ…‹ä¸æœƒéºå¤±ã€‚</li>
</ul>
</div>

<p>Authentication (é©—è­‰): Who can access?</p>
<ol>
<li>Files â€“ Username and Passwords</li>
<li>Files â€“ Username and Tokens</li>
<li>Certificates</li>
<li>External Authentication providers - LDAP</li>
<li>Service Accounts</li>
</ol>
<p>Authorization (æˆæ¬Š): What can they do?</p>
<ol>
<li>RBAC Authorization</li>
<li>ABAC Authorization</li>
<li>Node Authorization</li>
<li>Webhook Mode</li>
</ol>
<h2 id="TLS-Certificates"><a href="#TLS-Certificates" class="headerlink" title="TLS Certificates"></a>TLS Certificates</h2><p>Kube ApiServer (Master)</p>
<ul>
<li>ETCD CLUSTER (Master)</li>
<li>Kube Scheduler (Master)</li>
<li>Kube Controller Manager (Master)</li>
<li>Kubelet (Worker Nodes)</li>
<li>Kube Proxy (Worker Nodes)</li>
</ul>
<h2 id="Network-Policies"><a href="#Network-Policies" class="headerlink" title="Network Policies"></a>Network Policies</h2><hr>
<h1 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h1><p>Kubernetes <code>æœ¬èº«</code> çš„ç¢º <code>ã€Œä¸ä¸»å‹•ç®¡ç†å¸³è™Ÿï¼ˆaccountï¼‰ã€</code>ï¼Œä½†å®ƒæä¾›å¸³è™Ÿçš„æ¦‚å¿µèˆ‡æ©Ÿåˆ¶ï¼Œè®“å¤–éƒ¨ç³»çµ±æˆ–ç®¡ç†è€…é€²è¡Œ <code>èº«ä»½é©—è­‰èˆ‡æˆæ¬Šæ•´åˆ</code>ã€‚</p>
<p>âœ… çµè«–ï¼šK8s ä¸ç®¡ç†å¸³è™Ÿï¼Œä½†æä¾›ã€Œæˆæ¬Šæ¶æ§‹ã€</p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½é¢å‘</th>
<th>Kubernetes åšçš„äº‹</th>
</tr>
</thead>
<tbody><tr>
<td>å¸³è™Ÿç®¡ç†</td>
<td>âŒ ä¸ç®¡ç† User å¸³è™Ÿï¼Œéœ€ä¾è³´å¤–éƒ¨ç³»çµ±é©—è­‰</td>
</tr>
<tr>
<td>èªè­‰æ©Ÿåˆ¶</td>
<td>âœ… æä¾›å¤šç¨®èº«ä»½é©—è­‰æ¥å£</td>
</tr>
<tr>
<td>æˆæ¬Šï¼ˆRBACï¼‰</td>
<td>âœ… æ§åˆ¶èª°èƒ½å°ä»€éº¼è³‡æºåšä»€éº¼æ“ä½œ</td>
</tr>
<tr>
<td>Service Account</td>
<td>âœ… è‡ªå‹•å»ºç«‹èˆ‡ç®¡ç†ï¼Œä¾› Pod ä½¿ç”¨</td>
</tr>
</tbody></table>
<h2 id="Accounts"><a href="#Accounts" class="headerlink" title="Accounts"></a>Accounts</h2><p>User (ä½¿ç”¨è€…å¸³è™Ÿ) æœƒå…ˆç¶“é kube-apiserver (Authenticate User) é©—è­‰å¾Œï¼Œæ‰ Process requestã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Admins      --- kubectl                              -</span><br><span class="line">                                                      |---&gt; kube-apiserver ---&gt; Process request</span><br><span class="line">Developers  --- curl https://kube-server-ip:6443/    -</span><br></pre></td></tr></table></figure>

<h3 id="Authentication-æµç¨‹åœ–"><a href="#Authentication-æµç¨‹åœ–" class="headerlink" title="Authentication æµç¨‹åœ–"></a>Authentication æµç¨‹åœ–</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[kubectl]      [curl / script]    [Pod / Controller]</span><br><span class="line">   â”‚                 â”‚                       â”‚</span><br><span class="line">   â””â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">          â–¼     â–¼             â–¼       â–¼</span><br><span class="line">             [ kube-apiserver ]</span><br><span class="line">                     â”‚</span><br><span class="line">            [ AuthN â†’ AuthZ â†’ Admission â†’ etcd ]</span><br></pre></td></tr></table></figure>

<p>Accounts é¡å‹æ¯”è¼ƒ</p>
<table>
<thead>
<tr>
<th>é¡å‹</th>
<th>èªªæ˜</th>
<th>Kubernetes æ˜¯å¦è‡ªå‹•ç®¡ç†ï¼Ÿ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>User Accountï¼ˆä½¿ç”¨è€…å¸³è™Ÿï¼‰</strong></td>
<td>çµ¦äººé¡ä½¿ç”¨è€…ï¼ˆä¾‹å¦‚ Adminã€DevOpsï¼‰</td>
<td>âŒ ä¸æœƒç®¡ç†ï¼Œä¹Ÿä¸å„²å­˜åœ¨ K8s ä¸­</td>
</tr>
<tr>
<td><strong>Service Accountï¼ˆæœå‹™å¸³è™Ÿï¼‰</strong></td>
<td>çµ¦ Pod æˆ–å…§éƒ¨æ§åˆ¶å™¨ä½¿ç”¨</td>
<td>âœ… ç”± K8s ç®¡ç†èˆ‡å»ºç«‹</td>
</tr>
</tbody></table>
<h3 id="User-ä½¿ç”¨è€…å¸³è™Ÿ"><a href="#User-ä½¿ç”¨è€…å¸³è™Ÿ" class="headerlink" title="User (ä½¿ç”¨è€…å¸³è™Ÿ)"></a>User (ä½¿ç”¨è€…å¸³è™Ÿ)</h3><blockquote>
<p>ä¾‹å¦‚ï¼šAdmins, Developers</p>
</blockquote>
<ul>
<li>K8s <code>ä¸æœƒå»ºç«‹ã€å„²å­˜æˆ–é©—è­‰</code> User å¸³è™Ÿã€‚</li>
<li>å¸¸è¦‹èº«ä»½é©—è­‰ä¾†æºï¼ˆé€šå¸¸é€éå¤–éƒ¨ç³»çµ±æä¾›ã€‚éœ€ç”±ç®¡ç†è€…æˆ– DevOps æ¶è¨­ï¼‰ï¼š<ul>
<li>X.509 æ†‘è­‰ï¼ˆæœ€å¸¸è¦‹ï¼Œkubectl é è¨­æ–¹å¼ï¼‰</li>
<li>OIDC &#x3D; OpenID Connectï¼ˆä¾‹å¦‚èˆ‡ Googleã€GitHubã€Keycloak æ•´åˆï¼‰</li>
<li>LDAP &#x2F; Active Directory (AD)</li>
<li>Webhook Token Authï¼ˆè‡ªå®š APIï¼‰</li>
</ul>
</li>
<li>é›–ç„¶èº«ä»½é©—è­‰äº¤ç”±å¤–éƒ¨è™•ç†ï¼ŒK8s ä»å¯ç”¨ RBAC å°é€™äº›ä½¿ç”¨è€…é€²è¡Œæˆæ¬Šï¼ˆä¾‹å¦‚ç®¡æ§é€™å€‹ user å¯å¦ get podï¼‰ã€‚</li>
</ul>
<h3 id="Service-Accounts-æœå‹™å¸³è™Ÿ"><a href="#Service-Accounts-æœå‹™å¸³è™Ÿ" class="headerlink" title="Service Accounts (æœå‹™å¸³è™Ÿ)"></a>Service Accounts (æœå‹™å¸³è™Ÿ)</h3><blockquote>
<p>ä¾‹å¦‚ï¼šCI&#x2F;CD Bots</p>
</blockquote>
<ul>
<li>K8s æ¯å€‹ namespace æœƒé è¨­å»ºç«‹ä¸€å€‹åç‚º <code>default</code> çš„ service account (SA)ã€‚</li>
<li>è‹¥ Pod æœªæŒ‡å®š SAï¼Œæœƒè‡ªå‹•ç¶å®š <code>default</code>ã€‚</li>
<li>Pod æœƒé€é SA çš„ Token Secret è‡ªå‹•æ›è¼‰å­˜å– kube-apiserverã€‚ï¼ˆä¾‹å¦‚ï¼šèˆ‡ etcd åŒæ­¥ã€çœ‹å…¶ä»–è³‡æºï¼‰</li>
<li>å¯ä½¿ç”¨ RBAC æ§åˆ¶å…¶å­˜å–æ¬Šé™ã€‚</li>
<li>å¸¸ç”¨æŒ‡ä»¤ï¼š  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å»ºç«‹ ServiceAccount</span></span><br><span class="line">kubectl create serviceaccount &lt;sa_name&gt; -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è©¢</span></span><br><span class="line">kubectl get serviceaccounts -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="kube-apiserver-çš„-Auth-Mechanisms"><a href="#kube-apiserver-çš„-Auth-Mechanisms" class="headerlink" title="kube-apiserver çš„ Auth Mechanisms"></a>kube-apiserver çš„ Auth Mechanisms</h2><table>
<thead>
<tr>
<th>é¡å‹</th>
<th>èªªæ˜</th>
<th>å»ºè­°ä½¿ç”¨ï¼Ÿ</th>
</tr>
</thead>
<tbody><tr>
<td>Static Password File</td>
<td>ä½¿ç”¨ CSV æ ¼å¼å¸³è™Ÿå¯†ç¢¼</td>
<td>ğŸš« ä¸å»ºè­°ï¼ˆä¸å®‰å…¨ã€ä¸æ˜“æ“´å±•ï¼‰</td>
</tr>
<tr>
<td>Static Token File</td>
<td>ä½¿ç”¨ Token å­˜æ”¾åœ¨æª”æ¡ˆä¸­</td>
<td>ğŸš« ä¸å»ºè­°ï¼ˆå¯¦é©—ã€æ¸¬è©¦ç”¨é€”ï¼‰</td>
</tr>
<tr>
<td>X.509 æ†‘è­‰</td>
<td>ä½¿ç”¨ client cert ç™»å…¥ APIï¼ˆkubectl é è¨­ï¼‰</td>
<td>âœ… å»ºè­°ï¼ˆæˆç†Ÿä¸”ç©©å®šï¼‰</td>
</tr>
<tr>
<td>OIDCï¼ˆOpenID Connectï¼‰</td>
<td>OAuth2 ç›¸å®¹èº«ä»½ç³»çµ±ï¼ˆå¦‚ Googleï¼‰</td>
<td>âœ… å»ºè­°ï¼ˆæ”¯æ´ SSOï¼‰</td>
</tr>
<tr>
<td>Webhook Token Auth</td>
<td>å°‡è«‹æ±‚å°å‘è‡ªå®š API åšèº«ä»½é©—è­‰</td>
<td>âœ… å»ºè­°ï¼ˆå½ˆæ€§é«˜ï¼‰</td>
</tr>
</tbody></table>
<details class="note default"><summary><p>è£œå……èªªæ˜ï¼šStatic File Auth</p>
</summary>
<p>åœ¨ kubeadm å®‰è£ç’°å¢ƒä¸­ï¼Œå¦‚æœä½¿ç”¨ static token&#x2F;password èªè­‰æ–¹å¼ï¼Œéœ€é€é Volume å°‡æª”æ¡ˆæ›è¼‰é€² kube-apiserverã€‚<br>âš ï¸  ç”Ÿç”¢ç’°å¢ƒä¸å»ºè­°ä½¿ç”¨ static file authenticationï¼Œè«‹å„ªå…ˆä½¿ç”¨æ†‘è­‰æˆ– OIDCã€‚</p>

</details>

<hr>
<h1 id="TLS-Basics-PRE-REQ"><a href="#TLS-Basics-PRE-REQ" class="headerlink" title="TLS Basics (PRE-REQ)"></a>TLS Basics (PRE-REQ)</h1><h2 id="TLS-Certificates-1"><a href="#TLS-Certificates-1" class="headerlink" title="TLS Certificates"></a>TLS Certificates</h2><p>TLSï¼ˆTransport Layer Securityï¼‰æ˜¯ç”¨ä¾†åŠ å¯†å…©ç«¯é€šè¨Šçš„é‡è¦æŠ€è¡“ (ç¶²è·¯é€šè¨ŠåŠ å¯†å”å®š)ï¼Œå¸¸è¦‹æ–¼ HTTPSã€Kubernetesã€SSH ç­‰å ´æ™¯ã€‚<br>TLS æ†‘è­‰åŸºæ–¼ <code>å…¬é–‹é‡‘é‘°åŠ å¯†ï¼ˆPublic Key Cryptographyï¼‰</code> å’Œ <code>PKI æ¶æ§‹</code>ã€‚</p>
<h3 id="Symmetric-Encryptionï¼ˆå°ç¨±å¼åŠ å¯†ï¼‰"><a href="#Symmetric-Encryptionï¼ˆå°ç¨±å¼åŠ å¯†ï¼‰" class="headerlink" title="Symmetric Encryptionï¼ˆå°ç¨±å¼åŠ å¯†ï¼‰"></a>Symmetric Encryptionï¼ˆå°ç¨±å¼åŠ å¯†ï¼‰</h3><ul>
<li>é›™æ–¹å…±ç”¨ <code>åŒä¸€æŠŠå¯†é‘°</code> ä¾†åŠ è§£å¯†ã€‚</li>
<li>åŠ å¯†å¿«é€Ÿï¼Œä½† <code>å¯†é‘°åˆ†ç™¼å›°é›£ã€ä¸å®‰å…¨</code> (å¯†é‘°äº¤æ›å›°é›£)ã€‚</li>
<li>é©åˆè³‡æ–™å‚³è¼¸ï¼Œä½†ä¸é©åˆå»ºç«‹å®‰å…¨é€£ç·šã€‚</li>
</ul>
<h3 id="Asymmetric-Encryptionï¼ˆéå°ç¨±å¼åŠ å¯†ï¼‰"><a href="#Asymmetric-Encryptionï¼ˆéå°ç¨±å¼åŠ å¯†ï¼‰" class="headerlink" title="Asymmetric Encryptionï¼ˆéå°ç¨±å¼åŠ å¯†ï¼‰"></a>Asymmetric Encryptionï¼ˆéå°ç¨±å¼åŠ å¯†ï¼‰</h3><ul>
<li>ä¸€å°é‡‘é‘°ï¼š<code>Private Keyï¼ˆç§é‘°ï¼‰</code> èˆ‡ <code>Public Keyï¼ˆå…¬é–‹é‘° / å…¬é–‹é–, aka. Public Lockï¼‰</code></li>
<li>åŠ å¯†èˆ‡è§£å¯†ç”±ä¸åŒé‡‘é‘°å®Œæˆï¼š<ul>
<li>å…¬é‘°åŠ å¯† â†’ ç§é‘°è§£å¯†</li>
<li>ç§é‘°ç°½å â†’ å…¬é‘°é©—è­‰</li>
</ul>
</li>
<li>âœ… é©ç”¨æ–¼å»ºç«‹å®‰å…¨é€£ç·šèˆ‡èº«åˆ†é©—è­‰<br><mark>Public Key &#x3D; å…¬é–‹é–ï¼Œåªæœ‰ç§é‘°æ‰èƒ½è§£é–‹å®ƒã€‚</mark></li>
</ul>
<h3 id="é‡‘é‘°èˆ‡æ†‘è­‰ç¯„ä¾‹"><a href="#é‡‘é‘°èˆ‡æ†‘è­‰ç¯„ä¾‹" class="headerlink" title="é‡‘é‘°èˆ‡æ†‘è­‰ç¯„ä¾‹"></a>é‡‘é‘°èˆ‡æ†‘è­‰ç¯„ä¾‹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç”¢ç”Ÿ SSH é‡‘é‘°å°ï¼ˆèˆ‡ TLS ç›¸ä¼¼é‚è¼¯ï¼‰</span></span><br><span class="line">ssh-keygen</span><br><span class="line"></span><br><span class="line"><span class="comment"># é è¨­ç”¢å‡ºå…©å€‹æª”æ¡ˆï¼š</span></span><br><span class="line"><span class="comment"># 1. ç§é‘° (Private Key): ~/.ssh/id_rsa    â†’ å°æ‡‰ TLS ä¸­çš„ *.key æˆ– *-key.pem</span></span><br><span class="line"><span class="comment"># 2. å…¬é‘° (Public Key): ~/.ssh/id_rsa.pub â†’ å°æ‡‰ TLS ä¸­çš„ *.crt æˆ– *.pem</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å…¥ä½¿ç”¨ SSH ç§é‘°</span></span><br><span class="line">ssh -i id_rsa user1@server1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¼ºæœå™¨ä¸Šå…è¨±çš„å…¬é‘°</span></span><br><span class="line"><span class="built_in">cat</span> ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<h3 id="Certificate-Authority-CA"><a href="#Certificate-Authority-CA" class="headerlink" title="Certificate Authority (CA)"></a>Certificate Authority (CA)</h3><ul>
<li>CA æ˜¯å—ä¿¡ä»»çš„æ†‘è­‰ç°½ç™¼å–®ä½ï¼Œç”¨ä¾†ç°½ç½²æ†‘è­‰ä»¥è­‰æ˜èº«ä»½çœŸå¯¦æ€§ã€‚</li>
<li>æ†‘è­‰ä¸­åŒ…å«ï¼š<ul>
<li>å…¬é‘°</li>
<li>å¯¦é«”è³‡è¨Šï¼ˆå¦‚ï¼šCNã€OUã€DNS nameï¼‰</li>
<li>CA çš„ç°½å</li>
</ul>
</li>
<li>TLS æ†‘è­‰æ˜¯ç”± CA ç°½ç™¼ï¼ˆæˆ–è‡ªç°½ï¼‰å¾Œï¼Œé™„ä¸Šã€Œå…¬é‘° + èº«ä»½è³‡è¨Šã€çš„æª”æ¡ˆã€‚</li>
<li>å¸¸è¦‹æ ¼å¼ï¼š.crtã€.pem</li>
</ul>
<h3 id="Public-Key-Infrastructure-PKI"><a href="#Public-Key-Infrastructure-PKI" class="headerlink" title="Public Key Infrastructure (PKI)"></a>Public Key Infrastructure (PKI)</h3><blockquote>
<p>å»ºç«‹ã€ç°½ç½²èˆ‡ç®¡ç†æ†‘è­‰(å…¬ç§é‘° + æ†‘è­‰)çš„ä¿¡ä»»æ¶æ§‹</p>
</blockquote>
<p>PKI æ¶æ§‹åŒ…å«ï¼š</p>
<ul>
<li>æ†‘è­‰ç°½ç½²è«‹æ±‚ï¼ˆCSRï¼‰ï¼šç”±æŒæœ‰ç§é‘°è€…ç™¼å‡ºï¼Œè«‹æ±‚ CA ç°½å</li>
<li>CA ç°½ç™¼æ†‘è­‰ï¼šæ ¹æ“š CSR å›å‚³æ­£å¼æ†‘è­‰</li>
<li>æ†‘è­‰éˆï¼ˆChain of Trustï¼‰ï¼šRoot Certificatesã€Server Certificatesã€Client Certificates ä¸²æ¥</li>
<li>æ†‘è­‰æœ‰æ•ˆæ€§æª¢æŸ¥ï¼ˆOCSPã€CRLï¼‰ï¼šæ†‘è­‰æ’¤éŠ·æ©Ÿåˆ¶</li>
</ul>
<h3 id="TLS-é‹ä½œæ ¸å¿ƒæ¦‚å¿µï¼ˆæ•´åˆï¼‰"><a href="#TLS-é‹ä½œæ ¸å¿ƒæ¦‚å¿µï¼ˆæ•´åˆï¼‰" class="headerlink" title="TLS é‹ä½œæ ¸å¿ƒæ¦‚å¿µï¼ˆæ•´åˆï¼‰"></a>TLS é‹ä½œæ ¸å¿ƒæ¦‚å¿µï¼ˆæ•´åˆï¼‰</h3><table>
<thead>
<tr>
<th>å…ƒä»¶</th>
<th>å…§å®¹</th>
</tr>
</thead>
<tbody><tr>
<td>Private Key</td>
<td>è‡ªå·±ä¿ç®¡ï¼Œè² è²¬è§£å¯†è³‡æ–™æˆ–ç”¢ç”Ÿæ•¸ä½ç°½ç« </td>
</tr>
<tr>
<td>Public Key</td>
<td>ç™¼çµ¦å°æ–¹ï¼Œè®“å°æ–¹å°è³‡æ–™åŠ å¯†æˆ–é©—è­‰ç°½ç« </td>
</tr>
<tr>
<td>Certificateï¼ˆæ†‘è­‰ï¼‰</td>
<td>å…¬é‘° + èº«ä»½è³‡è¨Šï¼ˆå¦‚ CNã€OUï¼‰ï¼Œç¶“ CA ç°½ç« </td>
</tr>
<tr>
<td>TLS é€šè¨Š</td>
<td>åˆå§‹éšæ®µä½¿ç”¨ <code>éå°ç¨±åŠ å¯†</code> äº¤æ›å°ç¨±å¯†é‘° â†’ å¾ŒçºŒè³‡æ–™äº¤æ›ä½¿ç”¨ <code>å°ç¨±åŠ å¯†</code></td>
</tr>
</tbody></table>
<p>Server Certificates for Servers</p>
<ul>
<li>kube-api server</li>
<li>etcd server</li>
<li>kubelet server</li>
</ul>
<p>Client Certificates for Clients</p>
<ul>
<li>admin</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
<li>kube-proxy</li>
</ul>
<h3 id="Generate-Certificates"><a href="#Generate-Certificates" class="headerlink" title="Generate Certificates"></a>Generate Certificates</h3><p>Tools:</p>
<ol>
<li>EASYRSA</li>
<li>OPENSSL</li>
<li>CFSSL</li>
</ol>
<p>Certificate Authority (CA)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Generate Keys</span></span><br><span class="line">openssl genrsa -out ca.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># Certificate Signing Request</span></span><br><span class="line">openssl req -new -key ca.key -subj <span class="string">&quot;/CN=KUBERNETES-CA&quot;</span> -out ca.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sign Certificates</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> ca.csr -signkey ca.key -out ca.crt</span><br></pre></td></tr></table></figure>


<p>View Certificate Details</p>
<p>Certificate Workflow &amp; API</p>
<p>KUBECONFIG</p>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>K8s Security Primitives</tag>
        <tag>Authentication</tag>
        <tag>TLS Certificates for Cluster Components</tag>
        <tag>Secure Persistent Key Value Store</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s Security | KubeConfig</title>
    <url>/2025/07/08/K8s-Advanced/K8s-Security-KubeConfig/</url>
    <content><![CDATA[<h1 id="KubeConfig-æ¦‚è¿°"><a href="#KubeConfig-æ¦‚è¿°" class="headerlink" title="KubeConfig æ¦‚è¿°"></a>KubeConfig æ¦‚è¿°</h1><p>KubeConfig æ˜¯ K8s å®¢æˆ¶ç«¯ï¼ˆkubectlï¼‰èˆ‡ API Server é€šè¨Šæ‰€ä¾è³´çš„è¨­å®šæª”ã€‚å®ƒåŒ…å«ï¼š</p>
<ul>
<li>ä½¿ç”¨è€…èº«ä»½é©—è­‰è³‡è¨Šï¼ˆclient certificate &#x2F; tokenï¼‰</li>
<li>API Server çš„é€£ç·šä½ç½®èˆ‡æ†‘è­‰</li>
<li>å¤šç’°å¢ƒ context çš„å®šç¾©èˆ‡åˆ‡æ›</li>
</ul>
<h2 id="ä½¿ç”¨æ†‘è­‰ç›´æ¥å­˜å–-API-Server"><a href="#ä½¿ç”¨æ†‘è­‰ç›´æ¥å­˜å–-API-Server" class="headerlink" title="ä½¿ç”¨æ†‘è­‰ç›´æ¥å­˜å– API Server"></a>ä½¿ç”¨æ†‘è­‰ç›´æ¥å­˜å– API Server</h2><p>ä¸é€é kubeconfigï¼Œå¯ä½¿ç”¨ <code>curl</code> æˆ– <code>kubectl</code> æ˜ç¢ºæŒ‡å®šæ†‘è­‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl https://my-kube-playground:6443/api/v1/pods \</span><br><span class="line">  --key admin.key \</span><br><span class="line">  --cert admin.crt \</span><br><span class="line">  --cacert ca.crt</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods \</span><br><span class="line">  --server my-kube-playground:6443 \</span><br><span class="line">  --client-key admin.key \</span><br><span class="line">  --client-certificate admin.crt \</span><br><span class="line">  --certificate-authority ca.crt</span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨-kubeconfig-å­˜å–é›†ç¾¤"><a href="#ä½¿ç”¨-kubeconfig-å­˜å–é›†ç¾¤" class="headerlink" title="ä½¿ç”¨ kubeconfig å­˜å–é›†ç¾¤"></a>ä½¿ç”¨ kubeconfig å­˜å–é›†ç¾¤</h2><p>é è¨­æƒ…æ³ä¸‹ï¼Œkubectl æœƒå¾ä»¥ä¸‹è·¯å¾‘è¼‰å…¥è¨­å®šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$HOME/.kube/config</span><br></pre></td></tr></table></figure>

<p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ â€“kubeconfig æŒ‡å®šå…¶ä»–é…ç½®æª”ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods --kubeconfig=my-cluster-config.yaml</span><br><span class="line">kubectl get pods   <span class="comment"># é è¨­ä½¿ç”¨ $HOME/.kube/config</span></span><br></pre></td></tr></table></figure>

<img src="/2025/07/08/K8s-Advanced/K8s-Security-KubeConfig/KubeConfig_1.webp" class="">

<hr>
<h1 id="KubeConfig-çµæ§‹èªªæ˜"><a href="#KubeConfig-çµæ§‹èªªæ˜" class="headerlink" title="KubeConfig çµæ§‹èªªæ˜"></a>KubeConfig çµæ§‹èªªæ˜</h1><img src="/2025/07/08/K8s-Advanced/K8s-Security-KubeConfig/KubeConfig_2.webp" class="">
<img src="/2025/07/08/K8s-Advanced/K8s-Security-KubeConfig/KubeConfig_3.webp" class="">

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">dev-user@google</span></span><br><span class="line"></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-kube-playground</span></span><br><span class="line">  <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority:</span> <span class="string">/etc/kubernetes/pki/ca.crt</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://my-kube-playground:6443</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> [<span class="string">another-cluster</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-kube-admin@my-kube-playground</span></span><br><span class="line">  <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">my-kube-playground</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">my-kube-admin</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> [<span class="string">another-context</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-kube-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate:</span> <span class="string">/etc/kubernetes/pki/users/admin.crt</span></span><br><span class="line">    <span class="attr">client-key:</span> <span class="string">/etc/kubernetes/pki/users/admin.key</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> [<span class="string">another-user</span>]</span><br></pre></td></tr></table></figure>

<h2 id="YAML-ä¸­çš„-current-context"><a href="#YAML-ä¸­çš„-current-context" class="headerlink" title="YAML ä¸­çš„ current-context"></a>YAML ä¸­çš„ current-context</h2><table>
<thead>
<tr>
<th>å•é¡Œ</th>
<th>è§£ç­”</th>
</tr>
</thead>
<tbody><tr>
<td><code>current-context</code><br>å¯ä»¥æ”¾å¤šå€‹å—ï¼Ÿ</td>
<td>âŒ ä¸è¡Œï¼Œcurrent-context åªèƒ½æœ‰ä¸€å€‹ã€‚ä»£è¡¨ç•¶å‰é è¨­ä½¿ç”¨çš„ contextã€‚</td>
</tr>
<tr>
<td><code>current-context</code><br>ä¸æ”¾æœƒæ€æ¨£ï¼Ÿ</td>
<td>é è¨­æƒ…æ³ä¸‹ <code>kubectl</code> æœƒç„¡æ³•çŸ¥é“è¦ä½¿ç”¨å“ªä¸€å€‹ contextï¼ŒåŸ·è¡Œæœƒå‡ºéŒ¯æˆ–éœ€æ‰‹å‹•æŒ‡å®š <code>--context</code>ã€‚</td>
</tr>
</tbody></table>
<p>è‹¥è¦åˆ‡æ› <code>current-context</code>ï¼Œè«‹ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config use-context prod-user@production</span><br><span class="line"></span><br><span class="line">kubectl config -h</span><br></pre></td></tr></table></figure>

<h2 id="Context-èˆ‡-Namespace-ç¶å®š"><a href="#Context-èˆ‡-Namespace-ç¶å®š" class="headerlink" title="Context èˆ‡ Namespace ç¶å®š"></a>Context èˆ‡ Namespace ç¶å®š</h2><img src="/2025/07/08/K8s-Advanced/K8s-Security-KubeConfig/KubeConfig_4.webp" class="">

<p>æ¯å€‹ context å¯ä»¥ç¶å®šä¸åŒçš„å‘½åç©ºé–“ï¼Œé”åˆ°åŒä¸€å€‹ cluster ä¸Šçš„å¤šç§Ÿæˆ¶ç®¡ç†ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-kube-admin@my-kube-playground</span></span><br><span class="line">  <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">my-kube-playground</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">my-kube-admin</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">finance</span>  <span class="comment"># é è¨­ namespace</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>è‹¥ context ä¸­æœªè¨­å®š namespaceï¼Œå‰‡é è¨­ç‚º defaultã€‚<br>åœ¨ kubeconfig YAML çµæ§‹ä¸­ï¼Œ<mark>namespace åªèƒ½å‡ºç¾åœ¨ contexts: è£¡çš„ context å­æ¬„ä½ä¸­</mark>ã€‚</p>
</blockquote>
<div class="note info"><p><strong>Namespace å„ªå…ˆæ¬Šèªªæ˜</strong>ï¼š<br>è‹¥åŒæ™‚åœ¨ <code>context</code> è¨­å®šèˆ‡ CLI ä¸­æŒ‡å®š namespaceï¼Œkubectl æœƒ<strong>å„ªå…ˆæ¡ç”¨ CLI çš„ <code>--namespace</code></strong> åƒæ•¸ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods --namespace=dev</span><br><span class="line"><span class="comment"># è¦†è“‹ kubeconfig è£¡ context çš„ namespace è¨­å®š</span></span><br></pre></td></tr></table></figure></div>

<h2 id="æ”¯æ´-base64-ç·¨ç¢¼æ†‘è­‰èˆ‡æ†‘è­‰å…§åµŒ"><a href="#æ”¯æ´-base64-ç·¨ç¢¼æ†‘è­‰èˆ‡æ†‘è­‰å…§åµŒ" class="headerlink" title="æ”¯æ´ base64 ç·¨ç¢¼æ†‘è­‰èˆ‡æ†‘è­‰å…§åµŒ"></a>æ”¯æ´ base64 ç·¨ç¢¼æ†‘è­‰èˆ‡æ†‘è­‰å…§åµŒ</h2><p>ä½ å¯ä»¥ä½¿ç”¨ certificate-authority-data æˆ– client-certificate-data ç›´æ¥åµŒå…¥ base64 ç·¨ç¢¼çš„å…§å®¹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> [<span class="string">base64</span> <span class="string">ç·¨ç¢¼çš„</span> <span class="string">ca.crt</span>]</span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://my-kube-playground:6443</span></span><br><span class="line"></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-kube-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> [<span class="string">base64</span> <span class="string">ç·¨ç¢¼çš„</span> <span class="string">admin.crt</span>]</span><br><span class="line">    <span class="attr">client-key-data:</span> [<span class="string">base64</span> <span class="string">ç·¨ç¢¼çš„</span> <span class="string">admin.key</span>]</span><br></pre></td></tr></table></figure>

<p>ç”¢å‡º base64 ç·¨ç¢¼æ–¹å¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">base64</span> -w 0 ca.crt       <span class="comment"># -w 0 è¡¨ç¤ºä¸æ›è¡Œ</span></span><br><span class="line"><span class="built_in">base64</span> -w 0 admin.crt</span><br><span class="line"><span class="built_in">base64</span> -w 0 admin.key</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="built_in">base64</span> ca.crt | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="built_in">base64</span> admin.crt | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="built_in">base64</span> admin.key | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure>



<h1 id="å¸¸ç”¨æŒ‡ä»¤å½™ç¸½"><a href="#å¸¸ç”¨æŒ‡ä»¤å½™ç¸½" class="headerlink" title="å¸¸ç”¨æŒ‡ä»¤å½™ç¸½"></a>å¸¸ç”¨æŒ‡ä»¤å½™ç¸½</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç›®å‰çš„ KubeConfig çš„è¨­å®šå…§å®¹</span></span><br><span class="line">kubectl config view</span><br><span class="line">kubectl config view --kubeconfig=my-cluster-config.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ä¸åŒçš„ config æª”</span></span><br><span class="line">kubectl --kubeconfig=/path/to/my-cluster-config.yaml get pods</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ› context</span></span><br><span class="line">kubectl config use-context dev-user@google</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰ context</span></span><br><span class="line">kubectl config get-contexts</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ“ context åç¨±</span></span><br><span class="line">kubectl config get-contexts -o name</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¨­å®šé è¨­ namespace</span></span><br><span class="line">kubectl config set-context my-context --namespace=finance</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å»ºç«‹æ–°çš„ context</span></span><br><span class="line">kubectl config set-context dev@dev-cluster \</span><br><span class="line">  --cluster=dev-cluster \</span><br><span class="line">  --user=dev-user \</span><br><span class="line">  --namespace=dev-namespace</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»ºç«‹æ–°çš„ä½¿ç”¨è€…ï¼ˆæ­é… token æˆ– certï¼‰</span></span><br><span class="line">kubectl config set-credentials dev-user \</span><br><span class="line">  --client-certificate=./dev-user.crt \</span><br><span class="line">  --client-key=./dev-user.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»ºç«‹æ–°çš„ cluster è¨­å®š</span></span><br><span class="line">kubectl config set-cluster dev-cluster \</span><br><span class="line">  --server=https://dev.example.com:6443 \</span><br><span class="line">  --certificate-authority=./ca.crt</span><br></pre></td></tr></table></figure>

<h1 id="å°çµ"><a href="#å°çµ" class="headerlink" title="å°çµ"></a>å°çµ</h1><ul>
<li>kubeconfig æ”¯æ´å¤šå€‹ä½¿ç”¨è€…ã€å¤šå€‹å¢é›†ã€å¤šçµ„ context</li>
<li>current-context åªèƒ½å­˜åœ¨ä¸€å€‹ï¼Œæ˜¯é è¨­æ“ä½œå°è±¡</li>
<li>context å¯ç¶å®š clusterã€userã€namespace</li>
<li>æ†‘è­‰å¯ä»¥ä½¿ç”¨è·¯å¾‘æˆ– base64 æ–¹å¼è¨­å®š</li>
<li>ä½¿ç”¨ kubectl config ç®¡ç†å¤šç’°å¢ƒæ“ä½œéå¸¸æ–¹ä¾¿</li>
<li>context å¯æŒ‡å®šé è¨­ namespaceï¼Œäº¦å¯åœ¨ CLI ä½¿ç”¨ <code>--namespace</code> è‡¨æ™‚è¦†è“‹ã€‚</li>
</ul>
<hr>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol>
<li><a href="https://yuminlee2.medium.com/kubernetes-kubeconfig-file-4aabe3b04ade">Kubernetes: Kubeconfig File</a></li>
</ol>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>kubeconfig</tag>
        <tag>client-certificate</tag>
        <tag>kubectl</tag>
        <tag>context</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s Security | Network Policy</title>
    <url>/2025/07/11/K8s-Advanced/K8s-Security-Network-Policy/</url>
    <content><![CDATA[<h1 id="Traffic"><a href="#Traffic" class="headerlink" title="Traffic"></a>Traffic</h1><h2 id="Pod-Networking-è¡Œç‚ºï¼ˆé è¨­ï¼‰"><a href="#Pod-Networking-è¡Œç‚ºï¼ˆé è¨­ï¼‰" class="headerlink" title="Pod Networking è¡Œç‚ºï¼ˆé è¨­ï¼‰"></a>Pod Networking è¡Œç‚ºï¼ˆé è¨­ï¼‰</h2><ul>
<li><mark>K8s é è¨­å…è¨± <strong>æ‰€æœ‰ Pod ä¹‹é–“äº’ç›¸é€šè¨Š</strong>ï¼Œç„¡è«–æ˜¯å¦è·¨ Node</mark></li>
<li>ä¸€æ—¦æŸå€‹ Pod è¢«ä»»ä¸€ <code>NetworkPolicy</code> åŒ¹é…åˆ°ï¼Œå…¶ç¶²è·¯è¡Œç‚ºå°‡é€²å…¥é è¨­æ‹’çµ•æ¨¡å¼ï¼ˆdeny all not explicitly allowedï¼‰<ul>
<li>é€²å…¥ã€Œå°é–‰å¼ç¶²è·¯æ¨¡å‹ã€ï¼Œ<strong>æœªè¢«å…è¨±çš„æµé‡å°‡é è¨­è¢«å°é–</strong>ï¼ˆdeny by defaultï¼‰ã€‚</li>
</ul>
</li>
<li>å…¶ä»–æœªåŒ¹é…åˆ°çš„ Pod å‰‡ä»ç„¶æ˜¯å…¨é–‹æ”¾ã€‚</li>
<li>è‹¥æœªè¨­å®š <code>NetworkPolicy</code>ï¼Œç­‰åŒæ–¼ã€Œå…¨é–‹æ”¾ã€ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>æ¢ä»¶</th>
<th>ç¶²è·¯è¡Œç‚º</th>
</tr>
</thead>
<tbody><tr>
<td>æ²’æœ‰ä»»ä½• NetworkPolicy</td>
<td>æ‰€æœ‰ Pod çš†å¯äº’é€š</td>
</tr>
<tr>
<td>åªå°æŸäº› Pod è¨­å®š NetworkPolicy</td>
<td>è©²äº› Pod é€²å…¥å°é–‰æ¨¡å¼ï¼Œå…¶ä»– Pod ç…§å¸¸äº’é€š</td>
</tr>
</tbody></table>
<h2 id="Ingress-vs-Egress"><a href="#Ingress-vs-Egress" class="headerlink" title="Ingress vs Egress"></a>Ingress vs Egress</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">policyTypes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Egress</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>é¡å‹</th>
<th>æ§åˆ¶æ–¹å‘</th>
<th>èªªæ˜ç¯„ä¾‹</th>
<th>å¸¸è¦‹ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td>Ingress</td>
<td>é€²å…¥æµé‡ï¼ˆæ§åˆ¶èª°å¯ä»¥é€²ä¾†ï¼‰</td>
<td>æ§åˆ¶å“ªäº› Pod&#x2F;ä¾†æºå¯ä»¥é€£é€²ä¾†</td>
<td>é™åˆ¶è³‡æ–™åº«åªèƒ½æ¥å—ä¾†è‡ª API çš„æµé‡</td>
</tr>
<tr>
<td>Egress</td>
<td>é›¢é–‹æµé‡ï¼ˆæ§åˆ¶èƒ½é€£èª°ï¼‰</td>
<td>æ§åˆ¶è©² Pod å¯å‘å“ªäº›ç›®çš„åœ°&#x2F;Port ç™¼å‡ºé€£ç·š</td>
<td>é™åˆ¶ Pod åªèƒ½å°å…§éƒ¨æœå‹™æˆ–ç‰¹å®š IP ç™¼å‡ºé€£ç·š</td>
</tr>
</tbody></table>
<blockquote>
<p>âœ… NetworkPolicy æ˜¯å¾ <strong>Pod è§’åº¦å‡ºç™¼</strong>ï¼Œæ±ºå®šã€Œé€™å€‹ Pod <strong>èƒ½è¢«èª°é€£é€²ä¾†</strong>ã€ï¼ˆIngressï¼‰èˆ‡ã€Œ<strong>å®ƒèƒ½å°èª°ç™¼å‡ºé€£ç·š</strong>ã€ï¼ˆEgressï¼‰ã€‚</p>
</blockquote>
<hr>
<h1 id="ğŸ”’-Network-Security"><a href="#ğŸ”’-Network-Security" class="headerlink" title="ğŸ”’ Network Security"></a>ğŸ”’ Network Security</h1><h2 id="å¯¦ä½œï¼šé™åˆ¶-API-Pod-åªèƒ½é€£æ¥-DB"><a href="#å¯¦ä½œï¼šé™åˆ¶-API-Pod-åªèƒ½é€£æ¥-DB" class="headerlink" title="å¯¦ä½œï¼šé™åˆ¶ API Pod åªèƒ½é€£æ¥ DB"></a>å¯¦ä½œï¼šé™åˆ¶ API Pod åªèƒ½é€£æ¥ DB</h2><div class="note info"><p>Qï¼šå¦‚æœä¸å¸Œæœ› web pod èƒ½ç›´æ¥æºé€š db podï¼Œè©²æ€éº¼åšï¼Ÿ<br>Aï¼šdb pod è¨­å®šä¸€å€‹ NetworkPolicyï¼Œåªå…è¨± API Pod ç™¼é€ 3306 port é€£ç·šçµ¦ DB Podã€‚</p>
<ul>
<li>Allow Ingress Traffic from API Pod on port 3306</li>
<li>Egress ä¸è¨­å®šï¼ˆé è¨­å¯ä»¥äº’é€šï¼‰</li>
</ul>
<p>å¸¸è¦‹èª¤å€</p>
<ul>
<li>è¨±å¤šäººæœƒèª¤ä»¥ç‚ºæ²’å®šç¾© Egress Policy å°±ç„¡æ³•é€£å¤–ï¼Œå…¶å¯¦ <strong>é è¨­é‚„æ˜¯èƒ½é€£</strong>ã€‚</li>
<li>åªæœ‰ç•¶æŸå€‹ <code>policyType: Egress</code> å­˜åœ¨æ™‚ï¼ŒEgress æ‰æœƒè¢«é™åˆ¶ã€‚</li>
</ul>
<p>Policy èˆ‡ Service æ²’æœ‰ç›´æ¥é—œè¯çš„æé†’</p>
<ul>
<li>NetworkPolicy æ˜¯ä½œç”¨åœ¨ Pod å±¤ï¼Œè€Œé Serviceï¼›å³ä½¿ Service å­˜åœ¨ï¼Œè‹¥å°æ‡‰çš„ Pod è¢«å°é–ï¼Œé€£ç·šä»æœƒå¤±æ•—ã€‚</li>
</ul>
</div>

<h3 id="db-policy-yaml"><a href="#db-policy-yaml" class="headerlink" title="db-policy.yaml"></a>db-policy.yaml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span>  <span class="comment"># å¼·èª¿ Label çš„ match æ¢ä»¶æ˜¯ã€Œå®Œå…¨ç¬¦åˆã€</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">db</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">role:</span> <span class="string">api</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">podSelector:</span></span><br><span class="line">  <span class="attr">matchLabels:</span>  <span class="comment"># åªæœƒåŒ¹é… role=db çš„ Pod</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">db</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ‰€æœ‰ <code>role=db</code> çš„ Podï¼ˆå¦‚ <code>mysql</code>ï¼‰å°‡åªèƒ½æ¥å— <code>role=api</code> çš„ Pod ç™¼é€é€£ç·šï¼ˆä¸”é™ port 3306ï¼‰ï¼›å…¶ä»–ä¾†æºï¼ˆå¦‚ <code>web</code>ï¼‰éƒ½æœƒè¢«é˜»æ“‹ã€‚</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">podSelector:</span></span><br><span class="line">  <span class="attr">matchLabels:</span>  <span class="comment"># åƒ…åŒ¹é…åŒæ™‚å…·æœ‰ role=db ä¸” tier=backend çš„ Podï¼ˆAND æ¢ä»¶ï¼‰</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">backend</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Pod æœ‰ä¸Šè¿°å…©å€‹ labelï¼Œä¹Ÿä»æœƒ match åˆ°åªæŒ‡å®š <code>role: db</code> çš„ policyã€‚</p>
</blockquote>
<h3 id="å»ºç«‹-NetworkPolicy"><a href="#å»ºç«‹-NetworkPolicy" class="headerlink" title="å»ºç«‹ NetworkPolicy"></a>å»ºç«‹ NetworkPolicy</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f db-policy.yaml</span><br></pre></td></tr></table></figure>

<h2 id="é©—è­‰-NetworkPolicy-æ˜¯å¦ç”Ÿæ•ˆ"><a href="#é©—è­‰-NetworkPolicy-æ˜¯å¦ç”Ÿæ•ˆ" class="headerlink" title="é©—è­‰ NetworkPolicy æ˜¯å¦ç”Ÿæ•ˆ"></a>é©—è­‰ NetworkPolicy æ˜¯å¦ç”Ÿæ•ˆ</h2><h3 id="ä½¿ç”¨-busybox-å»ºç«‹æ¸¬è©¦-Pod"><a href="#ä½¿ç”¨-busybox-å»ºç«‹æ¸¬è©¦-Pod" class="headerlink" title="ä½¿ç”¨ busybox å»ºç«‹æ¸¬è©¦ Pod"></a>ä½¿ç”¨ busybox å»ºç«‹æ¸¬è©¦ Pod</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å»ºç«‹æœ‰ nc æŒ‡ä»¤çš„æ¸¬è©¦ pod</span></span><br><span class="line">kubectl run testbox --<span class="built_in">rm</span> -it --image=busybox:1.28 -- /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ nc æ¸¬è©¦é€£ç·š</span></span><br><span class="line">nc -zv db-service 3306</span><br></pre></td></tr></table></figure>

<h3 id="å˜—è©¦å¾-role-web-çš„-Pod-ç™¼é€é€£ç·š"><a href="#å˜—è©¦å¾-role-web-çš„-Pod-ç™¼é€é€£ç·š" class="headerlink" title="å˜—è©¦å¾ role&#x3D;web çš„ Pod ç™¼é€é€£ç·š"></a>å˜—è©¦å¾ role&#x3D;web çš„ Pod ç™¼é€é€£ç·š</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">telnet db-service 3306   <span class="comment"># é æœŸæœƒå¤±æ•—</span></span><br></pre></td></tr></table></figure>

<h3 id="å¾-role-api-çš„-Pod-å˜—è©¦é€£ç·š"><a href="#å¾-role-api-çš„-Pod-å˜—è©¦é€£ç·š" class="headerlink" title="å¾ role&#x3D;api çš„ Pod å˜—è©¦é€£ç·š"></a>å¾ role&#x3D;api çš„ Pod å˜—è©¦é€£ç·š</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> api-pod -- nc -zv db-service 3306  <span class="comment"># âœ… é æœŸæˆåŠŸ</span></span><br></pre></td></tr></table></figure>

<h2 id="Egress-å¯¦ä½œç¯„ä¾‹ï¼ˆé¸æ“‡æ€§è£œå……ï¼‰"><a href="#Egress-å¯¦ä½œç¯„ä¾‹ï¼ˆé¸æ“‡æ€§è£œå……ï¼‰" class="headerlink" title="Egress å¯¦ä½œç¯„ä¾‹ï¼ˆé¸æ“‡æ€§è£œå……ï¼‰"></a>Egress å¯¦ä½œç¯„ä¾‹ï¼ˆé¸æ“‡æ€§è£œå……ï¼‰</h2><p>è‹¥ä½ å¸Œæœ›é™åˆ¶ Pod ä¸å¾—å°å¤–éƒ¨ï¼ˆå¦‚ç¶²éš›ç¶²è·¯ï¼‰é€£ç·š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">block-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">restricted</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> []   <span class="comment"># ç©ºä»£è¡¨ä¸å…è¨±ä»»ä½•ç›®æ¨™ã€‚ç¦æ­¢æ‰€æœ‰ Egress</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>âš ï¸ è¦è®“ Egress æœ‰æ•ˆï¼ŒKubernetes å¿…é ˆæ­é…æœ‰æ”¯æ´ Egress æ§åˆ¶çš„ CNIï¼Œå¦‚ Calicoã€Ciliumã€‚<br>âš ï¸ K8s æœ¬èº«ä¸è™•ç†å°åŒ…è½‰ç™¼ï¼Œéœ€é€é CNI æ’ä»¶å¯¦ç¾å°åŒ…éæ¿¾ã€‚</p>
</blockquote>
<h1 id="å¸¸è¦‹å°æŠ€å·§èˆ‡æ³¨æ„äº‹é …"><a href="#å¸¸è¦‹å°æŠ€å·§èˆ‡æ³¨æ„äº‹é …" class="headerlink" title="å¸¸è¦‹å°æŠ€å·§èˆ‡æ³¨æ„äº‹é …"></a>å¸¸è¦‹å°æŠ€å·§èˆ‡æ³¨æ„äº‹é …</h1><ul>
<li><code>podSelector</code> åªèƒ½ç¯©é¸ åŒ namespace çš„ Pod</li>
<li>è·¨ namespace çš„æ§åˆ¶éœ€æ­é… <code>namespaceSelector</code><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">from:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">backend</span>  <span class="comment"># å…è¨± team=frontend namespace ä¸­çš„ä»»æ„ Pod å­˜å– db</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯æ­é… <code>namespaceSelector + podSelector</code> ç²¾ç¢ºæ§åˆ¶è·¨ namespace æµé‡<br>è£œå……ï¼šNamespace Label é è¨­ä¸æœƒå­˜åœ¨ï¼Œéœ€æ‰‹å‹•æ‰“ä¸Š</p>
</blockquote>
</li>
<li>ä½ ä¹Ÿå¯ä»¥è¨­å®š IP-based æ§åˆ¶ï¼ˆå¦‚é™åˆ¶ Egress åˆ°å¤–éƒ¨ IPï¼‰</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">ingress:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">      <span class="attr">matchLabels:</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">api</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">      <span class="attr">cidr:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">except:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.5</span><span class="string">/32</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¤šå€‹ from è¦–ç‚º ORï¼Œåªè¦ç¬¦åˆå…¶ä¸­ä¸€æ¢å³å¯ã€‚</p>
</blockquote>
<h2 id="è·¨-Namespace-æ§åˆ¶å®Œæ•´ç¯„ä¾‹ï¼ˆçµåˆ-podSelector-namespaceSelectorï¼‰"><a href="#è·¨-Namespace-æ§åˆ¶å®Œæ•´ç¯„ä¾‹ï¼ˆçµåˆ-podSelector-namespaceSelectorï¼‰" class="headerlink" title="è·¨ Namespace æ§åˆ¶å®Œæ•´ç¯„ä¾‹ï¼ˆçµåˆ podSelector + namespaceSelectorï¼‰"></a>è·¨ Namespace æ§åˆ¶å®Œæ•´ç¯„ä¾‹ï¼ˆçµåˆ podSelector + namespaceSelectorï¼‰</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">from:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">backend</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">api</span></span><br></pre></td></tr></table></figure>

<h2 id="å¹«-Namespace-æ‰“-Label"><a href="#å¹«-Namespace-æ‰“-Label" class="headerlink" title="å¹« Namespace æ‰“ Label"></a>å¹« Namespace æ‰“ Label</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl label namespace backend team=backend</span><br></pre></td></tr></table></figure>

<h2 id="Ingress-Egress-æª¢æŸ¥æŠ€å·§è£œå……"><a href="#Ingress-Egress-æª¢æŸ¥æŠ€å·§è£œå……" class="headerlink" title="Ingress&#x2F;Egress æª¢æŸ¥æŠ€å·§è£œå……"></a>Ingress&#x2F;Egress æª¢æŸ¥æŠ€å·§è£œå……</h2><p>å¯¦å‹™èˆ‡ CKA è€ƒè©¦ä¸­ï¼Œå¿«é€Ÿæ’æŸ¥ ingress&#x2F;egress å•é¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é©—è­‰æ˜¯å¦å¥—ç”¨</span></span><br><span class="line">kubectl get networkpolicy -A</span><br><span class="line">kubectl describe networkpolicy &lt;policy-name&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pod -o wide</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç¢ºèª Pod IP å’Œ Labelï¼Œæ­é… nc, curl æ¸¬è©¦ç«¯é»é€šä¸é€šã€‚</p>
</blockquote>
<h1 id="CKA-è€ƒè©¦æ€éº¼è€ƒï¼Ÿ"><a href="#CKA-è€ƒè©¦æ€éº¼è€ƒï¼Ÿ" class="headerlink" title="CKA è€ƒè©¦æ€éº¼è€ƒï¼Ÿ"></a>CKA è€ƒè©¦æ€éº¼è€ƒï¼Ÿ</h1><p>CKA å¸¸è¦‹é¡Œå‹å¦‚ä¸‹ï¼š<br>â˜‘ï¸ çµ¦ä½ ä¸€çµ„ Pod Labelï¼Œè¦ä½ é™åˆ¶æŸäº› Pod çš„é€²å…¥æµé‡ï¼ˆIngressï¼‰<br>â˜‘ï¸ é…ç½® NetworkPolicy è®“ Pod åªèƒ½å¾ç‰¹å®šä¾†æº å­˜å– DB<br>â˜‘ï¸ æŸ¥ Pod ç„¡æ³•é€£ç·šï¼Œè¦ä½ æ’æŸ¥ <code>NetworkPolicy</code> æ˜¯å¦é™åˆ¶å¤ªåš´<br>â˜‘ï¸ é¸æ“‡æ€§ï¼šé™åˆ¶ Pod ä¸å¾—é€£å¤–ï¼ˆEgress denyï¼‰</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Q: è®“ role=frontend çš„ Pod åªèƒ½é€£ç·šåˆ° 10.10.10.0/24 çš„æŸå€‹å¤–éƒ¨ API</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br></pre></td></tr></table></figure>

<p>é‡é»æŠ€å·§ï¼š</p>
<ol>
<li>ç†Ÿæ‚‰ <code>podSelector</code> æ­é… <code>matchLabels</code></li>
<li>ç†Ÿç·´ <code>kubectl apply -f xxx.yaml</code></li>
<li>é©—è­‰æŠ€å·§ï¼š<code>nc</code>, <code>telnet</code>, <code>curl</code>, <code>kubectl exec</code></li>
</ol>
<h1 id="å°çµ"><a href="#å°çµ" class="headerlink" title="å°çµ"></a>å°çµ</h1><ul>
<li>NetworkPolicy æ˜¯æ§åˆ¶ Pod é–“é€šè¨Šçš„å¼·å¤§å·¥å…·ï¼Œè®“ä½ èƒ½å¯¦ä½œå¾®æœå‹™çš„æœ€å°ä¿¡ä»»åŸå‰‡ï¼ˆZero Trustï¼‰</li>
<li>é è¨­æƒ…æ³ä¸‹ Pod å…¨é–‹æ”¾é€šè¨Šï¼Œè¨­å®šä»»ä¸€ Policy å¾Œæœƒè§¸ç™¼é è¨­æ‹’çµ•è¡Œç‚º</li>
<li>å»ºè­°å¾ DB ç­‰æ•æ„Ÿæœå‹™é–‹å§‹è¨­å®šé˜²è­·ï¼ˆIngressï¼‰ï¼Œé€æ­¥æ“´å±•åˆ° Egress æ§åˆ¶</li>
<li>è€ƒè©¦é‡è¦–ï¼šYAML å¯«æ³• + é©—è­‰é€šè¨Šæ˜¯å¦æˆåŠŸ + Label é¸æ“‡å™¨èªæ³•ç†è§£</li>
</ul>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>NetworkPolicy</tag>
        <tag>Ingress</tag>
        <tag>Egress</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s Security | API Groups</title>
    <url>/2025/07/08/K8s-Advanced/K8s-Security-API-Groups/</url>
    <content><![CDATA[<h1 id="Kubernetes-API-Groups-æ¦‚è¿°"><a href="#Kubernetes-API-Groups-æ¦‚è¿°" class="headerlink" title="Kubernetes API Groups æ¦‚è¿°"></a>Kubernetes API Groups æ¦‚è¿°</h1><p>Kubernetes API Server å°å¤–æä¾›çš„ REST APIï¼Œæœƒä¾æ“šä¸åŒè³‡æºé¡å‹ï¼ŒåŠƒåˆ†ç‚ºä¸åŒçš„ API Groupã€‚</p>
<p>å¸¸è¦‹çš„ API è·¯å¾‘å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>è·¯å¾‘</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>/version</code></td>
<td>é¡¯ç¤º API Server çš„ç‰ˆæœ¬è³‡è¨Š</td>
</tr>
<tr>
<td><code>/healthz</code></td>
<td>å¥åº·æª¢æŸ¥ç«¯é»</td>
</tr>
<tr>
<td><code>/metrics</code></td>
<td>å¢é›†ç›£æ§æŒ‡æ¨™ï¼ŒPrometheus ç­‰å¯å­˜å–æ­¤è·¯å¾‘</td>
</tr>
<tr>
<td><code>/api</code></td>
<td>ä»£è¡¨ <strong>Core Group (ç„¡åç¨±)</strong> çš„è³‡æº</td>
</tr>
<tr>
<td><code>/apis</code></td>
<td>ä»£è¡¨ <strong>Named Groups</strong>ï¼Œç”¨æ–¼å»¶ä¼¸è³‡æº</td>
</tr>
</tbody></table>
<h1 id="API-åˆ†çµ„è©³è§£"><a href="#API-åˆ†çµ„è©³è§£" class="headerlink" title="API åˆ†çµ„è©³è§£"></a>API åˆ†çµ„è©³è§£</h1><h2 id="apiï¼šCore-Groupï¼ˆæ ¸å¿ƒè³‡æºï¼‰"><a href="#apiï¼šCore-Groupï¼ˆæ ¸å¿ƒè³‡æºï¼‰" class="headerlink" title="/apiï¼šCore Groupï¼ˆæ ¸å¿ƒè³‡æºï¼‰"></a><code>/api</code>ï¼šCore Groupï¼ˆæ ¸å¿ƒè³‡æºï¼‰</h2><p>å±¬æ–¼ Kubernetes å…§å»ºçš„æ ¸å¿ƒè³‡æºï¼ŒAPI Group ç‚ºç©ºï¼ˆâ€â€ï¼‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/api/v1/namespaces</span><br><span class="line">/api/v1/pods</span><br><span class="line">/api/v1/services</span><br><span class="line">/api/v1/nodes</span><br><span class="line">/api/v1/configmaps</span><br><span class="line">/api/v1/secrets</span><br><span class="line">/api/v1/persistentvolumes (PV)</span><br><span class="line">/api/v1/persistentvolumeclaims (PVC)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<img src="/2025/07/08/K8s-Advanced/K8s-Security-API-Groups/core_group.jpg" class="">

<h2 id="apisï¼šNamed-Groupsï¼ˆå‘½åè³‡æºçµ„ï¼‰"><a href="#apisï¼šNamed-Groupsï¼ˆå‘½åè³‡æºçµ„ï¼‰" class="headerlink" title="/apisï¼šNamed Groupsï¼ˆå‘½åè³‡æºçµ„ï¼‰"></a><code>/apis</code>ï¼šNamed Groupsï¼ˆå‘½åè³‡æºçµ„ï¼‰</h2><p>Kubernetes ç‚ºäº†æ”¯æ´ <code>æ“´å……æ€§èˆ‡ç‰ˆæœ¬ç®¡ç†</code>ï¼Œå°‡æŸäº›è³‡æºæ‹†åˆ†ç‚ºç¨ç«‹çš„ Groupï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/apis/apps/v1/deployments</span><br><span class="line">/apis/batch/v1/jobs</span><br><span class="line">/apis/extensions/v1beta1/ingresses</span><br><span class="line">/apis/rbac.authorization.k8s.io/v1/roles</span><br><span class="line">/apis/networking.k8s.io/v1/networkpolicies</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥é€éä¸‹åˆ—æŒ‡ä»¤åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ API Groupsï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -s https://kube-master:6443/apis \</span><br><span class="line">  --key admin.key \</span><br><span class="line">  --cert admin.crt \</span><br><span class="line">  --cacert ca.crt | grep <span class="string">&quot;name&quot;</span></span><br></pre></td></tr></table></figure>
<img src="/2025/07/08/K8s-Advanced/K8s-Security-API-Groups/named_group.jpg" class="">

<hr>
<h1 id="API-Server-æ¸¬è©¦ç¯„ä¾‹"><a href="#API-Server-æ¸¬è©¦ç¯„ä¾‹" class="headerlink" title="API Server æ¸¬è©¦ç¯„ä¾‹"></a>API Server æ¸¬è©¦ç¯„ä¾‹</h1><h2 id="ä½¿ç”¨-curl-ç›´æ¥é€£ç·š-API-Server"><a href="#ä½¿ç”¨-curl-ç›´æ¥é€£ç·š-API-Server" class="headerlink" title="ä½¿ç”¨ curl ç›´æ¥é€£ç·š API Server"></a>ä½¿ç”¨ curl ç›´æ¥é€£ç·š API Server</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl https://kube-master:6443/version \</span><br><span class="line">  --key admin.key \</span><br><span class="line">  --cert admin.crt \</span><br><span class="line">  --cacert ca.crt</span><br><span class="line"></span><br><span class="line">curl https://kube-master:6443/api/v1/pods \</span><br><span class="line">  --key admin.key \</span><br><span class="line">  --cert admin.crt \</span><br><span class="line">  --cacert ca.crt</span><br></pre></td></tr></table></figure>

<h2 id="é€šè¨Šè·¯å¾‘æ•´ç†"><a href="#é€šè¨Šè·¯å¾‘æ•´ç†" class="headerlink" title="é€šè¨Šè·¯å¾‘æ•´ç†"></a>é€šè¨Šè·¯å¾‘æ•´ç†</h2><h3 id="1-User-â†’-Kube-API-Serverï¼ˆç›´æ¥ï¼‰"><a href="#1-User-â†’-Kube-API-Serverï¼ˆç›´æ¥ï¼‰" class="headerlink" title="1. User â†’ Kube API Serverï¼ˆç›´æ¥ï¼‰"></a>1. User â†’ Kube API Serverï¼ˆç›´æ¥ï¼‰</h3><p>é©åˆ debug æˆ–æ†‘è­‰é©—è­‰æ¸¬è©¦ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl https://localhost:6443 \</span><br><span class="line">  --key admin.key \</span><br><span class="line">  --cert admin.crt \</span><br><span class="line">  --cacert ca.crt</span><br></pre></td></tr></table></figure>

<h3 id="2-User-â†’-kubectl-proxy-â†’-Kube-API-Server"><a href="#2-User-â†’-kubectl-proxy-â†’-Kube-API-Server" class="headerlink" title="2. User â†’ kubectl proxy â†’ Kube API Server"></a>2. User â†’ <code>kubectl proxy</code> â†’ Kube API Server</h3><p>è‹¥ä¸æ–¹ä¾¿æ“ä½œæ†‘è­‰ï¼Œå¯ä½¿ç”¨ kubectl proxy è½‰ç™¼é€£ç·šï¼ˆæœ¬æ©Ÿèµ· proxyï¼Œç„¡éœ€ TLS é©—è­‰ï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl proxy</span><br><span class="line"><span class="comment"># Starting to serve on 127.0.0.1:8001</span></span><br><span class="line"></span><br><span class="line">curl http://localhost:8001/api/v1/pods</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>kubectl proxy</code> é©åˆé–‹ç™¼è€…å¿«é€Ÿæ¸¬è©¦ K8s APIï¼Œç„¡éœ€æ‰‹å‹•è™•ç† TLS æ†‘è­‰ï¼Œä¸é©åˆæš´éœ²åœ¨ production ç’°å¢ƒã€‚</p>
</blockquote>
<div class="note info"><p><strong>Kube Proxy â‰  Kubectl Proxy</strong></p>
<table>
<thead>
<tr>
<th>åç¨±</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>kubectl proxy</code></td>
<td>CLI å·¥å…·ï¼Œå°‡æœ¬åœ° 8001 port å°æ‡‰åˆ° K8s API Serverï¼Œç„¡éœ€ TLS é©—è­‰</td>
</tr>
<tr>
<td><code>kube-proxy</code></td>
<td>Kubernetes å…ƒä»¶ä¹‹ä¸€ï¼Œè² è²¬è½‰é€ Service ç¶²è·¯æµé‡åˆ°å¾Œç«¯ Pod</td>
</tr>
</tbody></table>
</div>

<h2 id="å¸¸ç”¨æŒ‡ä»¤"><a href="#å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="å¸¸ç”¨æŒ‡ä»¤"></a>å¸¸ç”¨æŒ‡ä»¤</h2><h3 id="kubectl-explain"><a href="#kubectl-explain" class="headerlink" title="kubectl explain"></a>kubectl explain</h3><p>æŸ¥è©¢è³‡æºå°æ‡‰çš„ API Groupï¼ˆé–‹ç™¼èˆ‡ RBAC å¸¸ç”¨ï¼‰</p>
<blockquote>
<p>å¿«é€ŸæŸ¥è©¢æŸè³‡æºå°æ‡‰çš„ API Group èˆ‡ç‰ˆæœ¬ã€‚</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl explain deployment</span><br><span class="line"><span class="comment"># NAME:         deployment.apps</span></span><br><span class="line"><span class="comment"># API Version:  apps/v1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è©¢å­æ¬„ä½</span></span><br><span class="line">kubectl explain deployment.spec.template.spec.containers</span><br></pre></td></tr></table></figure>

<h3 id="kubectl-api-resources"><a href="#kubectl-api-resources" class="headerlink" title="kubectl api-resources"></a>kubectl api-resources</h3><p>æŸ¥çœ‹æ‰€æœ‰å¯ç”¨è³‡æº</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é¡¯ç¤ºç•¶å‰ kube-apiserver æ‰€æ”¯æ´çš„è³‡æºæ¸…å–®åŠå…¶å°æ‡‰ API Groupã€‚</span></span><br><span class="line">kubectl api-resources</span><br></pre></td></tr></table></figure>
<h3 id="é€²éšæŠ€å·§ï¼šæŸ¥è©¢ç‰¹å®šè³‡æºçš„-REST-API-URL"><a href="#é€²éšæŠ€å·§ï¼šæŸ¥è©¢ç‰¹å®šè³‡æºçš„-REST-API-URL" class="headerlink" title="é€²éšæŠ€å·§ï¼šæŸ¥è©¢ç‰¹å®šè³‡æºçš„ REST API URL"></a>é€²éšæŠ€å·§ï¼šæŸ¥è©¢ç‰¹å®šè³‡æºçš„ REST API URL</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get --raw /apis/apps/v1/deployments</span><br></pre></td></tr></table></figure>
<p>æˆ–åˆ—å‡ºæ‰€æœ‰ core è³‡æºï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get --raw /api/v1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¹«åŠ©ä½¿ç”¨è€…ç†è§£ kubectl èƒŒå¾Œå¯¦éš›å‘¼å«çš„ API æ˜¯å“ªä¸€æ¢è·¯å¾‘ã€‚</p>
</blockquote>
<hr>
<h1 id="å°çµ"><a href="#å°çµ" class="headerlink" title="å°çµ"></a>å°çµ</h1><ul>
<li>Kubernetes API åˆ†ç‚ºå…©å¤§é¡å‹ï¼š<ul>
<li><strong>Core Group</strong>ï¼šè·¯å¾‘ç‚º <code>/api</code>ï¼Œå¦‚ podsã€servicesã€nodes</li>
<li><strong>Named Groups</strong>ï¼šè·¯å¾‘ç‚º <code>/apis</code>ï¼Œå¦‚ deploymentsã€rolesã€jobs ç­‰</li>
</ul>
</li>
<li>API Server ä»‹é¢å¯é€é <code>curl</code> é€²è¡Œæ†‘è­‰é©—è­‰æ¸¬è©¦ï¼Œä¹Ÿå¯é€é <code>kubectl proxy</code> é€²è¡Œé–‹ç™¼ç«¯æœ¬æ©Ÿ proxy æ¸¬è©¦<ul>
<li>ä½¿ç”¨ <code>curl</code> + TLS æ†‘è­‰æ¸¬è©¦ API Server å®‰å…¨é€£ç·š</li>
<li>ä½¿ç”¨ <code>kubectl proxy</code> åœ¨æœ¬åœ°å•Ÿå‹• HTTP ä»£ç†ï¼Œå¯çœç•¥ TLS æ†‘è­‰ï¼Œé©åˆé–‹ç™¼éšæ®µ</li>
</ul>
</li>
<li>é–‹ç™¼èˆ‡æ¬Šé™è¨­å®šå¸¸ç”¨å·¥å…·ï¼š<ul>
<li><code>kubectl explain &lt;è³‡æº&gt;</code>ï¼šæŸ¥è©¢è³‡æºæ‰€å±¬çš„ API Group èˆ‡ version</li>
<li><code>kubectl api-resources</code>ï¼šæŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„è³‡æºèˆ‡æ‰€å±¬ Group</li>
<li><code>kubectl get --raw</code>ï¼šå¯æŸ¥è©¢åŸå§‹ API è·¯å¾‘è³‡æ–™</li>
</ul>
</li>
<li>è‡ªè¨‚è³‡æºï¼ˆCRDï¼‰ä¹Ÿæœƒæ›è¼‰æ–¼ <code>/apis</code>ï¼Œå±¬æ–¼ Named Group</li>
<li>æ³¨æ„å€åˆ† <code>kubectl proxy</code> (æœ¬åœ° HTTP proxy) èˆ‡ <code>kube-proxy</code> (cluster service ç¶²è·¯å…ƒä»¶)</li>
</ul>
<p>ğŸ“Œ ä¸‹ä¸€æ­¥å»ºè­°å­¸ç¿’ï¼š<br>RBAC æ¬Šé™æ§åˆ¶ä¸­ <code>apiGroups</code>, <code>resources</code>, <code>verbs</code> å¦‚ä½•å°æ‡‰é€™äº› API åˆ†çµ„</p>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>kubectl</tag>
        <tag>apiserver</tag>
        <tag>api-groups</tag>
        <tag>curl</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s Security | Service Accounts</title>
    <url>/2025/07/10/K8s-Advanced/K8s-Security-Service-Accounts/</url>
    <content><![CDATA[<h1 id="Service-Accounts"><a href="#Service-Accounts" class="headerlink" title="Service Accounts"></a>Service Accounts</h1><h2 id="âœ…-èƒŒæ™¯çŸ¥è­˜èˆ‡è§€å¿µ"><a href="#âœ…-èƒŒæ™¯çŸ¥è­˜èˆ‡è§€å¿µ" class="headerlink" title="âœ… èƒŒæ™¯çŸ¥è­˜èˆ‡è§€å¿µ"></a>âœ… èƒŒæ™¯çŸ¥è­˜èˆ‡è§€å¿µ</h2><ul>
<li>K8s ä¸­çš„æ¯å€‹ Podï¼Œ<strong>é è¨­éƒ½æœƒæ›è¼‰ä¸€å€‹ ServiceAccount</strong>ï¼ˆ<code>default</code>ï¼‰ï¼Œé™¤éåœ¨ pod spec ä¸­å¦è¡ŒæŒ‡å®šã€‚</li>
<li>ServiceAccount æ˜¯ K8s ç‚ºå·¥ä½œè² è¼‰ï¼ˆå¦‚ Podï¼‰æä¾›çš„èº«ä»½è­˜åˆ¥æ–¹å¼ï¼Œç”¨ä¾†èˆ‡ Kubernetes API Server é€šè¨Šã€‚</li>
<li>å¯é€é <strong>RBAC</strong> ç‚º ServiceAccount ç¶å®šé©ç•¶çš„æ¬Šé™ï¼ˆ<code>Role</code> &#x2F; <code>ClusterRole</code>ï¼‰ã€‚</li>
<li>èˆŠç‰ˆä¸­ï¼Œ<strong>ServiceAccount token æœƒä»¥ Secret å½¢å¼è‡ªå‹•æ›è¼‰</strong>åˆ° <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>ï¼Œå¯ç›´æ¥é€éæ­¤ token èˆ‡ API Server æºé€šã€‚</li>
</ul>
<div class="note info"><ul>
<li>Pod èˆ‡å…¶ä½¿ç”¨çš„ ServiceAccount æ˜¯ä¸€å°ä¸€ç¶å®šï¼Œä½†å¤šå€‹ Pod å¯å…±ç”¨åŒä¸€å€‹ ServiceAccountã€‚</li>
<li>èˆŠç‰ˆï¼ˆv1.24 å‰ï¼‰æœƒè‡ªå‹•å»ºç«‹ä¸€å€‹ Secret token ä¸¦æ›è¼‰ï¼›æ–°ç‰ˆï¼ˆv1.24+ï¼‰å‰‡éœ€é€é <code>kubectl create token</code> æ˜ç¢ºå»ºç«‹ã€‚</li>
<li>Token æ˜¯ä»¥ JWT æ ¼å¼å­˜åœ¨ï¼Œå¯ç”¨ä¾†æ¨¡æ“¬ API èªè­‰å‘¼å«ã€‚</li>
</ul>
</div>

<h2 id="å¸¸ç”¨æ“ä½œæŒ‡ä»¤"><a href="#å¸¸ç”¨æ“ä½œæŒ‡ä»¤" class="headerlink" title="å¸¸ç”¨æ“ä½œæŒ‡ä»¤"></a>å¸¸ç”¨æ“ä½œæŒ‡ä»¤</h2><p>æŸ¥è©¢ç›®å‰ namespace ä¸­çš„æ‰€æœ‰ ServiceAccount</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get serviceaccounts</span><br></pre></td></tr></table></figure>

<p>å»ºç«‹ ServiceAccount</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create serviceaccount dashboard-sa</span><br></pre></td></tr></table></figure>

<p>æª¢è¦– ServiceAccount è©³ç´°è³‡è¨Šï¼ˆåŒ…å«é—œè¯ Secretï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe serviceaccount dashboard-sa</span><br></pre></td></tr></table></figure>

<p>é€²éšé©—è­‰ token æ›è¼‰å…§å®¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ SA å°æ‡‰çš„ Secretï¼ˆåƒ…é™ &lt; v1.24ï¼‰</span></span><br><span class="line">kubectl describe secret $(kubectl get secret | grep dashboard-sa | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ Pod æ›è¼‰çš„ SA token è·¯å¾‘</span></span><br><span class="line">kubectl describe pod my-kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># é©—è­‰ token æ˜¯å¦æ­£ç¢ºæ›è¼‰</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it my-kubernetes-dashboard -- <span class="built_in">ls</span> /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">kubectl <span class="built_in">exec</span> -it my-kubernetes-dashboard -- <span class="built_in">cat</span> /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"><span class="comment"># ca.crt  namespace   token</span></span><br></pre></td></tr></table></figure>

<h2 id="å¸¸ç”¨-YAML"><a href="#å¸¸ç”¨-YAML" class="headerlink" title="å¸¸ç”¨ YAML"></a>å¸¸ç”¨ YAML</h2><h3 id="Pod-æŒ‡å®š-ServiceAccount-èˆ‡é©—è­‰-token-æ›è¼‰"><a href="#Pod-æŒ‡å®š-ServiceAccount-èˆ‡é©—è­‰-token-æ›è¼‰" class="headerlink" title="Pod æŒ‡å®š ServiceAccount èˆ‡é©—è­‰ token æ›è¼‰"></a>Pod æŒ‡å®š ServiceAccount èˆ‡é©—è­‰ token æ›è¼‰</h3><p>âœ… æŒ‡å®š ServiceAccount çµ¦ Pod</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dashboard</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">my-kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">dashboard-sa</span></span><br></pre></td></tr></table></figure>

<p>âŒ è‹¥ä¸æƒ³è‡ªå‹•æ›è¼‰ token</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dashboard</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">my-kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">automountServiceAccountToken:</span> <span class="literal">false</span>  <span class="comment"># ç”¨ä¾†åœç”¨è‡ªå‹•æ›è¼‰ SA tokenï¼ˆå¸¸ç”¨æ–¼å¼·åŒ–å®‰å…¨æ€§ï¼‰</span></span><br></pre></td></tr></table></figure>

<p>âœ… é©—è­‰ token æ˜¯å¦æ›è¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it my-kubernetes-dashboard -- <span class="built_in">ls</span> /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">kubectl <span class="built_in">exec</span> -it my-kubernetes-dashboard -- <span class="built_in">cat</span> /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></pre></td></tr></table></figure>

<h3 id="âœ…-èˆ‡-RBAC-çµåˆï¼šæˆæ¬Š-ServiceAccount-æ¬Šé™"><a href="#âœ…-èˆ‡-RBAC-çµåˆï¼šæˆæ¬Š-ServiceAccount-æ¬Šé™" class="headerlink" title="âœ… èˆ‡ RBAC çµåˆï¼šæˆæ¬Š ServiceAccount æ¬Šé™"></a>âœ… èˆ‡ RBAC çµåˆï¼šæˆæ¬Š ServiceAccount æ¬Šé™</h3><p>YAML ç¯„ä¾‹ï¼šç‚ºç‰¹å®š ServiceAccount ç¶å®š ClusterRole</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-sa-binding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dashboard-sa</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">view</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="ServiceAccount-vs-User-Account"><a href="#ServiceAccount-vs-User-Account" class="headerlink" title="ServiceAccount vs User Account"></a>ServiceAccount vs User Account</h1><p>K8s æœ‰å…©ç¨® accountã€‚</p>
<table>
<thead>
<tr>
<th>é¡å‹</th>
<th>ä½¿ç”¨å°è±¡</th>
<th>èº«ä»½ç”¨é€”</th>
<th>å»ºç«‹æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td>User Account</td>
<td>å¯¦é«”ä½¿ç”¨è€…ï¼ˆå¦‚ adminã€developerï¼‰</td>
<td>èˆ‡å¤–éƒ¨ç³»çµ±æ•´åˆï¼ˆå¦‚ OIDC èªè­‰ï¼‰</td>
<td>ä¸ç”± K8s ç®¡ç†</td>
</tr>
<tr>
<td>Service Account</td>
<td>å·¥ä½œè² è¼‰ï¼ˆå¦‚ Podã€CronJobã€Prometheusã€Jenkins ç­‰ï¼‰</td>
<td>æä¾›å…§éƒ¨ API èªè­‰èº«ä»½</td>
<td>ç”± K8s è‡ªå‹•å»ºç«‹èˆ‡ç®¡ç†</td>
</tr>
</tbody></table>
<hr>
<h1 id="v1-22-vs-v1-24"><a href="#v1-22-vs-v1-24" class="headerlink" title="v1.22 vs. v1.24"></a>v1.22 vs. v1.24</h1><h2 id="ğŸ”-v1-22-ServiceAccount-Token-å®‰å…¨æ€§æ”¹é€²"><a href="#ğŸ”-v1-22-ServiceAccount-Token-å®‰å…¨æ€§æ”¹é€²" class="headerlink" title="ğŸ” v1.22+ ServiceAccount Token å®‰å…¨æ€§æ”¹é€²"></a>ğŸ” v1.22+ ServiceAccount Token å®‰å…¨æ€§æ”¹é€²</h2><p>KEP-1205: Bound Service Account Tokens</p>
<ul>
<li>é è¨­ token ç‚ºçŸ­æœŸæœ‰æ•ˆï¼ˆtime-boundï¼‰</li>
<li>token ç¶å®šæ–¼ç‰¹å®š audienceï¼ˆaudience-boundï¼‰</li>
<li>ä¸èƒ½è¢«ç§»ä½œä»–ç”¨ï¼ˆobject-boundï¼‰</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pod my-kubernetes-dashboard -o yaml</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥åœ¨ Pod Spec ä¸­çœ‹åˆ°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">serviceAccountToken:</span><br><span class="line">  expirationSeconds: 3600</span><br></pre></td></tr></table></figure>

<h2 id="ğŸ”-v1-24-æ¸›å°‘-Secret-based-Token-çš„ä½¿ç”¨"><a href="#ğŸ”-v1-24-æ¸›å°‘-Secret-based-Token-çš„ä½¿ç”¨" class="headerlink" title="ğŸ” v1.24+ æ¸›å°‘ Secret-based Token çš„ä½¿ç”¨"></a>ğŸ” v1.24+ æ¸›å°‘ Secret-based Token çš„ä½¿ç”¨</h2><p>KEP-2799: ServiceAccount ä¸å†è‡ªå‹•ç”¢ç”Ÿ Secret-based Token<br>Kubernetes v1.24 èµ·ï¼ŒServiceAccount é è¨­ä¸å†è‡ªå‹•å»ºç«‹ Secret-based tokenï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ï¼š</p>
<ul>
<li>ä½¿ç”¨ <strong>TokenRequest API</strong> å‹•æ…‹å–å¾—çŸ­æœŸæœ‰æ•ˆçš„ Token</li>
<li>Secret å‹ token åƒ…åœ¨éœ€è¦é•·æœŸæ›è¼‰æ™‚æ‰‹å‹•å»ºç«‹</li>
<li>æ¸›å°‘é•·æ•ˆæ†‘è­‰æ´©æ¼é¢¨éšª</li>
</ul>
<p>âœ… å‹•æ…‹å»ºç«‹çŸ­æœŸæœ‰æ•ˆ tokenï¼ˆæ¨è–¦æ–¹å¼ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create token dashboard-sa</span><br></pre></td></tr></table></figure>
<blockquote>
<p>é è¨­æœ‰æ•ˆæœŸé™ç‚º 1 å°æ™‚ï¼ˆå¯ä½¿ç”¨ <code>--duration=2h</code> èª¿æ•´ï¼‰</p>
</blockquote>
<p>âœ… è‹¥ä»éœ€æ‰‹å‹•å»ºç«‹ Secret-based Tokenï¼ˆä¸æ¨è–¦ï¼Œä½†å¿…è¦æ™‚å¯ç”¨ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line"><span class="built_in">type</span>: kubernetes.io/service-account-token</span><br><span class="line">metadata:</span><br><span class="line">  name: mysecretname</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/service-account.name: dashboard-sa</span><br></pre></td></tr></table></figure>
<blockquote>
<p>âš ï¸ å»ºç«‹å¾Œ Kubernetes æœƒè‡ªå‹•å¡«å…¥ token èˆ‡ ca.crtï¼Œä½†é€™å€‹æ–¹å¼åªé©ç”¨æ–¼ç‰¹å®šå ´æ™¯ï¼ˆå¦‚æŸäº›å¤–éƒ¨æ•´åˆï¼‰ï¼Œä¸å»ºè­°ä¸€èˆ¬ä½¿ç”¨è€…ä½¿ç”¨ã€‚</p>
</blockquote>
<div class="note info"><p>v1.22 èˆ‡ v1.24 å·®ç•°è£œå……èªªæ˜</p>
<table>
<thead>
<tr>
<th>Kubernetes ç‰ˆæœ¬</th>
<th>Token è¡Œç‚º</th>
</tr>
</thead>
<tbody><tr>
<td>v1.21 ä»¥ä¸‹</td>
<td>é è¨­å»ºç«‹é•·æ•ˆ Secret token ä¸¦æ›è¼‰</td>
</tr>
<tr>
<td>v1.22</td>
<td>å¼•å…¥ Bound Tokenï¼Œå¯æ§åˆ¶å­˜æ´»æ™‚é–“ &#x2F; ä½¿ç”¨å°è±¡</td>
</tr>
<tr>
<td>v1.24 èµ·</td>
<td>é è¨­ <strong>ä¸å†å»ºç«‹ Secret token</strong>ï¼Œå¿…é ˆç”¨ <code>kubectl create token</code> å‹•æ…‹è«‹æ±‚</td>
</tr>
</tbody></table>
<p>ServiceAccount Token ä½¿ç”¨æµç¨‹ï¼ˆæ–‡å­—æµç¨‹åœ–ï¼‰</p>
<ol>
<li>Pod å•Ÿå‹•å¾Œ â†’ æ›è¼‰ç¶å®šçš„ ServiceAccount</li>
<li>è‹¥ç‰ˆæœ¬ &lt; v1.24 â†’ è‡ªå‹•æ›è¼‰ Secret Token</li>
<li>è‹¥ç‰ˆæœ¬ &gt;&#x3D; v1.24 â†’ å»ºè­°ç”¨ <code>kubectl create token</code> å‹•æ…‹å–å¾—</li>
<li>ä½¿ç”¨ Token â†’ å‘ API Server ç™¼é€å¸¶æœ‰ Bearer Token çš„è«‹æ±‚</li>
</ol>
</div>

<h2 id="å¿«é€Ÿç”¢ç”Ÿæ¸¬è©¦è§’è‰²èˆ‡ç¶å®š"><a href="#å¿«é€Ÿç”¢ç”Ÿæ¸¬è©¦è§’è‰²èˆ‡ç¶å®š" class="headerlink" title="å¿«é€Ÿç”¢ç”Ÿæ¸¬è©¦è§’è‰²èˆ‡ç¶å®š"></a>å¿«é€Ÿç”¢ç”Ÿæ¸¬è©¦è§’è‰²èˆ‡ç¶å®š</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å»ºç«‹å…è¨±è®€å– Pod çš„è§’è‰²</span></span><br><span class="line">kubectl create role pod-reader \</span><br><span class="line">  --verb=get,list,watch \</span><br><span class="line">  --resource=pods \</span><br><span class="line">  --namespace=default</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¶å®šè§’è‰²çµ¦ serviceaccount</span></span><br><span class="line">kubectl create rolebinding pod-reader-binding \</span><br><span class="line">  --role=pod-reader \</span><br><span class="line">  --serviceaccount=default:dashboard-sa \</span><br><span class="line">  --namespace=default</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç”¨é€™å€‹æ–¹å¼å¯å¿«é€Ÿåœ¨ CKA è€ƒè©¦ä¸­ç‚ºç‰¹å®š ServiceAccount æˆæ¬Šå°è³‡æºï¼ˆå¦‚ podsï¼‰çš„è®€å–æ¬Šé™ï¼Œçœä¸‹å¯« YAML çš„æ™‚é–“ã€‚</p>
</blockquote>
<h2 id="å¯¦å‹™ç¯„ä¾‹ï¼šæ‰‹å‹•ä½¿ç”¨-Token-å‘¼å«-API-Server"><a href="#å¯¦å‹™ç¯„ä¾‹ï¼šæ‰‹å‹•ä½¿ç”¨-Token-å‘¼å«-API-Server" class="headerlink" title="å¯¦å‹™ç¯„ä¾‹ï¼šæ‰‹å‹•ä½¿ç”¨ Token å‘¼å« API Server"></a>å¯¦å‹™ç¯„ä¾‹ï¼šæ‰‹å‹•ä½¿ç”¨ Token å‘¼å« API Server</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl https://&lt;api-server&gt;:6443/api \</span><br><span class="line">  --insecure \</span><br><span class="line">  --header <span class="string">&quot;Authorization: Bearer &lt;YOUR_TOKEN&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="CKA-æ€éº¼è€ƒï¼Ÿ"><a href="#CKA-æ€éº¼è€ƒï¼Ÿ" class="headerlink" title="CKA æ€éº¼è€ƒï¼Ÿ"></a>CKA æ€éº¼è€ƒï¼Ÿ</h1><p>é¡Œç›®é€šå¸¸çµ¦ä½ ä¸€å€‹æƒ…å¢ƒï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>å»ºç«‹ä¸€å€‹ ServiceAccount</li>
<li>å»ºç«‹ Role &#x2F; ClusterRoleï¼ˆex: è®€å–æŸè³‡æºï¼‰</li>
<li>å»ºç«‹å°æ‡‰çš„ Binding</li>
<li>å»ºç«‹ Pod ä¸¦ä½¿ç”¨è©² ServiceAccount</li>
<li>é©—è­‰æ˜¯å¦èƒ½æˆåŠŸä½¿ç”¨ API Token å­˜å–è³‡æº</li>
</ul>
<p>é‡é»æŠ€å·§ï¼š</p>
<ul>
<li>å¿«é€Ÿä½¿ç”¨ <code>kubectl create</code> å»ºç«‹ SA &#x2F; Role &#x2F; RoleBinding</li>
<li>ç†Ÿæ‚‰ä¿®æ”¹ Pod yaml ä¸¦å¥—ç”¨</li>
<li>é©—è­‰ token æ›è¼‰èˆ‡æ¬Šé™ï¼ˆå¯ç”¨ <code>curl</code> + <code>Bearer</code>ï¼‰</li>
</ul>
<hr>
<h1 id="å°çµ"><a href="#å°çµ" class="headerlink" title="å°çµ"></a>å°çµ</h1><ul>
<li>ServiceAccount æ˜¯å·¥ä½œè² è¼‰èˆ‡ API Server é€šè¨Šçš„æ ¸å¿ƒæ©Ÿåˆ¶</li>
<li>å»ºè­°æ­é… RBAC ç²¾ç¢ºæˆæ¬Š</li>
<li>æ³¨æ„ token æ›è¼‰è¡Œç‚ºåœ¨ v1.22 &#x2F; v1.24 æœ‰é‡å¤§è®Šæ›´</li>
<li>CKA è€ƒé¡Œæœƒå¯¦ä½œ SA + RBAC + Pod é©—è­‰æ•´åˆèƒ½åŠ›</li>
</ul>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>RBAC</tag>
        <tag>CKA</tag>
        <tag>ServiceAccount</tag>
        <tag>Security</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s Security | æ†‘è­‰æª¢æŸ¥èˆ‡ ETCD æ—¥èªŒè¨ºæ–·å¯¦å‹™</title>
    <url>/2025/07/07/K8s-Advanced/K8s-Security-%E6%86%91%E8%AD%89%E6%AA%A2%E6%9F%A5%E8%88%87ETCD%E6%97%A5%E8%AA%8C%E8%A8%BA%E6%96%B7%E5%AF%A6%E5%8B%99/</url>
    <content><![CDATA[<h1 id="View-Certificate-Details"><a href="#View-Certificate-Details" class="headerlink" title="View Certificate Details"></a>View Certificate Details</h1><h2 id="æª¢è¦–-K8s-API-Server-æ†‘è­‰è©³ç´°è³‡è¨Š"><a href="#æª¢è¦–-K8s-API-Server-æ†‘è­‰è©³ç´°è³‡è¨Š" class="headerlink" title="æª¢è¦– K8s API Server æ†‘è­‰è©³ç´°è³‡è¨Š"></a>æª¢è¦– K8s API Server æ†‘è­‰è©³ç´°è³‡è¨Š</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ†‘è­‰å…§å®¹</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> /etc/kubernetes/pki/apiserver.crt -text -noout</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>æ¬„ä½</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Certificate Path</strong></td>
<td><code>/etc/kubernetes/pki/apiserver.crt</code> æª”æ¡ˆä½ç½®</td>
</tr>
<tr>
<td><strong>CN Name</strong></td>
<td><code>Subject: CN=</code>ï¼Œå¸¸è¦‹ç‚º <code>kube-apiserver</code> æˆ–ä¸»æ©Ÿåç¨±</td>
</tr>
<tr>
<td><strong>ALT Names</strong></td>
<td><code>X509v3 Subject Alternative Name</code>ï¼Œåˆ—å‡ºæ”¯æ´çš„ DNS&#x2F;IP</td>
</tr>
<tr>
<td><strong>Organization</strong></td>
<td><code>Subject: O=</code>ï¼Œé€šå¸¸æ˜¯ <code>system:masters</code></td>
</tr>
<tr>
<td><strong>Issuer</strong></td>
<td>æ†‘è­‰ç°½ç™¼è€…ï¼Œä¾†è‡ª CA çš„ CN</td>
</tr>
<tr>
<td><strong>Expiration</strong></td>
<td><code>Not After</code> æ¬„ä½è¡¨ç¤ºçš„æ†‘è­‰éæœŸæ™‚é–“</td>
</tr>
</tbody></table>
<h2 id="ç¯„ä¾‹è§£ææ¬„ä½ï¼ˆå¾-openssl-è¼¸å‡ºä¸­æå–ï¼‰"><a href="#ç¯„ä¾‹è§£ææ¬„ä½ï¼ˆå¾-openssl-è¼¸å‡ºä¸­æå–ï¼‰" class="headerlink" title="ç¯„ä¾‹è§£ææ¬„ä½ï¼ˆå¾ openssl è¼¸å‡ºä¸­æå–ï¼‰"></a>ç¯„ä¾‹è§£ææ¬„ä½ï¼ˆå¾ openssl è¼¸å‡ºä¸­æå–ï¼‰</h2><ol>
<li><p>Subject:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Subject: O=system:masters, CN=kube-apiserver</span><br></pre></td></tr></table></figure>
</li>
<li><p>Subject Alternative Name:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">X509v3 Subject Alternative Name:</span><br><span class="line">    DNS:kubernetes, DNS:kubernetes.default, IP Address:10.96.0.1, ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>Validity - Not After:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Not After : Jul  5 10:33:24 2025 GMT</span><br></pre></td></tr></table></figure>
</li>
<li><p>Issuer:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Issuer: CN=kubernetes-ca</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Inspect-Service-Logs"><a href="#Inspect-Service-Logs" class="headerlink" title="Inspect Service Logs"></a>Inspect Service Logs</h1><h2 id="æŸ¥çœ‹-etcd-æœå‹™ç‹€æ…‹èˆ‡æ—¥èªŒ"><a href="#æŸ¥çœ‹-etcd-æœå‹™ç‹€æ…‹èˆ‡æ—¥èªŒ" class="headerlink" title="æŸ¥çœ‹ etcd æœå‹™ç‹€æ…‹èˆ‡æ—¥èªŒ"></a>æŸ¥çœ‹ etcd æœå‹™ç‹€æ…‹èˆ‡æ—¥èªŒ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ journalctl æŸ¥çœ‹ systemd å•Ÿå‹•æ—¥èªŒ</span></span><br><span class="line">journalctl -u etcd.service -l</span><br><span class="line">journalctl -u etcd.service -l --no-pager</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>--no-pager</code>ï¼šå¯é¿å…åˆ†é è¼¸å‡ºã€‚<br><code>-l</code>ï¼ˆlong&#x2F;fullï¼‰ï¼šé¡¯ç¤ºä¸è¢«æˆªæ–·çš„å®Œæ•´æ—¥èªŒå…§å®¹ã€‚</p>
</blockquote>
<hr>
<h1 id="View-etcd-Logsï¼ˆä¾éƒ¨ç½²æ–¹å¼è€Œå®šï¼‰"><a href="#View-etcd-Logsï¼ˆä¾éƒ¨ç½²æ–¹å¼è€Œå®šï¼‰" class="headerlink" title="View etcd Logsï¼ˆä¾éƒ¨ç½²æ–¹å¼è€Œå®šï¼‰"></a>View etcd Logsï¼ˆä¾éƒ¨ç½²æ–¹å¼è€Œå®šï¼‰</h1><h2 id="è‹¥-etcd-ç‚º-Kubernetes-static-Podï¼ˆé è¨­æƒ…æ³ï¼‰"><a href="#è‹¥-etcd-ç‚º-Kubernetes-static-Podï¼ˆé è¨­æƒ…æ³ï¼‰" class="headerlink" title="è‹¥ etcd ç‚º Kubernetes static Podï¼ˆé è¨­æƒ…æ³ï¼‰"></a>è‹¥ etcd ç‚º Kubernetes static Podï¼ˆé è¨­æƒ…æ³ï¼‰</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># éœæ…‹ Pod åç¨±é€šå¸¸ç‚º etcd-[node-name]ï¼Œå¯ç”¨ä»¥ä¸‹æŒ‡ä»¤æŸ¥è©¢</span></span><br><span class="line">kubectl get pods -n kube-system -o wide</span><br><span class="line">kubectl logs etcd-[node-name] -n kube-system</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä½¿ç”¨ <code>kubectl get pods -n kube-system</code> ç¢ºèªå¯¦éš› Pod åç¨±</p>
</blockquote>
<h2 id="è‹¥-etcd-æ˜¯ä»¥-Docker-container-é‹è¡Œ"><a href="#è‹¥-etcd-æ˜¯ä»¥-Docker-container-é‹è¡Œ" class="headerlink" title="è‹¥ etcd æ˜¯ä»¥ Docker container é‹è¡Œ"></a>è‹¥ etcd æ˜¯ä»¥ Docker container é‹è¡Œ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker ps -a  <span class="comment"># æ‰¾å‡º etcd container ID æˆ–åç¨±</span></span><br><span class="line">docker logs [container_id or container_name]</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="å…¶ä»–å¯¦ç”¨æª¢æŸ¥æŒ‡ä»¤"><a href="#å…¶ä»–å¯¦ç”¨æª¢æŸ¥æŒ‡ä»¤" class="headerlink" title="å…¶ä»–å¯¦ç”¨æª¢æŸ¥æŒ‡ä»¤"></a>å…¶ä»–å¯¦ç”¨æª¢æŸ¥æŒ‡ä»¤</h1><h2 id="æª¢æŸ¥-kube-apiserver-çš„è­‰æ›¸èˆ‡å¯†é‘°æ˜¯å¦é…å°"><a href="#æª¢æŸ¥-kube-apiserver-çš„è­‰æ›¸èˆ‡å¯†é‘°æ˜¯å¦é…å°" class="headerlink" title="æª¢æŸ¥ kube-apiserver çš„è­‰æ›¸èˆ‡å¯†é‘°æ˜¯å¦é…å°"></a>æª¢æŸ¥ kube-apiserver çš„è­‰æ›¸èˆ‡å¯†é‘°æ˜¯å¦é…å°</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl x509 -noout -modulus -<span class="keyword">in</span> /etc/kubernetes/pki/apiserver.crt | openssl md5</span><br><span class="line">openssl rsa -noout -modulus -<span class="keyword">in</span> /etc/kubernetes/pki/apiserver.key | openssl md5</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å…©è€…è¼¸å‡ºæ‡‰ä¸€è‡´ï¼Œå¦å‰‡ä»£è¡¨è­‰æ›¸èˆ‡å¯†é‘°ä¸é…å°ã€‚</p>
</blockquote>
<h2 id="é©—è­‰-etcd-é€šè¨ŠåŠ å¯†ï¼ˆå¦‚ä½¿ç”¨è‡ªç°½æ†‘è­‰ï¼‰"><a href="#é©—è­‰-etcd-é€šè¨ŠåŠ å¯†ï¼ˆå¦‚ä½¿ç”¨è‡ªç°½æ†‘è­‰ï¼‰" class="headerlink" title="é©—è­‰ etcd é€šè¨ŠåŠ å¯†ï¼ˆå¦‚ä½¿ç”¨è‡ªç°½æ†‘è­‰ï¼‰"></a>é©—è­‰ etcd é€šè¨ŠåŠ å¯†ï¼ˆå¦‚ä½¿ç”¨è‡ªç°½æ†‘è­‰ï¼‰</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl s_client -connect 127.0.0.1:2379 \</span><br><span class="line">  -cert /etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">  -key /etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">  -CAfile /etc/kubernetes/pki/etcd/ca.crt</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>Certificate</tag>
        <tag>openssl</tag>
        <tag>logs</tag>
      </tags>
  </entry>
  <entry>
    <title>Kubernetes | Cluster Architecture</title>
    <url>/2024/04/16/Kubernetes/Kubernetes-Cluster-Architecture/</url>
    <content><![CDATA[<p><code>Kubernetes</code></p>
<ul>
<li>ç›®çš„æ˜¯è®“å®¹å™¨ï¼ˆContainerï¼‰çš„ç®¡ç†è®Šå¾—å®¹æ˜“ã€å…è¨±è¢«ç›£æ§ä¸”è‡ªå‹•åŒ–ã€‚</li>
</ul>
<p><code>Node</code></p>
<ul>
<li><code>æŒ‡çš„æ˜¯ Worker Nodes çš„éƒ¨åˆ†ï¼Œä¸æ˜¯ Master ï¼</code></li>
<li>A node is a worker machine in Kubernetes. A worker node may be a VM or physical machine, depending on the cluster. </li>
<li>It has local daemons or services necessary to run Pods and is managed by the control plane. The daemons on a node include kubelet, kube-proxy, and a container runtime implementing the CRI such as Docker.</li>
</ul>
<p><code>Container</code></p>
<ul>
<li>è¼•é‡ç´šçš„å®¹å™¨ï¼Œæ‰“åŒ…æ‰€æœ‰å¿…è¦ä¸”ç›¸ä¾çš„å¥—ä»¶ã€ç¨‹å¼ç¢¼ç­‰ï¼Œæä¾›æ‡‰ç”¨ç¨‹å¼ä¸€è‡´çš„é‹è¡Œç’°å¢ƒï¼Œä½¿æ‡‰ç”¨ç¨‹å¼åœ¨ä¸åŒçš„ä½œæ¥­ç³»çµ±ä¸Šä¹Ÿèƒ½å¤ é‡å»ºå’Œé‹è¡Œã€‚</li>
</ul>
<h1 id="Kubernetes-Cluster-Architecture"><a href="#Kubernetes-Cluster-Architecture" class="headerlink" title="Kubernetes Cluster Architecture"></a>Kubernetes Cluster Architecture</h1><p>Kubernetes cluster architecture<br><img src="https://kubernetes.io/images/docs/kubernetes-cluster-architecture.svg"></p>
<h1 id="Kubernetes-Components"><a href="#Kubernetes-Components" class="headerlink" title="Kubernetes Components"></a>Kubernetes Components</h1><p>The components of a Kubernetes cluster<br><img src="https://kubernetes.io/images/docs/components-of-kubernetes.svg"></p>
<h2 id="ã€-Master-ã€‘"><a href="#ã€-Master-ã€‘" class="headerlink" title="ã€ Master ã€‘"></a><font color=LightCoral>ã€ Master ã€‘</font></h2><blockquote>
<p>aka. ã€ Control Plane Components ã€‘<br>è·è²¬ï¼š<code>è² è²¬ç›£æ§èˆ‡ç®¡ç†å®¹å™¨</code></p>
</blockquote>
<p><font color=LightCoral>Purpose: Manage, Plan, Schedule, Monitor Nodes</font></p>
<h3 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h3><p>Also known as: API server</p>
<p>The API server is a component of the Kubernetes control plane that exposes the Kubernetes API. The API server is the front end for the Kubernetes control plane.</p>
<p>ğŸ“Œ K8s æœ€é«˜å±¤æ¬¡çš„ç®¡ç†ä»‹é¢ï¼Œè² è²¬å”èª¿é›†ç¾¤ä¸­çš„æ‰€æœ‰æ“ä½œã€‚</p>
<h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h3><p>Consistent and highly-available key value store used as Kubernetesâ€™ backing store for all cluster data.<br>The official etcd ports are 2379 for client requests and 2380 for peer communication.</p>
<p>ğŸ“Œ è² è²¬å„²å­˜é—œæ–¼é›†ç¾¤çš„è³‡è¨Šï¼ŒåŒ…æ‹¬ Nodesã€PODsã€Configsã€Secretsã€Accountsã€Rolesã€Bindings å’Œ Othersã€‚<br>ğŸ“Œ ETCD in HA Environmentï¼šä¸€å€‹é›†ç¾¤ï¼ˆClusterï¼‰ä¸­ï¼Œå¯ä»¥æœ‰å¤šå€‹ masterã€‚æ¯å€‹ master è£¡é¢éƒ½æœ‰ä¸€å€‹ ETCDã€‚</p>
<h3 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h3><p>Control plane component that watches for newly created Pods with no assigned node, and selects a node for them to run on.</p>
<p>Factors taken into account for scheduling decisions include: individual and collective resource requirements, hardware&#x2F;software&#x2F;policy constraints, affinity and anti-affinity specifications, data locality, inter-workload interference, and deadlines.</p>
<p>ğŸ“Œ è² è²¬èª¿åº¦ç¯€é»ä¸Šçš„å®¹å™¨æˆ–æ‡‰ç”¨ç¨‹åºã€‚åŸºæ–¼å®¹å™¨çš„è³‡æºéœ€æ±‚ã€Worker Node å®¹é‡ã€ä»»ä½•å…¶ä»–ç­–ç•¥æˆ–ç´„æŸï¼Œä¾†è­˜åˆ¥æ­£ç¢ºçš„ç¯€é»ä»¥æ”¾ç½®å®¹å™¨ã€‚<br>ğŸ“Œ åªè² è²¬æ±ºå®šå“ªå€‹ pod åœ¨å“ªå€‹ node ä¸Šé‹è¡Œï¼Œè€Œéå¯¦éš›å°‡ pod æ”¾åœ¨ node ä¸Šã€‚</p>
<h3 id="kube-controller-manager"><a href="#kube-controller-manager" class="headerlink" title="kube-controller-manager"></a>kube-controller-manager</h3><p>Control plane component that runs controller processes.</p>
<p>There are many different types of controllers. (e.g. Node controller, Job controller, EndpointSlice controller, ServiceAccount controller â€¦)</p>
<p>ğŸ“Œ ä¸åŒæ§åˆ¶å™¨ï¼Œè™•ç†ä¸åŒçš„åŠŸèƒ½ã€‚ç›®çš„æ˜¯æŒçºŒç›£çœ‹å®¹å™¨çš„ç‹€æ…‹ã€ç•¶å®¹å™¨æ›æ‰æ™‚æ¡å–è£œæ•‘è¡Œå‹•ã€‚</p>
<h2 id="ã€-Worker-Nodes-ã€‘"><a href="#ã€-Worker-Nodes-ã€‘" class="headerlink" title="ã€ Worker Nodes ã€‘"></a><font color=LightCoral>ã€ Worker Nodes ã€‘</font></h2><blockquote>
<p>aka. ã€ Node Components ã€‘<br>è·è²¬ï¼š<code>è² è²¬è£è¼‰å®¹å™¨</code></p>
</blockquote>
<p><font color=LightCoral>Purpose: Host Application as Containers</font></p>
<h3 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h3><p>An agent that runs on each node in the cluster. It makes sure that containers are running (and healthy) in a Pod.</p>
<p>ğŸ“Œ ç›¸ç•¶æ–¼èˆ¹é•·ï¼Œæ˜¯åœ¨é›†ç¾¤ä¸­å„å€‹ worker nodesï¼ˆèˆ¹éš»ï¼‰ä¸Šé‹è¡Œçš„ä»£ç†äººï¼Œè² è²¬èˆ‡ master æºé€šã€å›å ± pod ç‹€æ…‹ï¼Œè½å¾ kube-apiserver çš„æŒ‡ä»¤ä¾†ç®¡ç†å®¹å™¨ã€‚ä¾‹å¦‚ï¼šæ ¹æ“šéœ€è¦åœ¨ worker node ä¸Šéƒ¨ç½²æˆ–éŠ·æ¯€å®¹å™¨ã€‚</p>
<h3 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h3><p>kube-proxy is a network proxy that runs on each node in your cluster, implementing part of the Kubernetes Service concept.</p>
<p>kube-proxy maintains network rules on nodes. These network rules allow network communication to your Pods from network sessions inside or outside of your cluster.</p>
<p>ğŸ“Œ è² è²¬é›†ç¾¤å…§ä¸åŒ worker node ä¹‹é–“çš„é€šè¨Šã€‚</p>
<h3 id="Container-runtime"><a href="#Container-runtime" class="headerlink" title="Container runtime"></a>Container runtime</h3><p>A fundamental component that empowers Kubernetes to run containers effectively. It is responsible for managing the execution and lifecycle of containers within the Kubernetes environment.</p>
<p>Kubernetes supports container runtimes such as containerd, CRI-O, rkt, and any other implementation of the Kubernetes CRI (Container Runtime Interface).</p>
<p>ğŸ“Œ Container æ˜¯é‹è¡Œæ‡‰ç”¨ç¨‹å¼çš„ç¨ç«‹ç’°å¢ƒã€‚</p>
<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://kubernetes.io/docs/concepts/architecture/">Cluster Architecture</a></li>
<li><a href="https://kubernetes.io/docs/concepts/overview/components/">Kubernetes Components</a></li>
</ul>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>è§€å¿µè§£èªª</tag>
        <tag>Concepts</tag>
        <tag>Architecture</tag>
      </tags>
  </entry>
  <entry>
    <title>Kubernetes | Deployment</title>
    <url>/2024/06/10/Kubernetes/Kubernetes-Deployment/</url>
    <content><![CDATA[<h1 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h1><p>An API object that manages a replicated application, typically by running Pods with no local state.</p>
<p>ğŸ“Œ A Kubernetes Deployment is a higher-level object that provides capabilities such as <code>seamless rolling updates to underlying instances</code>, <code>the ability to undo changes</code>, and the option to <code>pause and resume changes as required</code>.<br>ğŸ“Œ Kubernetes Deployments are commonly used to deploy and manage multiple instances of applications in a <code>production environment</code>.</p>
<img src="/2024/06/10/Kubernetes/Kubernetes-Deployment/Kubernetes_Deployment.jpg" class="">

<h1 id="Key-Reasons-for-Using-a-Deployment"><a href="#Key-Reasons-for-Using-a-Deployment" class="headerlink" title="Key Reasons for Using a Deployment"></a>Key Reasons for Using a Deployment</h1><ol>
<li><code>Rolling Updates</code>: <ul>
<li>This allows for seamless updates to the underlying instances (pods) without downtime by gradually replacing the old versions of pods with new ones.</li>
<li><code>Don&#39;t upgrade all at once</code>, as it may impact users accessing your applications. Instead, upgrade one after the other, using a process called rolling updates.</li>
</ul>
</li>
<li><code>Rollback</code>:<ul>
<li>If something goes wrong during an update, a Deployment can undo changes and revert to a previous stable state.</li>
<li>Undo the recent change. Roll back the changes that were recently carried out.</li>
</ul>
</li>
<li><code>Pause and Resume</code>: <ul>
<li>Updates can be paused and resumed, which is useful for controlling the deployment process and debugging issues.</li>
<li>You donâ€™t want to apply each change immediately after the command is run. Instead, you would like to apply a pause to your environment, make the changes, and then resume so that all the changes are rolled out together.</li>
</ul>
</li>
</ol>
<hr>
<h1 id="Deployment-with-YAML"><a href="#Deployment-with-YAML" class="headerlink" title="Deployment with YAML"></a>Deployment with YAML</h1><p>Template:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> [<span class="string">custom_name</span>]</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    [<span class="string">custom_key</span>]<span class="string">:</span> [<span class="string">custom_value</span>]</span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    [[ <span class="string">POD</span> ]]</span><br><span class="line">  <span class="attr">replicas:</span> [<span class="string">number</span>]</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      [<span class="string">pod_labels_key</span>]<span class="string">:</span> [<span class="string">pod_labels_value</span>]</span><br></pre></td></tr></table></figure>

<p>deployment-definition.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">front-end</span></span><br></pre></td></tr></table></figure>

<p>RUN commands</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create -f deployment-definition.yml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deployments</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get replicaset</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods</span></span><br></pre></td></tr></table></figure>
<img src="/2024/06/10/Kubernetes/Kubernetes-Deployment/Deployment_commands_1.jpg" class="">

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get all</span></span><br></pre></td></tr></table></figure>
<img src="/2024/06/10/Kubernetes/Kubernetes-Deployment/Deployment_commands_2.jpg" class="">


<p>ğŸ‘ Quickly create Kubernetes YAML Templates<br>In k8s version 1.19+, we can specify the â€“replicas option to create a deployment with 3 replicas.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create deployment --image=httpd:2.4-alpine httpd-frontend --replicas=3</span></span><br></pre></td></tr></table></figure>

<h2 id="kubectl-create-vs-kubectl-run"><a href="#kubectl-create-vs-kubectl-run" class="headerlink" title="kubectl create vs. kubectl run"></a>kubectl create vs. kubectl run</h2><h3 id="ğŸ“-kubectl-create"><a href="#ğŸ“-kubectl-create" class="headerlink" title="ğŸ“ kubectl create"></a>ğŸ“ kubectl create</h3><blockquote>
<p>Create a resource from a file or from stdin.<br>JSON and YAML formats are accepted.</p>
</blockquote>
<p>Create a deployment</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create deployment --image=nginx nginx</span></span><br></pre></td></tr></table></figure>

<p>Generate Deployment YAML file (-o yaml). Donâ€™t create it(â€“dry-run) and save it to a file.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create deployment --image=nginx nginx --dry-run=client -o yaml &gt; nginx-deployment.yaml</span></span><br></pre></td></tr></table></figure>

<p>Make necessary changes to the file (for example, adding more replicas) and then create the deployment.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create -f nginx-deployment.yaml</span></span><br></pre></td></tr></table></figure>


<h3 id="ğŸ“-kubectl-run"><a href="#ğŸ“-kubectl-run" class="headerlink" title="ğŸ“ kubectl run"></a>ğŸ“ kubectl run</h3><blockquote>
<p>Create and run a particular image in a <code>pod</code>.</p>
</blockquote>
<p>Create an NGINX Pod</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl run nginx --image=nginx</span></span><br></pre></td></tr></table></figure>

<p>Generate POD Manifest YAML file (-o yaml). Donâ€™t create it (â€“dry-run) and save it to a file.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl run redis --image=redis --dry-run=client -o yaml &gt; redis_template.yaml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create -f redis_template.yaml</span></span><br></pre></td></tr></table></figure>


<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a></li>
<li><a href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_create/">kubectl create</a></li>
<li><a href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_run/">kubectl run</a></li>
<li><a href="https://kubernetes.io/docs/reference/kubectl/conventions/">kubectl Usage Conventions</a> ğŸ‘</li>
</ul>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>è§€å¿µè§£èªª</tag>
        <tag>Concepts</tag>
        <tag>Deployment</tag>
      </tags>
  </entry>
  <entry>
    <title>Kubernetes | Pods</title>
    <url>/2024/05/14/Kubernetes/Kubernetes-Pods/</url>
    <content><![CDATA[<h1 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h1><p>ğŸ“Œ Kubernetes doesnâ€™t deploy containers directly on the worker node. The containers are encapsulated into â€œpodsâ€.<br>ğŸ“Œ A pod is a single instance of an application. A pod is the smallest object that you can create in Kubernetes.</p>
<h2 id="Why-does-Kubernetes-use-pods-ğŸ¤”"><a href="#Why-does-Kubernetes-use-pods-ğŸ¤”" class="headerlink" title="Why does Kubernetes use pods? ğŸ¤”"></a><a href="https://www.redhat.com/en/topics/containers/what-is-kubernetes-pod">Why does Kubernetes use pods?</a> ğŸ¤”</h2><p>Pods are designed to have one (common use case) or more (advanced use cases) containers.</p>
<p>Grouping containers in this way allows them to communicateÂ with each other, while still remaining isolated to some degree. Containers in a single pod are designed to share common compute resources, such as same storage, same network, same namespace, and be created together and destroyed together. </p>
<p>This is a good thing in the long run because your application is now ready to handle future architectural changes and scale. Organizing containers into pods allows horizontal scalability of applications. Pods can be replicated across different nodes, enabling resistance to failure. </p>
<h2 id="The-simplest-case"><a href="#The-simplest-case" class="headerlink" title="The simplest case"></a>The simplest case</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">        Big        &gt; ----------- &gt; --- &gt; --------- &gt;    Small</span><br><span class="line">Kubernetes Cluster &gt; Worker Node &gt; Pod &gt; Container &gt; Application</span><br></pre></td></tr></table></figure>

<p>The image below contains the following components:</p>
<ul>
<li>A Kubernetes cluster</li>
<li>A single worker node</li>
<li>A single pod</li>
<li>A single container</li>
<li>A single application</li>
</ul>
<p>Explanation:<br><code>A single-node Kubernetes cluster</code> with <code>a single instance of your application</code> running in <code>a single Docker container</code> encapsulated in <code>a single pod</code>.</p>
<img src="/2024/05/14/Kubernetes/Kubernetes-Pods/Kubernetes_Pod.jpg" class="">


<h2 id="Best-Practice"><a href="#Best-Practice" class="headerlink" title="Best Practice"></a>Best Practice</h2><p>ğŸ“Œ Pods usually have a one-to-one relationship with containers running your application. Multiple containers running in a Pod is a rare use case.</p>
<p>ğŸ“Œ Donâ€™t add additional (same kind) containers to an existing pod to scale your application!</p>
<blockquote>
<p>A Pod contains at most one container of the same type.</p>
<img src="/2024/05/14/Kubernetes/Kubernetes-Pods/Pod_scale_up_1.jpg" class="">
</blockquote>
<p>ğŸ“Œ ç•¶é€£ç·šåˆ°æ‡‰ç”¨ç¨‹å¼çš„ä½¿ç”¨è€…å¢åŠ æ™‚ï¼Œè©²å¦‚ä½•æ“´å±•ä½ çš„æ‡‰ç”¨ç¨‹å¼ä¾†åˆ†æ”¤è² è¼‰ï¼ˆshare the loadï¼‰ï¼Ÿ</p>
<blockquote>
<p><code>[ X ]</code> åœ¨åŒä¸€å€‹ Pod ä¸­ï¼Œå•Ÿå‹•æ–°çš„ Containerã€‚<br>(A cluster, a worker node, two containers in a pod)</p>
</blockquote>
<blockquote>
<p><code>[ O ]</code> æ–°å¢ä¸€å€‹ Pod ï¼Œä¸¦åœ¨å…¶ä¸­å•Ÿå‹•æ–°çš„ Containerã€‚<br>(A cluster, a worker node, two pods, a container in a pod)</p>
</blockquote>
<blockquote>
<p><code>[ O ]</code> è‹¥ç•¶å‰ worker node æ²’æœ‰è¶³å¤ å®¹é‡æ™‚ï¼Œæ–°å¢ä¸€å€‹ worker nodeï¼Œä¸¦åœ¨è©² worker node ä¸Šæ–°å¢ä¸€å€‹ Podï¼Œæ¥è‘—åœ¨ Pod ä¸Šå•Ÿå‹•æ–°çš„ containerã€‚<br>(A cluster, two worker nodes, a worker node can have multiple pods, a container in a pod)</p>
</blockquote>
<hr>
<h1 id="åœ–è§£-Kubectl-Command"><a href="#åœ–è§£-Kubectl-Command" class="headerlink" title="åœ–è§£ Kubectl Command"></a>åœ–è§£ Kubectl Command</h1><p>ğŸ“Œ Kubectl Command æœƒè‡ªå‹•å‰µå»ºä¸€å€‹ Podï¼Œä¸¦åœ¨å…¶å…§éƒ¨ç½²ä¸€å€‹ Containerã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl run nginx --image nginx</span></span><br></pre></td></tr></table></figure>
<img src="/2024/05/14/Kubernetes/Kubernetes-Pods/kubectl_run_nginx_1.jpg" class="">
<img src="/2024/05/14/Kubernetes/Kubernetes-Pods/kubectl_run_nginx_2.jpg" class="">

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods</span></span><br></pre></td></tr></table></figure>
<img src="/2024/05/14/Kubernetes/Kubernetes-Pods/kubectl_get_pods.jpg" class="">


<h1 id="YAML-in-Kubernetes"><a href="#YAML-in-Kubernetes" class="headerlink" title="YAML in Kubernetes"></a>YAML in Kubernetes</h1><ul>
<li>Note: <ul>
<li>apiVersion: string</li>
<li>kind: string</li>
<li>metadata: dictionary</li>
<li>containers: list&#x2F;array</li>
</ul>
</li>
<li>Check â€œkindâ€ for pod&#x2F;replicationcontroller&#x2F;replicaset&#x2F;deployment&#x2F;service<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl explain [pod | replicationcontroller | replicaset | deployment | service]</span></span><br></pre></td></tr></table></figure></li>
<li>Help<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create deployment --<span class="built_in">help</span></span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>definition.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> [<span class="string">v1</span> <span class="string">|</span> <span class="string">apps/v1</span>]</span><br><span class="line"><span class="attr">kind:</span> [<span class="string">Pod</span> <span class="string">|</span> <span class="string">Service</span> <span class="string">|</span> <span class="string">ReplicaSet</span> <span class="string">|</span> <span class="string">Deployment</span>]</span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> [<span class="string">custom_name</span>]</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    [<span class="string">custom_key_1</span>]<span class="string">:</span> [<span class="string">custom_value_1</span>]</span><br><span class="line">    [<span class="string">custom_key_2</span>]<span class="string">:</span> [<span class="string">custom_value_2</span>]</span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> [<span class="string">container1_name</span>]</span><br><span class="line">      <span class="attr">image:</span> [<span class="string">image1_name</span>]</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> [<span class="string">container2_name</span>]</span><br><span class="line">      <span class="attr">image:</span> [<span class="string">image2_name</span>]</span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>ğŸ‘ Quickly create Kubernetes YAML Templates</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl run redis --image=redis --dry-run=client -o yaml &gt; redis_template.yaml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create -f redis_template.yaml</span></span><br></pre></td></tr></table></figure>


<h2 id="Pods-with-YAML"><a href="#Pods-with-YAML" class="headerlink" title="Pods with YAML"></a>Pods with YAML</h2><p>pod-definition.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>Run pod-definition.yml</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create -f pod-definition.yml</span></span><br><span class="line">or</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f pod-definition.yml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods -o wide</span></span><br></pre></td></tr></table></figure>
<img src="/2024/05/14/Kubernetes/Kubernetes-Pods/kubectl_create_pod_1.jpg" class="">

<p>View Pod details</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe pod [myapp-pod]</span></span><br></pre></td></tr></table></figure>
<img src="/2024/05/14/Kubernetes/Kubernetes-Pods/kubectl_create_pod_2.jpg" class="">

<p>Delete Pod</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete pod [myapp-pod]</span></span><br></pre></td></tr></table></figure>


<h2 id="Service-with-YAML"><a href="#Service-with-YAML" class="headerlink" title="Service with YAML"></a>Service with YAML</h2><p>service-definition.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="ReplicaSet-with-YAML"><a href="#ReplicaSet-with-YAML" class="headerlink" title="ReplicaSet with YAML"></a>ReplicaSet with YAML</h2><p>replicaset-definition.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-replicaset</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">front-end</span></span><br></pre></td></tr></table></figure>


<h2 id="Deployment-with-YAML"><a href="#Deployment-with-YAML" class="headerlink" title="Deployment with YAML"></a>Deployment with YAML</h2><p>deployment-definition.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">front-end</span></span><br></pre></td></tr></table></figure>


<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://www.redhat.com/en/topics/containers/what-is-kubernetes-pod">What is a Kubernetes pod?</a></li>
<li><a href="https://www.reddit.com/r/kubernetes/comments/u1xva3/newbie_why_are_pods_needed/">Newbie: Why are pods needed?</a></li>
</ul>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>è§€å¿µè§£èªª</tag>
        <tag>Concepts</tag>
        <tag>Pods</tag>
        <tag>Kubectl</tag>
        <tag>YAML</tag>
      </tags>
  </entry>
  <entry>
    <title>ChatGPT è·å ´é©å‘½ï¼šPM ä¸éœ€ç¨‹å¼æŠ€èƒ½ä¹Ÿèƒ½é«˜æ•ˆå·¥ä½œ</title>
    <url>/2024/07/16/Workplace/ChatGPT-%E8%81%B7%E5%A0%B4%E9%9D%A9%E5%91%BD%EF%BC%9APM-%E4%B8%8D%E9%9C%80%E7%A8%8B%E5%BC%8F%E6%8A%80%E8%83%BD%E4%B9%9F%E8%83%BD%E9%AB%98%E6%95%88%E5%B7%A5%E4%BD%9C/</url>
    <content><![CDATA[<p>æœ€è¿‘å·¥ä½œä¸Šç™¼ç”Ÿäº†ä¸€ä»¶äº‹ï¼Œè®“æˆ‘å°æ–¼ ChatGPT çš„æ‡‰ç”¨æœ‰äº†ä¸ä¸€æ¨£çš„æƒ³æ³•ï¼Œä¹Ÿåœ¨å·¥ä½œæµç¨‹ä¸­æ„Ÿå—åˆ°å…¶å¸¶ä¾†çš„å¥½è™•èˆ‡æ½›åœ¨çš„è¡æ“Šã€‚</p>
<h1 id="ã€-å‰æƒ…æè¦-ã€‘"><a href="#ã€-å‰æƒ…æè¦-ã€‘" class="headerlink" title="ã€ å‰æƒ…æè¦ ã€‘"></a>ã€ å‰æƒ…æè¦ ã€‘</h1><p>æˆ‘æ˜¯ä¸€ä½é›²ç«¯ç³»çµ±å·¥ç¨‹å¸«ï¼Œé™¤äº†è² è²¬é›²ç«¯å¹³å°çš„ç¶­é‹åŠé–‹ç™¼ã€è³‡æ–™åº«å»ºç½®èˆ‡ç®¡ç†ï¼ˆå°¤å…¶æ˜¯è³‡æ–™åº« service æ›æ‰ï¼Œå…‰æ˜¯æ‰¾åŸå› å’Œä¿®å¾© Replica Set å°±å¿«ææ­»æˆ‘äº† T _ T ï¼‰ä¹‹å¤–ï¼Œé‚„è¦é…åˆå…¶ä»–éƒ¨é–€ä¸å®šæœŸçš„&#x2F;ç•°æƒ³å¤©é–‹çš„&#x2F;å¿«è¦ç«ç‡’å±è‚¡çš„éœ€æ±‚è¦è™•ç†ã€‚</p>
<h1 id="ã€-çœŸäººçœŸäº‹-ã€‘"><a href="#ã€-çœŸäººçœŸäº‹-ã€‘" class="headerlink" title="ã€ çœŸäººçœŸäº‹ ã€‘"></a>ã€ çœŸäººçœŸäº‹ ã€‘</h1><p>å›åˆ°æ­£é¡Œï¼Œç”±æ–¼æœ€è¿‘å…¬å¸æ¥äº†ä¸€äº›æ”¿åºœæ¨™æ¡ˆï¼Œç›®æ¨™æ˜¯å»ºç½®ä¸€å€‹å¹³å°é¡¯ç¤º IoT è¨­å‚™çš„å³æ™‚æ•¸æ“šã€æ­·å²æ•¸æ“šï¼Œé‚„è¦é‡å°é€™äº›è¨­å‚™é¡¯ç¤ºå…¶ç‹€æ…‹ï¼ˆåˆ¤æ–·è¨­å‚™ç•°å¸¸ã€é‹ä½œç‹€æ…‹ï¼Œç”šè‡³ GPS å®šä½ï¼‰ä»¥åŠå„ç¨®åŠŸèƒ½ã€‚</p>
<p>å¯æƒ³è€ŒçŸ¥ï¼Œéç¨‹æ˜¯é‡é‡çš„æŒ‘æˆ°èˆ‡è‰±è¾›ï¼ˆå¿ƒé…¸è¡€æ·šå²XD ç‰¹åˆ¥æ˜¯æºé€šã€å–å¾—å’Œæ•´ç†æˆæ¨™æº–åŒ–çš„è³‡æ–™ï¼Œå¸¸å¸¸è®“äººæ„Ÿåˆ°å¿ƒç´¯ ğŸ˜± Orzï¼‰ï¼Œæ›´åˆ¥èªªé–‹ç™¼æ™‚ç¨‹çŸ­ï¼ˆè¦åœ¨çŸ­æ™‚é–“å…§æ–¼ä¸åŒç’°å¢ƒä¸‹æ¸¬è©¦ Development -&gt; Testing -&gt; Staging -&gt; Productionï¼‰ã€è™•ç†ç´°é …é›œï¼ˆä¸åªä¸²æ¥ API è³‡æ–™ã€MQTT å‚³é€è³‡æ–™ï¼Œé‚„è¦æª¢æ ¸è³‡æ–™çš„åˆç†æ€§â€¦ï¼‰ï¼Œæ ¹æœ¬å¿™åˆ°ç‚¸æ‰å•Šï¼</p>
<p>ç•¶ç„¶ï¼Œæˆ‘éƒ½é€™éº¼å¿™äº†ï¼Œæˆ‘å€‘çš„ PM ä¹Ÿå¥½ä¸åˆ°å“ªè£¡å»ï¼Œæ ¹æœ¬æ˜¯è¢«ç§‘é•·ã€æ‰¿è¾¦ã€å„ç¨®å ±å‘Šè¿½æ®ºã€‚<br>å—šå‘¼å“€å“‰ï¼çœ‹è‘— PM å¹¾ä¹æ¯å¤©åœ¨åŠ ç­ä¸­åº¦éï¼Œæ¯å¤©æƒ³ç›¡è¾¦æ³•ã€çµç›¡è…¦æ±åœ°æƒ³è¦æé«˜å·¥ä½œæ•ˆç‡ã€‚<br>è€Œæœ€çµ‚ï¼ŒPM æŠŠè…¦ç­‹å‹•åˆ°äº† ChatGPT ä¸Šã€‚</p>
<p>æœ‰è™•ç†éå¾ˆå¤§é‡ä¸”é«’äº‚è³‡æ–™çš„äººå°±æœƒçŸ¥é“ï¼Œå¦‚æœè¦è®“äººå»æ‰‹å‹•è™•ç†ä¸¦ä¸æ˜¯ä¸è¡Œï¼Œä½†æœƒéå¸¸çš„è€—æ™‚ä¸”å®¹æ˜“äººç‚ºå‡ºéŒ¯ï¼Œè€Œä¸”é€™ç¨®äº‹æƒ…éƒ½æœ‰ä¸€å®šçš„é‡è¤‡æ€§ã€ä¸æ˜¯é‚£éº¼å®¹æ˜“å¯«æˆè¦å‰‡ç”¨ç¨‹å¼åŸ·è¡Œï¼ˆä¾‹å¤–ç‹€æ³å¾ˆå¤šï¼Œä¾èˆŠç„¡æ³•å…é™¤äººå·¥åˆ¤æ–·ï¼‰ã€‚</p>
<p>é€™ä½ PM è·Ÿæˆ‘åˆ†äº«ï¼Œä»–æ‹¿è‘—æˆ‘åŒ¯å‡ºçµ¦ä»–çš„ Excelï¼ŒèŠ±äº†å…©å€‹å°æ™‚ ChatGPT è¨“ç·´äº†å…«æ¬¡ï¼Œæ‰è®“ ChatGPT ç­è§£è¦æ•´ç†æˆä»€éº¼æ¨£çš„æ ¼å¼ã€‚å…¶é¤˜çš„éƒ¨åˆ†ï¼Œæ‰äº¤ç”±äººå·¥åˆ¤æ–·å’Œèª¿æ•´ã€‚</p>
<h1 id="ã€-å¿ƒå¾—-ã€‘"><a href="#ã€-å¿ƒå¾—-ã€‘" class="headerlink" title="ã€ å¿ƒå¾— ã€‘"></a>ã€ å¿ƒå¾— ã€‘</h1><p>èªªåˆ°é€™è£¡ï¼Œä¸è¦ºå¾— ChatGPT é€™å€‹å·¥å…·å¾ˆå¥½ç”¨ï¼Œä½†åŒæ™‚åˆæœ‰é»å¯æ€•å—ï¼ŸğŸ¤”</p>
<blockquote>
<p>å®ƒè®“ä¸€å€‹å®Œå…¨ä¸æ‡‚å¯« code çš„ PM èƒ½å¤ ç”¨å£èªæ•™å° ChatGPT æ‡‰è©²è¼¸å‡ºæ€æ¨£çš„æ ¼å¼ï¼Œè€Œä¸ç”¨å‹ç…©ä¸€ä½å¿™åˆ°è™•æ–¼å´©æ½°é‚Šç·£çš„å·¥ç¨‹å¸«ã€‚<br>å¯æ€•çš„æ˜¯ï¼Œå®ƒæ¸›è¼•äº†å·¥ç¨‹å¸«å·¥ä½œé‡çš„åŒæ™‚ï¼Œä¹Ÿå–ä»£äº†åˆéšå·¥ç¨‹å¸«çš„ä¸€éƒ¨åˆ†å·¥ä½œå…§å®¹ã€‚</p>
</blockquote>
<p>å› æ­¤ï¼Œæˆ‘è¦ºå¾—æœªä¾†çš„äººæ‰ï¼ˆä¸åªæ˜¯å·¥ç¨‹å¸«ï¼‰ï¼Œé¦–å…ˆè¦ open-minded æ¥å—æ–°æŠ€è¡“ã€æ–°è§€å¿µï¼Œå†è€…æ‡‚å¾—å®šç¾©å•é¡Œï¼ˆå°æ–¼è¤‡é›œå•é¡Œæœ‰æŠ½çµ²å‰ç¹­çš„èƒ½åŠ›ï¼‰ä¹Ÿéå¸¸é—œéµä¸”é‡è¦ï¼Œæœ€å¾Œå–„ç”¨ ChatGPT é€™é¡å·¥å…·æœ‰æ•ˆç‡åœ°é”æˆç›®æ¨™ã€‚<br>æˆ‘é æ¸¬æœªä¾†çš„å·¥ç¨‹å¸«ï¼Œé£¯ç¢—æ‡‰è©²æœƒè¶Šä¾†è¶Šä¸å¥½æ§äº†ï¼Œè¢«é æœŸè¦å­¸æ›´å¤šæŠ€èƒ½ï¼Œè¦å˜›æ›´æ·±å…¥ï¼Œè¦å˜›æ›´å»£æ³›ï¼ˆå‰ææ˜¯çŸ¥é“ç‚ºä½•ä½¿ç”¨ã€å¦‚ä½•æ‡‰ç”¨ï¼‰ã€‚</p>
<h1 id="ã€-èˆ‡-PM-å°è©±çºŒé›†-ã€‘"><a href="#ã€-èˆ‡-PM-å°è©±çºŒé›†-ã€‘" class="headerlink" title="ã€ èˆ‡ PM å°è©±çºŒé›† ã€‘"></a>ã€ èˆ‡ PM å°è©±çºŒé›† ã€‘</h1><p>å¾Œä¾†ï¼ŒPM èªªä»–æ›¾è©¦åœ–çœ‹ ChatGPT çš„ codeï¼Œä¸éçœ‹ä¸æ‡‚ã€å°±ç®—æœ‰éŒ¯ä¹Ÿçœ‹ä¸å‡ºä¾†ï¼ˆå„˜ç®¡ä¸‹æ–¹æœ‰è£œå……èªªæ˜å¯«æ³•èˆ‡ç‚ºä½•é€™æ¨£ä½¿ç”¨ï¼‰ã€‚<br>æˆ‘å°±å›ä»–ï¼šã€Œä½ è‹¥çœ‹æ‡‚ï¼Œå°±å¯ä»¥å–ä»£å·¥ç¨‹å¸«äº†ã€‚åŠ æ²¹ï¼æä¸å¥½ï¼Œæ”¹è¡Œé›¢ä½ ä¸é äº†ğŸ˜ã€</p>
]]></content>
      <categories>
        <category>è·å ´éš¨ç­†</category>
      </categories>
      <tags>
        <tag>ChatGPT</tag>
        <tag>å¯¦éš›æ¡ˆä¾‹</tag>
        <tag>å¿ƒå¾—</tag>
      </tags>
  </entry>
  <entry>
    <title>Kubernetes | ReplicationController vs. ReplicaSet</title>
    <url>/2024/06/01/Kubernetes/Kubernetes-ReplicationController-vs-ReplicaSet/</url>
    <content><![CDATA[<h1 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><h2 id="What-are-Kubernetes-Controllers"><a href="#What-are-Kubernetes-Controllers" class="headerlink" title="What are Kubernetes Controllers?"></a>What are Kubernetes Controllers?</h2><ul>
<li>Brain of Kubernetes: <ul>
<li>Controllers are essentially the decision-makers within the Kubernetes. </li>
<li>They are responsible for observing the state of the cluster and taking actions to ensure the desired state is achieved and maintained.</li>
</ul>
</li>
</ul>
<h2 id="Key-Reasons-for-Using-a-RC"><a href="#Key-Reasons-for-Using-a-RC" class="headerlink" title="Key Reasons for Using a RC"></a>Key Reasons for Using a RC</h2><p>Note: Replication Controller (RC)</p>
<h3 id="Ensuring-High-Availability"><a href="#Ensuring-High-Availability" class="headerlink" title="Ensuring High Availability"></a>Ensuring High Availability</h3><blockquote>
<p>å ´æ™¯ä¸€ï¼šç‚ºäº†é¿å…åªæœ‰ä¸€å€‹ Pod ä¸”åˆæ°å·§å´©æ½°è€Œå°è‡´ä½¿ç”¨è€…ç„¡æ³•ä½¿ç”¨è©²æ‡‰ç”¨ç¨‹å¼ï¼Œå› æ­¤æœƒå»ºè­°åŒæ™‚é‹è¡Œã€Œå¤šå€‹æ‡‰ç”¨ç¨‹å¼å‰¯æœ¬ã€ï¼Œä¸¦ä¸”ä¸€å€‹æ‡‰ç”¨ç¨‹å¼åªæœƒé‹è¡Œæ–¼ä¸€å€‹ Pod å…§ã€‚é€™æ–°ç”Ÿæˆçš„ Pod æœƒä¾ç…§ Node è³‡æºä½¿ç”¨ç‹€æ³ï¼Œè¢«åˆ†é…åˆ°åŸ Node æˆ–æ–°çš„ Node ä¸Šã€‚</p>
</blockquote>
<ul>
<li>By maintaining multiple replicas of a pod, an RC ensures that your application remains available even if individual pods fail or are terminated. This redundancy is crucial for high availability and fault tolerance.</li>
<li><code>Does that mean you can&#39;t use a Replication Controller if you plan to have a single Pod?</code> ğŸ¤”<ul>
<li><code>No.</code> Even if you have a single pod, the Replication Controller can help by automatically bringing up a new pod when the existing one fails.</li>
<li>Thus, the Replication Controller ensures that a specified number of pods are running at all times, even if itâ€™s just 1 or 100.</li>
</ul>
</li>
</ul>
<h3 id="Load-Balancing-Scaling"><a href="#Load-Balancing-Scaling" class="headerlink" title="Load Balancing &amp; Scaling"></a>Load Balancing &amp; Scaling</h3><blockquote>
<p>å ´æ™¯äºŒï¼šç‚ºäº†å»ºç«‹å¤šå€‹ Pod ä¾†å…±äº«å®ƒå€‘ä¹‹é–“çš„è² è¼‰ã€‚</p>
<img src="/2024/06/01/Kubernetes/Kubernetes-ReplicationController-vs-ReplicaSet/ReplicationController_Load%20Balancing%20&%20Scaling.jpg" class="">
</blockquote>
<ul>
<li>It helps us to share&#x2F;balance the load across multiple pods on different nodes as well as scale our application when the demand increases.</li>
</ul>
<h2 id="ReplicationController-vs-ReplicaSet"><a href="#ReplicationController-vs-ReplicaSet" class="headerlink" title="ReplicationController vs. ReplicaSet"></a>ReplicationController vs. ReplicaSet</h2><ol>
<li>Both have the same purpose, but they are not the same.<ul>
<li>ReplicaSet is the next-generation ReplicationController that supports the new set-based label selector.</li>
<li>The two behave similarly, except that a ReplicationController does not support set-based selector requirements as described in the labels user guide.</li>
</ul>
</li>
<li><code>ReplicaSet</code> is preferred over ReplicationController.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ğŸ“Œ The selector is one of the major differences between Replication Controller and ReplicaSet.</span><br><span class="line">  - The selector helps the ReplicaSet identify what pods fall under it. ReplicaSet can also manage pods that were not created as part of the ReplicaSet creation.</span><br><span class="line">  - ReplicaSet maintains the desired number of replicas across all pods that fit its criteria (match labels specified in the selector), regardless of whether they were created before (existing pods) or after the ReplicaSet itself.</span><br></pre></td></tr></table></figure>
<img src="/2024/06/01/Kubernetes/Kubernetes-ReplicationController-vs-ReplicaSet/ReplicaSet_selector_label.jpg" class="">


<h3 id="ReplicationController"><a href="#ReplicationController" class="headerlink" title="ReplicationController"></a>ReplicationController</h3><p>A ReplicationController ensures that a specified number of pod replicas are running at any one time. In other words, a ReplicationController makes sure that a pod or a homogeneous set of pods is always up and available.</p>
<h4 id="ReplicationController-with-YAML"><a href="#ReplicationController-with-YAML" class="headerlink" title="ReplicationController with YAML"></a>ReplicationController with YAML</h4><p>Template:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> [<span class="string">custom_name</span>]</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    [<span class="string">custom_key</span>]<span class="string">:</span> [<span class="string">custom_value</span>]</span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    [[ <span class="string">POD</span> ]]</span><br><span class="line">  <span class="attr">replicas:</span> [<span class="string">number</span>]</span><br></pre></td></tr></table></figure>

<p>rc-definition.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-rc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>RUN commands</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create -f rc-definition.yml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get replicationcontroller</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete rc myapp-rc</span></span><br></pre></td></tr></table></figure>
<img src="/2024/06/01/Kubernetes/Kubernetes-ReplicationController-vs-ReplicaSet/ReplicationController_commands.jpg" class="">


<h3 id="ReplicaSet-ğŸ‘"><a href="#ReplicaSet-ğŸ‘" class="headerlink" title="ReplicaSet ğŸ‘"></a>ReplicaSet ğŸ‘</h3><p>A ReplicaSetâ€™s purpose is to maintain a stable set of replica Pods running at any given time. As such, it is often used to guarantee the availability of a specified number of identical Pods.</p>
<p>Itâ€™s mainly used by Deployment as a mechanism to orchestrate pod creation, deletion and updates. Note that we recommend using Deployments instead of directly using Replica Sets, unless you require custom update orchestration or donâ€™t require updates at all.</p>
<h4 id="ReplicaSet-with-YAML"><a href="#ReplicaSet-with-YAML" class="headerlink" title="ReplicaSet with YAML"></a>ReplicaSet with YAML</h4><p>Template:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> [<span class="string">custom_name</span>]</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    [<span class="string">custom_key</span>]<span class="string">:</span> [<span class="string">custom_value</span>]</span><br><span class="line">    <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    [[ <span class="string">POD</span> ]]</span><br><span class="line">  <span class="attr">replicas:</span> [<span class="string">number</span>]</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      [<span class="string">pod_labels_key</span>]<span class="string">:</span> [<span class="string">pod_labels_value</span>]</span><br></pre></td></tr></table></figure>

<p>replicaset-definition.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-replicaset</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">front-end</span></span><br></pre></td></tr></table></figure>

<p>RUN commands</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create -f replicaset-definition.yml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get replicaset</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete rs myapp-replicaset</span></span><br><span class="line">or</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete replicaset myapp-replicaset</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl edit rs myapp-replicaset</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete pod [pod_name]</span></span><br></pre></td></tr></table></figure>
<img src="/2024/06/01/Kubernetes/Kubernetes-ReplicationController-vs-ReplicaSet/ReplicaSet_commands.jpg" class="">

<h4 id="Scale"><a href="#Scale" class="headerlink" title="Scale"></a>Scale</h4><p>ğŸ“Œ There are also options available for automatically scaling the ReplicaSet based on load!</p>
<ol>
<li><p>Method 1: Modify the number of <code>replicas</code> in <code>replicaset-definition.yml</code> and run the following command.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl replace -f replicaset-definition.yml</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Method 2: Run scale up&#x2F;down command</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl scale --replicas=6 -f replicaset-definition.yml</span></span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl scale --replicas=6 [<span class="built_in">type</span>] [name]</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl scale --replicas=6 replicaset myapp-replicaset</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/">ReplicationController</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/">ReplicaSet</a></li>
<li><a href="https://hackmd.io/@CynthiaChuang/Kubernetes-for-the-Absolute-Beginners-02">ã€K8S Beginners ç­†è¨˜ã€‘CH 4~6 PODs, YAML, ReplicaSet and Deployments</a></li>
</ul>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>è§€å¿µè§£èªª</tag>
        <tag>Concepts</tag>
        <tag>ReplicationController</tag>
        <tag>ReplicaSet</tag>
      </tags>
  </entry>
</search>
